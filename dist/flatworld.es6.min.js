"use strict";function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _toConsumableArray(e){if(Array.isArray(e)){for(var t=0,n=Array(e.length);t<e.length;t++)n[t]=e[t];return n}return Array.from(e)}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function filterChildren(e){var t=arguments.length<=1||void 0===arguments[1]?[]:arguments[1],n=arguments.length<=2||void 0===arguments[2]?void 0:arguments[2];return t.filter(function(t){if(n&&n!==t.type)return!1;var o=t.hitTest?t.hitTest(e):!0;return o})}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}function _toConsumableArray(e){if(Array.isArray(e)){for(var t=0,n=Array(e.length);t<e.length;t++)n[t]=e[t];return n}return Array.from(e)}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}!function(){window.flatworld_libraries={},window.flatworld_libraries.PIXI=window.PIXI,window.flatworld_libraries.Q=window.Q,window.flatworld_libraries.Hammer=window.Hammer,window.flatworld_libraries.Hamster=window.Hamster,window.flatworld_libraries.Handlebars=window.Handlebars,window.flatworld_libraries.log=window.log,window.flatworld_libraries.Howler=window.Howl,window.flatworld_libraries.EventEmitter=window.EventEmitter,window.flatworld={},window.flatworld.generalUtils={},window.flatworld.log={},window.flatworld.objects={},window.flatworld.extensions={},window.flatworld.mapLayers={},window.flatworld.utils={},window.flatworld.factories={},window.flatworld.UIs={},window.flatworld.UIs["default"]={}}(),function(){var e=window.flatworld_libraries.log;e.enableAll(),window.flatworld.log={debug:function(t,n){e.debug(n,t)},error:function(t,n){e.error(n,t)}}}();var _createClass=function(){function e(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(t,n,o){return n&&e(t.prototype,n),o&&e(t,o),t}}();!function(){var e=window.flatworld_libraries,t=e.Q,n=e.PIXI,o=function(){function e(t){var o=arguments.length<=1||void 0===arguments[1]?{concurrency:15,crossOrigin:!1}:arguments[1];_classCallCheck(this,e);var r=o.concurrency;this.preloaderClass=new n.loaders.Loader(t,r)}return _createClass(e,[{key:"resolveOnComplete",value:function(){var e=t.defer();return this.preloaderClass.load(),this.preloaderClass.once("complete",function(t,n){e.resolve(t,n)}),e.promise}},{key:"addResource",value:function(e){this.preloaderClass.add(e)}},{key:"loadManifest",value:function(){return this}},{key:"setErrorHandler",value:function(e){return this.preloaderClass.on("error",e),this}},{key:"setProgressHandler",value:function(e){return this.preloaderClass.on("error",e),this}},{key:"activateSound",value:function(){this.preloaderClass.installPlugin()}}]),e}();window.flatworld.Preload=o}(),function(){var e=window.flatworld_libraries.PIXI,t={ZERO_COORDINATES:new e.Point(0,0),VERSION:"0.5.0"};window.flatworld.constants=t}(),function(){function e(){function e(){Array.prototype.find||(Array.prototype.find=function(e){if(null===this)throw new TypeError("Array.prototype.find called on null or undefined");if("function"!=typeof e)throw new TypeError("predicate must be a function");for(var t,n=Object(this),o=n.length>>>0,r=arguments[1],i=0;o>i;i++)if(t=n[i],e.call(r,t,i,n))return t})}function t(){"function"!=typeof Object.assign&&!function(){Object.assign=function(e){if(void 0===e||null===e)throw new TypeError("Cannot convert undefined or null to object");for(var t=Object(e),n=1;n<arguments.length;n++){var o=arguments[n];if(void 0!==o&&null!==o)for(var r in o)o.hasOwnProperty(r)&&(t[r]=o[r])}return t}}()}function n(){String.prototype.repeat||!function(){var e=function(){try{var e={},t=Object.defineProperty,n=t(e,e,e)&&t}catch(o){}return n}(),t=function(e){if(null==this)throw TypeError();var t=String(this),n=e?Number(e):0;if(n!=n&&(n=0),0>n||n==1/0)throw RangeError();for(var o="";n;)n%2==1&&(o+=t),n>1&&(t+=t),n>>=1;return o};e?e(String.prototype,"repeat",{value:t,configurable:!0,writable:!0}):String.prototype.repeat=t}()}return{arrayFind:e,objectAssign:t,es6String:n}}window.flatworld.generalUtils.polyfills=e()}(),function(){function e(){function e(e){var t;return(t=[]).concat.apply(t,_toConsumableArray(e))}function t(e,t){for(var n=[],o=0;o<e.length;o+=t)n.push(e.slice(o,t+o));return n}return{flatten2Levels:e,chunkArray:t}}window.flatworld.generalUtils.arrays=e()}(),function(){function e(){function e(){var e=screen.width<=640||window.matchMedia&&window.matchMedia("only screen and (max-width: 640px)").matches,t="ontouchstart"in window||navigator.maxTouchPoints>0||navigator.msMaxTouchPoints>0;return t&&e}return{isMobile:e,isTouchDevice:t}}function t(){return"ontouchstart"in document.documentElement}window.flatworld.generalUtils.environmentDetection=e()}(),function(){function e(){function e(e){return Object.keys(e).map(function(t){return e[t]})}function t(e){var t=[];return t.concat.apply(t,e)}return{mapObjectsToArray:e,flattenArrayBy1Level:t}}window.flatworld.utils.dataManipulation=e()}(),function(){function e(){function e(){arguments.length<=0||void 0===arguments[0]?{color:"#000000",distance:5,alpha:.5,"amgÃ¶e":45,blur:5}:arguments[0]}return{dropShadow:e}}window.flatworld_libraries.PIXI;window.flatworld.utils.effects=e()}(),function(){function e(){function e(e){return 3===e.which}function t(e){e.addEventListener("contextmenu",function(e){e.preventDefault()})}function n(e){return new PIXI.Point(e.offsetX,e.offsetY)}function o(e){return new PIXI.Point(e.center.x,e.center.y)}function r(e,t){var n=i(t);return{x:e.x-n.x,y:e.y-n.y}}function i(e){for(var t=0,n=0;e;){if("body"===e.tagName.toLowerCase()){var o=e.scrollLeft||document.documentElement.scrollLeft,r=e.scrollTop||document.documentElement.scrollTop;t+=e.offsetLeft-o+e.clientLeft,n+=e.offsetTop-r+e.clientTop}else t+=e.offsetLeft-e.scrollLeft+e.clientLeft,n+=e.offsetTop-e.scrollTop+e.clientTop;e=e.offsetParent}return{x:t,y:n}}function a(e){var t={x:0,y:0};return e||(e=window.event),e.pageX||e.pageY?(t.x=e.pageX,t.y=e.pageY):(e.clientX||e.clientY)&&(t.x=e.clientX+document.body.scrollLeft+document.documentElement.scrollLeft,t.y=e.clientY+document.body.scrollTop+document.documentElement.scrollTop),t}return{isRightClick:e,disableContextMenu:t,eventData:{getPointerCoords:n,getHAMMERPointerCoords:o},coordinatesFromGlobalToRelative:r,eventMouseCoords:a}}function t(){function e(){function e(e){var t=e.cancelFullScreen||e.webkitCancelFullScreen||e.mozCancelFullScreen||e.exitFullscreen;if(t)t.call(e);else if("undefined"!=typeof window.ActiveXObject){var n=new ActiveXObject("WScript.Shell");null!==n&&n.SendKeys("{F11}")}}function t(e){var t=e.requestFullScreen||e.webkitRequestFullScreen||e.mozRequestFullScreen||e.msRequestFullScreen;if(t)t.call(e);else if("undefined"!=typeof window.ActiveXObject){var n=new ActiveXObject("WScript.Shell");null!==n&&n.SendKeys("{F11}")}return!1}var n=document.body,o=document.fullScreenElement&&null!==document.fullScreenElement||document.mozFullScreen||document.webkitIsFullScreen;return o?e(document):t(n),!1}function t(e){return function(){var t=n();e.canvas.width=t.x,e.canvas.height=t.y}}function n(){return{x:window.innerWidth,y:window.innerHeight}}function o(e,t){var o=n();e.autoResize=!0,e.resize(o.x,o.y),t()}return{toggleFullScreen:e,setToFullSize:t,getWindowSize:n,resizePIXIRenderer:o}}function n(){function e(e){var t=window.devicePixelRatio||1,n=e&&e.getContext("2d")||document.createElement("canvas").getContext("2d"),o=n.webkitBackingStorePixelRatio||n.mozBackingStorePixelRatio||n.msBackingStorePixelRatio||n.oBackingStorePixelRatio||n.backingStorePixelRatio||1;return t/o}return{getPixelRatio:e}}function o(){function e(e,t){return Math.abs(e)-Math.abs(t)<o}function t(e){e.style.position="absolute",e.style.display="block",e.style.left="0px",e.style.top="0px"}function n(e,t){throw new Error("Function '"+e+"' requires parameter "+t)}var o=.01;return{pixelEpsilonEquality:e,fullsizeCanvasCSS:t,requireParameter:n}}window.flatworld.utils.mouse=e(),window.flatworld.utils.resize=t(),window.flatworld.utils.environmentDetection=n(),window.flatworld.utils.general=o()}(),function(){function e(){var e=new PIXI.Graphics;return e.lineStyle(2,255,1),e.drawRect(50,250,100,100),e}window.flatworld.utils.shapes={createSquare:e}}(),function(){function e(){function e(e,t){return a("get",e,t)}function n(e,t){return a("post",e,t)}function o(e,n,o){s[e]&&t.debug("API endpoint already exists and has been defined "+e+", "+o+", "+JSON.stringify(n)),s[e]={baseUrl:o,cbs:n?[n]:[]}}function r(e){s[e]||t.debug("API endpoint not found for removing!"),delete s[e]}function i(e,n,o){s[e]&&s[e].cbs||t.debug("API endpoint not found for updating!"),s[e].cbs.push(n)}function a(e,n,o){if(!s[n])return void t.error("API endpoint for fetch not found: "+e+"/"+n+", "+(o?o[0]:"no params"));var r=s[n];return s[n].cbs.forEach(function(t){r=t(e,r,o)}),fetch(r.url,{method:e,body:r.body}).then(function(e){return e.json()}).then(function(e){t.debug("parsed json",e)})["catch"](function(e){t.debug("mapAPI http request failed",e)})}function l(){return s}var s={};return{get:e,post:n,add:o,remove:r,update:i,getAllAPIs:l}}var t=window.flatworld.log;window.flatworld.mapAPI=e()}(),function(){function e(){function e(e,t){a.on(e,t),i[e]=0}function n(){var e=arguments.length<=0||void 0===arguments[0]?"":arguments[0],t=arguments[1],n=(new Date).getTime(),o=e.name||e;i[o]+(e.cooldown||r)<n&&(i[o]=n,a.emit(o,t))}function o(e,t,n){var o=void 0;return function(){var r=this,i=arguments,a=function(){o=null,n||e.apply(r,i)},l=n&&!o;clearTimeout(o),o=setTimeout(a,t),l&&e.apply(r,i)}}var r=50,i={},a=new t;return{subscribe:e,publish:n,debounce:o,removeAllListeners:a.removeAllListeners.bind(a)}}var t=window.flatworld_libraries.EventEmitter;window.flatworld.mapEvents=e()}(),function(){function e(){function e(){var e=arguments.length<=0||void 0===arguments[0]?"":arguments[0],t=arguments.length<=1||void 0===arguments[1]?!1:arguments[1];if(!o[e]||!o[e].on)throw new Error("eventlisteners.on needs to have detector set with this event type!");o[e].on(d("Map"+e,t)),n[e]=n[e]||new Set,n[e].add(t)}function i(){var e=arguments.length<=0||void 0===arguments[0]?"":arguments[0],t=arguments.length<=1||void 0===arguments[1]?!1:arguments[1];o[e].off(t),t?n[e]["delete"](t):delete n[e]}function a(){var e,t=arguments.length<=0||void 0===arguments[0]?"":arguments[0],o=arguments.length<=1||void 0===arguments[1]?!1:arguments[1];return e=o?n[t].has(o):!!n[t].size}function l(e,n){t[e]=n}function s(){var e=arguments.length<=0||void 0===arguments[0]?"":arguments[0];return t[e]}function c(){var e=arguments.length<=0||void 0===arguments[0]?"":arguments[0],t=arguments.length<=1||void 0===arguments[1]?function(){}:arguments[1],n=arguments.length<=2||void 0===arguments[2]?function(){}:arguments[2];o[e]={},o[e]={on:t,off:n}}function u(){var e=arguments.length<=0||void 0===arguments[0]?"":arguments[0];n[e].forEach(function(t){o[e].cbOff(t)}),delete n[e],delete o[e]}function d(e,t){return function(){r.publish(e),t.apply(void 0,arguments)}}return{on:e,off:i,isOn:a,setActivityState:l,getActivityState:s,setDetector:c,clearDetector:u}}var t={},n={},o={},r=window.flatworld.mapEvents;window.flatworld.eventListeners=e()}();var _get=function e(t,n,o){null===t&&(t=Function.prototype);var r=Object.getOwnPropertyDescriptor(t,n);if(void 0===r){var i=Object.getPrototypeOf(t);return null===i?void 0:e(i,n,o)}if("value"in r)return r.value;var a=r.get;if(void 0!==a)return a.call(o)},_createClass=function(){function e(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(t,n,o){return n&&e(t.prototype,n),o&&e(t,o),t}}();!function(){function e(e,t){var n,o=t.subcontainersConfig,r=t.subcontainerList,i=Math.floor(e.x/o.width),a=Math.floor(e.y/o.height);return r[i]=r[i]||[],n=r[i][a]=r[i][a]||[],r[i][a].length<=0&&(n=new s({x:i*o.width,y:a*o.height,width:o.width,height:o.height}),r[i][a]=n,n.x=i*o.width,n.y=a*o.height,n.visible=!o.isHiddenByDefault),e.x-=n.x,e.y-=n.y,r[i][a].addChild(e),r[i][a]}function t(e,t){for(var n=e.getSubcontainerConfigs(),o=n.width,r=n.height,i=n.maxDetectionOffset,a={x:t.x>=0?t.x-i:-i,y:t.y>=0?t.y-i:-i,width:(t.width||0)+2*i,height:(t.height||0)+2*i},l=[],s=Math.floor(a.x/o),c=Math.floor(a.y/r),u=a.width?a.x+a.width:+a.x,d=a.height?a.y+a.height:+a.y,f=Math.floor(u/o),h=Math.floor(d/r),w=e.subcontainerList,v=s;f>=v;v++)if(v>=0&&w&&w[v])for(var y=c;h>=y;y++)y>=0&&w[v][y]&&l.push(w[v][y]);return l}function n(e,t){Array.isArray(e)?e.forEach(function(e){t.removeChild(e)}):t.removeChild(e)}var o=window.flatworld_libraries.PIXI,r=window.flatworld.generalUtils,i=[],a=function(e){function t(){var e=arguments.length<=0||void 0===arguments[0]?{}:arguments[0],n=e.name,o=void 0===n?"":n,r=e.coord,i=void 0===r?{x:0,y:0}:r,a=e.specialLayer,l=void 0===a?!1:a,s=e.zoomLayer,c=void 0===s?!0:s,u=e.selectable,d=void 0===u?!1:u;_classCallCheck(this,t);var f=_possibleConstructorReturn(this,Object.getPrototypeOf(t).call(this));return Object.assign(f,i),f.name=""+o,f.specialLayer=!!l,f.zoomLayer=!!c,f.selectable=d,f.UIObjectList={},f}return _inherits(t,e),_createClass(t,[{key:"hasSubcontainers",value:function(){return!!(this.subcontainersConfig&&this.subcontainersConfig.width&&this.subcontainersConfig.height)}},{key:"move",value:function(e){this.x+=e.x,this.y+=e.y}},{key:"setZoom",value:function(e){return this.scale.x=this.scale.y=+e.toFixed(2),this.scale.x}},{key:"getZoom",value:function(){return this.scale.x}},{key:"getUIObjects",value:function(){return i}},{key:"getPrimaryLayers",value:function(){var e=arguments.length<=0||void 0===arguments[0]?{}:arguments[0],t=e.filters;return this.children.filter(function(e){return!(t&&t.doesItFilter("layer")&&!t.filter(e).length||e.specialLayer)})}},{key:"getObjects",value:function(e){throw new Error("Has to be implemented in child class")}},{key:"createUILayer",value:function(){var e=arguments.length<=0||void 0===arguments[0]?"default UI layer":arguments[0],n=arguments.length<=1||void 0===arguments[1]?{x:0,y:0}:arguments[1],o=new t(e,n);return o.specialLayer=!0,this.addChild(o),this.UILayer=o,o}},{key:"getUILayer",value:function(){return this.UILayer}},{key:"addUIObject",value:function(e,t){return i=i||[],this.UIObjectList[t]&&Array.isArray(this.UIObjectList[t])?this.UIObjectList[t].push(e):this.UIObjectList[t]?(this.UIObjectList[t]=[this.UIObjectList[t]],this.UIObjectList[t].push(e)):this.UIObjectList[t]=e,this.getUILayer()||(this.UILayer=this.createUILayer()),this.UILayer.addChild(e),i.push(e),i}},{key:"deleteUIObjects",value:function(e){var t=this,o=this.getUILayer();if(e){var r=this.UIObjectList[e];return n(r,o),void(this.UIObjectList[e]=void 0)}return Object.keys(this.UIObjectList).map(function(e){var r=t.UIObjectList[e];n(r,o),t.UIObjectList[e]=void 0}),i}}]),t}(o.Container),l=function(n){function o(){var e=arguments.length<=0||void 0===arguments[0]?{}:arguments[0],t=(e.name,e.coord,e.subcontainers),n=void 0===t?{width:0,height:0,maxDetectionOffset:100}:t,r=e.specialLayer,i=void 0===r?!1:r,a=(e.zoomLayer,e.selectable),l=void 0===a?!1:a;_classCallCheck(this,o);var s=_possibleConstructorReturn(this,Object.getPrototypeOf(o).call(this,arguments[0]));return s.oldAddChild=_get(Object.getPrototypeOf(o.prototype),"addChild",s).bind(s),s.subcontainersConfig=n,s.subcontainerList=[],s.selectable=l,s.specialLayer=i,s}return _inherits(o,n),_createClass(o,[{key:"addChild",value:function(t){if(this.hasSubcontainers()){var n=e(t,this);this.oldAddChild(n)}else this.oldAddChild(t);return t}},{key:"getObjects",value:function(e){var t=[],n=e&&e.doesItFilter("object"),o=void 0;return this.getSubcontainers().forEach(function(r){o=n?r.children.filter(function(t){return!!e.filter(t).length}):r.children,t.push(o)}),r.arrays.flatten2Levels(t)}},{key:"getSubcontainerConfigs",value:function(){return this.subcontainersConfig}},{key:"getSubcontainersByCoordinates",value:function(e){if(!this.hasSubcontainers())throw new Error("tried to retrieve subcontainers, when they are not present");var n;return n=t(this,e)}},{key:"getSubcontainers",value:function(){return r.arrays.flatten2Levels(this.subcontainerList)}}]),o}(a),s=function(e){function t(e){_classCallCheck(this,t);var n=_possibleConstructorReturn(this,Object.getPrototypeOf(t).call(this));return n.specialLayer=!0,n.size=e,n.selectable=!1,n}return _inherits(t,e),_createClass(t,[{key:"getSubcontainerArea",value:function(){var e,t=arguments.length<=0||void 0===arguments[0]?{toGlobal:!0}:arguments[0];return e=t.toGlobal?this.toGlobal(new o.Point(0,0)):this,{x:Math.round(e.x),y:Math.round(e.y),width:Math.round(this.size.width),height:Math.round(this.size.height)}}}]),t}(o.Container),c=function(e){function t(e){_classCallCheck(this,t);var n=_possibleConstructorReturn(this,Object.getPrototypeOf(t).call(this));return n.specialLayer=!0,n.targetSize=e,n.selectable=!1,n}return _inherits(t,e),t}(o.Container);window.flatworld.mapLayers=window.flatworld.mapLayers||{},window.flatworld.mapLayers.MapLayer=a,window.flatworld.mapLayers.MapLayerParent=l,window.flatworld.mapLayers.MinimapLayer=c}();var _createClass=function(){function e(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(t,n,o){return n&&e(t.prototype,n),o&&e(t,o),t}}();!function(){var e=window.flatworld.mapLayers,t=window.flatworld.objects,n=window.flatworld.utils,o=function(){function o(){var r=arguments.length<=0||void 0===arguments[0]?n.general.requireParameter("MapDataManipulator","rules"):arguments[0];_classCallCheck(this,o),this.rules=Array.isArray(r)?r:[r],this.classes={layer:Object.keys(e).map(function(t){return e[t]}),object:Object.keys(t).map(function(e){return t[e]})}}return _createClass(o,[{key:"filter",value:function(e){var t,n=this;return t=Array.isArray(e)?e.filter(function(e){return n._runRule(e)}):this._runRule(e)?[e]:[]}},{key:"addRule",value:function(e){this.rules.concat(e)}},{key:"getOnlyFiltersOf",value:function(){}},{key:"doesItFilter",value:function(e){return this.rules.some(function(t){return t.object===e})}},{key:"_runRule",value:function(e){var t,n=this,o=!0;return Object.keys(this.classes).forEach(function(o){var r=n.classes[o].filter(function(t){return e instanceof t});t=r.length?o:t}),this.rules.forEach(function(r){if("filter"===r.type){if(r.object!==t)return;"layer"===t?o=n._getObject(e,r):"object"===t&&(o=n._getObject(e,r))}}),o}},{key:"_getObject",value:function(e,t){var n=!1;if(Array.isArray(t.property))try{n=""+o.getPropertyWithArray(e,t.property,0)==""+t.value}catch(r){return!1}else n=e[t.property]===t.value;return n}}],[{key:"getPropertyWithArray",value:function(e,t,n){var r=t[n],i=e[r];return t[n+1]?o.getPropertyWithArray(i,t,++n):i}}]),o}();o.OBJECT_LAYER="layer",o.OBJECT_OBJECT="object",window.flatworld.MapDataManipulator=o}(),function(){function e(e,o){var r;if(t)return t;if(!e||!o)throw new Error("UI-module requires UITheme and map object, This is an singletong class, so it's possible it should have been already called earlier");return r=o,t={},t.showSelections=function(t,n){var o=arguments.length<=2||void 0===arguments[2]?{}:arguments[2],r=o.filters,i=o.UIThemeOptions;return r&&(t=r.filterObjects(t)),t=Array.isArray(t)?t:[t],1===t.length?e.highlightSelectedObject(t[0],n,i):t.length>1?e.showSelections(t,n,i):e.showSelections([])},t.showUnitMovement=function(t){var o=arguments.length<=1||void 0===arguments[1]?{}:arguments[1],r=o.UIThemeOptions;return Array.isArray(t)||n.error("Array expected for showUnitMovement"),e.showUnitMovement(t,r)},t.extend=function(n){t[n]=function(){e[n]()}},t}var t,n=window.flatworld.log;window.flatworld.UI=e}();var _createClass=function(){function e(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(t,n,o){return n&&e(t.prototype,n),o&&e(t,o),t}}();!function(){var e=function(){function e(){_classCallCheck(this,e)}return _createClass(e,[{key:"retrieve",value:function(e){var t=arguments.length<=1||void 0===arguments[1]?[]:arguments[1],n=arguments.length<=2||void 0===arguments[2]?{type:void 0,size:{width:0,height:0}}:arguments[2],o=n.size,r=n.type,i=e.globalCoords,a=[];return t.length>0?(t.forEach(function(e){a=a.concat(e.children)}),o.width&&o.height||(a=filterChildren(i,a,r)),a):[]}}]),e}();window.flatworld.ObjectManager=e}();var _createClass=function(){function e(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(t,n,o){return n&&e(t.prototype,n),o&&e(t,o),t}}();!function(){function e(e){e.center=null,e.map=null}var t=window.flatworld_libraries.PIXI,n=window.flatworld,o=n.constants,r=n.utils,i=n.mapAPI,a=n.mapEvents,l=function(n){function r(t){var n=arguments.length<=1||void 0===arguments[1]?{x:0,y:0}:arguments[1],o=arguments.length<=2||void 0===arguments[2]?{}:arguments[2],i=o.data,a=void 0===i?null:i;_classCallCheck(this,r);var l=_possibleConstructorReturn(this,Object.getPrototypeOf(r).call(this,t)),s={x:Math.round(n.x),y:Math.round(n.y)};return l.position.set(s.x,s.y),l.name="Objects_sprite_"+l.id,l.type="None",l.highlightable=!0,l.data=a,l.areaWidth=l.width,l.areaHeight=l.height,l["static"]=!0,l.minimapColor=16711680,l.coordinates={},e(l.coordinates),l}return _inherits(r,n),_createClass(r,[{key:"innerDraw",value:function(e,t){return this.fromFrame(this.currentFrame),this.x=e,this.y=t,this}},{key:"drawNewFrame",value:function(e,t,n){return this.currentFrame=n,this.innerDraw(e,t)}},{key:"getGraphicalArea",value:function(){var e,n=arguments.length<=0||void 0===arguments[0]?{toGlobal:!0}:arguments[0];return e=n.toGlobal?this.toGlobal(new t.Point(0,0)):this,{x:Math.round(e.x),y:Math.round(e.y),width:Math.round(this.width),height:Math.round(this.height)}}},{key:"clone",value:function(e){var n=arguments.length<=1||void 0===arguments[1]?{position:!1,anchor:!1,scale:!1}:arguments[1],o=new t.Sprite;return o.texture=e.generateTexture(this),n.anchor&&o.anchor.set(this.anchor.x,this.anchor.y),n.position&&o.position.set(this.x,this.y),n.scale&&o.scale.set(this.scale.x,this.scale.y),Reflect.setPrototypeOf(o,this.constructor.prototype),o}},{key:"initializeCoordinates",value:function(t){e(this.coordinates),this.getMapCoordinates(t),this.getCenterCoordinates()}},{key:"getGlobalCoordinates",value:function(e){return this.toGlobal(e||o.ZERO_COORDINATES)}},{key:"getMapCoordinates",value:function(e){return this.coordinates.map=this.coordinates.map||e.getMapCoordinates(this),Object.assign({},this.coordinates.map)}},{key:"getCenterCoordinates",value:function(){return this.coordinates.center||(this.coordinates.center={x:this.width/2,y:this.height/2}),this.coordinates.center}}]),r}(t.Sprite),s=function(e){function t(e,n){var o=arguments.length<=2||void 0===arguments[2]?{}:arguments[2],r=o.data,i=void 0===r?null:r;_classCallCheck(this,t);var a=_possibleConstructorReturn(this,Object.getPrototypeOf(t).call(this,e,n,{data:i}));return a.name="DefaultTerrainObject",a.type="terrain",a.highlightable=!1,a}return _inherits(t,e),t}(l),c=function(e){function t(e,n){var o=arguments.length<=2||void 0===arguments[2]?{}:arguments[2],r=o.data,i=void 0===r?null:r;_classCallCheck(this,t);var a=_possibleConstructorReturn(this,Object.getPrototypeOf(t).call(this,e,n,{data:i}));return a.name="DefaultUnitObjects",a.type="unit",a.actions={},a}return _inherits(t,e),_createClass(t,[{key:"doAction",value:function(e){this.actions[e].forEach(function(e){e()})}},{key:"addActionType",value:function(e){this.actions[e]=this.actions[e]||[]}},{key:"addCallbackToAction",value:function(e,t){this.actions[e].push(t)}},{key:"dropShadow",value:function(){var e;return(e=r.effects).dropShadow.apply(e,arguments)}},{key:"move",value:function(e){a.publish("objectMove",this),i.post("objectMove",{id:this.id,from:{x:this.x,y:this.y},to:e})}}]),t}(l);window.flatworld.objects.ObjectSprite=l,window.flatworld.objects.ObjectSpriteTerrain=s,window.flatworld.objects.ObjectSpriteUnit=c}();var _createClass=function(){function e(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(t,n,o){return n&&e(t.prototype,n),o&&e(t,o),t}}();!function(){var e=window.flatworld_libraries.Q,t=window.flatworld_libraries.Howler,n=(window.flatworld.mapLayers,function(){function n(){_classCallCheck(this,n),this._allSounds={}}return _createClass(n,[{key:"add",value:function(e,n){var o=arguments.length<=2||void 0===arguments[2]?{loop:!1,volume:1}:arguments[2],r=o.loop,i=o.volume;return this._allSounds[e]={},this._allSounds[e]=new t({urls:[n],autoplay:!1,loop:r,volume:i}),this._allSounds[e]}},{key:"remove",value:function(e){delete this._allSounds[e]}},{key:"play",value:function(t){var n=e.defer();this._allSounds[t]._onend=function(){n.resolve(!0)},this._allSounds[t].play()}},{key:"stop",value:function(e){this._allSounds[e].stop()}},{key:"fade",value:function(t,n,o,r){var i,a=e.defer();return i=function(){a.resolve(!0)},this._allSounds[t].fade(n,o,r,i),a.promise}}]),n}());window.flatworld.Sound=n}(),function(){function e(){return t.create({initial:"statusQuo",events:[{name:"objectSelectDialog",from:["statusQuo","objectSelected"],to:"objectSelectDialogOpened"},{name:"objectSelect",from:["statusQuo","objectSelected","objectSelectDialogOpened"],to:"objectSelected"},{name:"normalize",from:["objectSelected","objectSelectDialogOpened"],to:"statusQuo"},{name:"objectOrder",from:"objectSelected",to:"animatingObject"},{name:"objectOrderEnd",from:"animatingObject",to:"objectSelected"},{name:"UIOpen",from:["statusQuo","objectSelected","objectSelectDialogOpened"],to:"mainUIOpened"},{name:"UIClose",from:"mainUIOpened",to:"statusQuo"}]})}var t=window.StateMachine;window.flatworld.mapStates=e()}(),function(){function e(){function e(e){var n=f(),o=d();g=e,y=new l.Manager(e.canvas),p=new s(e.canvas),i.setDetector("fullSize",t().on,t().off),i.on("fullSize",v),i.setDetector("fullscreen",a().on,a().off),e.setPrototype("setFullScreen",function(){i.on("fullscreen",w)}),i.setDetector("zoom",c().on,c().off),i.setDetector("drag",u().on,u().off),i.setDetector("select",o.on,o.off),i.setDetector("order",n.on,n.off)}function t(){var e;return m.fullsize||(m.fullsize={on:function(t){e=t,window.addEventListener("resize",e)},off:function(){window.removeEventListener("resize",e)}}),m.fullsize}function a(){var e;return m.fullscreen?m.fullscreen:(m.fullscreen={on:function(t){e=t,window.addEventListener("fullscreen",e)},off:function(){window.removeEventListener("fullscreen",e)}},m.fullscreen)}function c(){var e;return m.zoom||(m.zoom={on:function(t){var n=new l.Pinch;e=t,y.add(n),y.on("pinch",e),p.wheel(e)},off:function(){y.on("pinch",e),p.unwheel(e)}}),m.zoom}function u(){var e;return m.drag||(m.drag={on:function(t){var n=new l.Pan({pointers:1,threshold:5,direction:l.DIRECTION_ALL});e=t,y.add(n),y.on("pan",e)},off:function(){y.off("pan",e)}}),m.drag}function d(){var e;return m.select||(m.select={on:function(t){var n=new l.Tap;e=t,y.add(n),y.on("tap",e)},off:function(){y.off("tap",e)}}),m.select}function f(){function e(e){return o.mouse.isRightClick(e)||"press"===e.type?r.can("objectOrder")||!g.isSupportedTouch&&!o.mouse.isRightClick(e)?void t(e):!1:void 0}var t;return m.order||(m.order={on:function(n){t=n;var o=new l.Press;y.add(o),y.on("press",e),g.canvas.addEventListener("mouseup",function(t){3===t.which&&e(t)},!0)},off:function(){y.off("press",e),g.canvas.removeEventListener("mouseup",e,!0)}}),m.order}function h(){var e=document.getElementsByTagName("body")[0].style;e.webkitTouchCallout="none",e.webkitUserSelect="none",e.khtmlUserSelect="none",e.mozUserSelect="none",e.msUserSelect="none",e.userSelect="none"}function w(){o.resize.toggleFullScreen(),n.publish("mapResized"),v()}function v(){o.resize.resizePIXIRenderer(g.getRenderer(),g.drawOnNextTick.bind(g)),n.publish("mapResized")}var y,p,g,m={};return{init:e,toggleFullSize:t,toggleFullscreen:a,toggleZoom:c,toggleDrag:u,toggleSelect:d,toggleOrder:f,toggleMouseTextSelection:h,pluginName:"baseEventlisteners"}}var t=window.flatworld,n=t.mapEvents,o=t.utils,r=t.mapStates,i=t.eventListeners,a=window.flatworld_libraries,l=a.Hammer,s=a.Hamster;window.flatworld.extensions.baseEventlisteners=e()}(),function(){function e(){function e(e){a=o(e),t.on("drag",a)}function o(e){var o=!1;return function(i){var a;return t.getActivityState("zoom")?!1:(a=n.mouse.eventData.getHAMMERPointerCoords(i),s=!0,a.x=Math.round(a.x),a.y=Math.round(a.y),o?(i.isFinal===!0&&(o=!1,s=!1),void r(i,e,a)):(l.setOffset({x:a.x,y:a.y}),void(o=!0)))}}function r(e,t,n){var o,r;o=l.getOffset(),r={x:n.x-o.x,y:n.y-o.y},(r.x>0||r.y>0||r.x<0||r.y<0)&&t.moveMap(r),e.isFinal&&(s=!1),l.setOffset({x:n.x,y:n.y}),e.preventDefault()}function i(){function e(e){return n=e}function t(){return n}var n;return{setOffset:e,getOffset:t}}var a,l=i(),s=!1;return{init:e,pluginName:"mapDrag",_startDragListener:o}}var t=window.flatworld.eventListeners,n=window.flatworld.utils;window.flatworld.mapStates,window.flatworld.log;window.flatworld.extensions.mapDrag=e()}(),function(){function e(){function e(e){w=e,w.setPrototype("zoomIn",a),w.setPrototype("zoomOut",l),w.setPrototype("setZoomLimits",i),w.setPrototype("setZoomModifier",r),t.on("zoom",s)}function r(e){if(!(e>0||.5>=e))throw new Error("Wrong zoom modifier! (needs to be >0 and <=0.5, given:"+e);return b=e,this}function i(e,t){
return m.farther=e,m.closer=t,this}function a(e){var t=this.getZoom(),n=!0;return h(this,t,Math.abs(e)||b,n)}function l(e){var t=this.getZoom(),n=!1;return e=0>e?e:-e,h(this,t,e||-b,n)}function s(e,t,n,o){t?c(e,t,n,o):e.pointers&&(p||(p=!0,r(.5*b)),u(e))}function c(e,t,n,o){var r=o,i=w.getZoom();e.preventDefault(),r>0?w.zoomIn()&&w.moveMap(f(i,!0)):0>r&&w.zoomOut()&&w.moveMap(f(i))}function u(e){var n=e.pointers,r=[{x:n[0].pageX,y:n[0].pageY},{x:n[1].pageX,y:n[1].pageY}],i=Math.abs(r[0].x-r[1].x),a=Math.abs(r[0].y-r[1].y);e.preventDefault();try{if(!y)return g={x:i,y:a},t.setActivityState("zoom",!0),void(y=!0);4!==e.eventType&&8!==e.eventType||(window.setTimeout(function(){t.setActivityState("zoom",!1)},v),y=!1),g.x+g.y<i+a?w.zoomIn()&&w.moveMap(f(w.getZoom(),!0)):w.zoomOut()&&w.moveMap(f(w.getZoom())),g={x:i,y:a}}catch(l){o("Error! ",l)}}function d(e,t){return!!(t&&e>m.closer||!t&&e<m.farther)}function f(e,t){var o=n.resize.getWindowSize(),r={x:o.x/2/e,y:o.y/2/e},i={x:r.x*(t?-b:b),y:r.y*(t?-b:b)};return i}function h(e,t,n,o){var r;return d(t,o)||(r=e.setZoom(n?t+n:t+b)),r}var w,v=40,y=!1,p=!1,g={},m={farther:.4,closer:2.5},b=.1;return{init:e,pluginName:"mapZoom"}}var t=window.flatworld.eventListeners,n=window.flatworld.utils,o=window.flatworld.log;window.flatworld.extensions.mapZoom=e()}(),window.flatworld.extensions.hexagons={},window.flatworld.extensions.hexagons.utils={},window.flatworld.extensions.hexagons.eventlisteners={},window.flatworld.extensions.hexagons.pathfinding={},window.flatworld.extensions.hexagons._tests={},function(){function e(e){var t=arguments.length<=1||void 0===arguments[1]?{x:0,y:0}:arguments[1],n=arguments.length<=2||void 0===arguments[2]?{}:arguments[2],o=n.orientation,r=void 0===o?"horizontal":o;e||u.error("You need to pass radius as a parameter"),d=e,f=t,h=r}function t(){var e=arguments.length<=0||void 0===arguments[0]?{}:arguments[0],t=e.radius,n=void 0===t?d:t,o=e.orientation,r=void 0===o?"horizontal":o;n||u.error("You need to define at least globalRadius for the hexagonMath utils class");for(var i="horizontal"===r?.5:0,a={x:n,y:n},l=2*Math.PI/6*i,s=a.x*Math.cos(l),c=a.y*Math.sin(l),f=[{x:s,y:c}],h=1;7>h;h++)l=2*Math.PI/6*(h+i),s=a.x*Math.cos(l),c=a.y*Math.sin(l),f.push({x:s,y:c});return f}function n(){var e=arguments.length<=0||void 0===arguments[0]?{}:arguments[0],t=e.radius,n=void 0===t?d:t,o=e.floorNumbers,r=void 0===o?!0:o,i=n*Math.sqrt(3);return i=r?Math.floor(i):i}function o(){var e=arguments.length<=0||void 0===arguments[0]?{}:arguments[0],t=e.radius,n=void 0===t?d:t,o=e.floorNumbers,r=void 0===o?!0:o,i=2*n;return i=r?Math.floor(i):i}function r(){var e=arguments.length<=0||void 0===arguments[0]?{}:arguments[0],t=e.radius,n=void 0===t?d:t;return o(n)-n/2}function i(e,t){var n=arguments.length<=2||void 0===arguments[2]?{x:0,y:0}:arguments[2],o=e.map(function(e){return{x:e.x+n.x,y:e.y+n.y}});return c(t,o)}function a(e){for(var t=arguments.length<=1||void 0===arguments[1]?{}:arguments[1],r=t.radius,i=void 0===r?d:r,a=t.orientation,l=void 0===a?"horizontal":a,s=e.rows,c=e.columns,u=[],f=n(i),h=o(i)-i/2,w="horizontal"===l?h:f,v="horizontal"===l?f:h,y=0;s>y;y++)for(var p=0;c>p;p++)u.push({x:Math.round(p*v+("horizontal"!==l||0!==y&&y%2!==0?-f/2:0)),y:y*w});return u}function l(e){if(!h||!f)throw new Error("coordinatesToIndexes requirements not filled");var t={x:Math.floor((e.x-f.x)/n()),y:Math.floor((e.y-f.y)/r())};return"horizontal"===h&&t.y%2===1?t.x+=1:"vertical"===h&&t.x%2===1&&(t.y+=1),t}function s(e){if(!h||!f)throw new Error("indexesToCoordinates requirements not filled");var t=0,o=0;return"horizontal"===h&&e.y%2===1?t=n()+n()/2:"vertical"===h&&e.x%2===0&&(o=n()+n()/2),{x:Math.floor(e.x*n()-t+f.x),y:Math.floor(e.y*r()-o+f.y)}}function c(e,t){for(var n=e.x,o=e.y,r=!1,i=void 0,a=void 0,l=void 0,s=void 0,c=void 0,u=0,d=t.length-1;u<t.length;d=u++)i=t[u].x,l=t[u].y,a=t[d].x,s=t[d].y,c=l>o!=s>o&&(a-i)*(o-l)/(s-l)+i>n,c&&(r=!r);return r}var u=window.flatworld.log;window.flatworld.extensions.hexagons.utils.init=e,window.flatworld.extensions.hexagons.utils.createHexagonGridCoordinates=a,window.flatworld.extensions.hexagons.utils.getHexagonPoints=t,window.flatworld.extensions.hexagons.utils.calcShortDiagonal=n,window.flatworld.extensions.hexagons.utils.calcLongDiagonal=o,window.flatworld.extensions.hexagons.utils.calcSpecialDistance=r,window.flatworld.extensions.hexagons.utils.hexaHitTest=i,window.flatworld.extensions.hexagons.utils.coordinatesToIndexes=l,window.flatworld.extensions.hexagons.utils.indexesToCoordinates=s;var d,f,h}(),function(){function e(e){var t=arguments.length<=1||void 0===arguments[1]?{}:arguments[1],r=t.orientation,i=void 0===r?"horizontal":r,a=[];if("horizontal"!==i)throw new Error("Nothing else than horizontal supported so far!");return a=n(e),new o.Polygon(a)}function t(e){var t=arguments.length<=1||void 0===arguments[1]?{}:arguments[1],r=t.color,i=void 0===r?16711680:r,a=t.isFlatTop,l=void 0===a?!1:a,s=new o.Graphics,c=n(e,l);return s.beginFill(i,1),s.drawPolygon(c,l),s.endFill(),s}function n(e){return r({radius:e}).map(function(e){return new o.Point(e.x,e.y)})}var o=window.flatworld_libraries.PIXI,r=window.flatworld.extensions.hexagons.utils.getHexagonPoints;window.flatworld.extensions.hexagons.utils.createHexagon=e,window.flatworld.extensions.hexagons.utils.createVisibleHexagon=t}(),function(){function e(e){if(!e)throw new Error("eventlisteners initialization requires flatworld instance as a parameter");return y=e,p=s(),u.on("select",n),u.on("order",o),g=function(e,t,n){return e&&e.mountain||n.len>t.data.typeData.move},m=function(){return 1},!0}function t(e,t){g=e,m=t}function n(e){var t,n=a.mouse.eventData.getHAMMERPointerCoords(e),o={allData:function(e){return e.data.typeData}};return d.objectSelect(),t=y.getObjectsUnderArea(n,{filters:w}),t=a.dataManipulation.mapObjectsToArray(t),t=a.dataManipulation.flattenArrayBy1Level(t),t.length?(y.currentlySelectedObjects=t,l.publish("objectsSelected",t),p.showSelections(t,o),void y.drawOnNextTick()):(y.currentlySelectedObjects=void 0,f.debug("No objects found for selection!"),void p.showSelections([]))}function o(e){var t,n=void 0,o=void 0;if(!y.currentlySelectedObjects)return void f.debug("No objects selected for orders! "+JSON.stringify(o));if(y.currentlySelectedObjects.length>1)return void f.debug("the selected object is only supported to be one atm."+JSON.stringify(y.currentlySelectedObjects));o=y.currentlySelectedObjects[0],t=o.getMapCoordinates(),t.x+=o.getCenterCoordinates().x,t.y+=o.getCenterCoordinates().y,d.objectOrder(),n=y.isSupportedTouch?a.mouse.eventData.getHAMMERPointerCoords(e):a.mouse.eventData.getPointerCoords(e);var i=y.getObjectsUnderArea(n,{filters:v});if(!i.length)return f.error("No terrain objects found for destination!"),void d.objectOrderEnd();var s=h.utils.coordinatesToIndexes(t),c={x:i[0].getMapCoordinates().x+i[0].getCenterCoordinates().x,y:i[0].getMapCoordinates().y+i[0].getCenterCoordinates().y},u=h.utils.coordinatesToIndexes(c),w=void 0;try{w=h.pathfinding.findPath(s,u,100,r,m)}catch(e){return"destination must not be blocked!"===e.message&&f.debug("path finding destination is blocked. There should be a notification in the UI of this."),f.error("same path, dest blocked or such"),void d.objectOrderEnd()}w=w.map(function(e){return h.utils.indexesToCoordinates(e)}),o.move(n),l.publish("objectMoves",o),p.showUnitMovement(w),d.objectOrderEnd(),y.drawOnNextTick()}function r(e){var t=y.hexagonIndexes[e.x]&&y.hexagonIndexes[e.x][e.y],n=g(t,y.currentlySelectedObjects[0],e);return!t||n}var i=window.flatworld,a=i.utils,l=i.mapEvents,s=i.UI,c=i.MapDataManipulator,u=i.eventListeners,d=i.mapStates,f=i.log,h=window.flatworld.extensions.hexagons;window.flatworld.extensions.hexagons.setupHexagonClick=e,window.flatworld.extensions.hexagons.activate=t,window.flatworld.extensions.hexagons._tests._isBlocked=r,window.flatworld.extensions.hexagons._tests._orderListener=o,window.flatworld.extensions.hexagons._tests._tapListener=n;var w=new c({type:"filter",object:"layer",property:"name",value:"unitLayer"}),v=new c({type:"filter",object:"layer",property:"name",value:"terrainLayer"}),y=void 0,p=void 0,g=void 0,m=void 0}();var _slicedToArray=function(){function e(e,t){var n=[],o=!0,r=!1,i=void 0;try{for(var a,l=e[Symbol.iterator]();!(o=(a=l.next()).done)&&(n.push(a.value),!t||n.length!==t);o=!0);}catch(s){r=!0,i=s}finally{try{!o&&l["return"]&&l["return"]()}finally{if(r)throw i}}return n}return function(t,n){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return e(t,n);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),_createClass=function(){function e(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(t,n,o){return n&&e(t.prototype,n),o&&e(t,o),t}}();!function(){function e(e,t,n){function o(t){var o=(t.x-e.x)*(n+1)+(t.y-e.y);return a[o]||!(a[o]=!0)}function i(){[e.x,e.y,n].forEach(function(e,t){if(!r(e))throw new Error("argument #"+t+" must be an integer: "+e)})}i();for(var a=[!0],s=[e],c=0;c<s.length;c++)for(var u=s[c],d=l.length;d-- >0;){var f={x:u.x+l[d].x,y:u.y+l[d].y};t(f)||o(f)||s.push(f)}return s}function t(e,t,o,u){function d(){function e(e){var n=(e.x-h)*(g+1)+(e.y-w);return n in t?t[n]<=e.distance||(t[n]=e.distance,!1):(t[n]=e.distance,!1)}var t=[0],n=i(v-h,y-w,b),d=new c;d.push({x:h,y:w,distance:0,prev:null},0);for(var f=null,m=o;d.length;){var x=d.pop(),C=m-x.distance,S=C>0?i(v-x.x,y-x.y,b):1;if(!(S>C))for(var O=b?l:s,M=O.length;M-- >0;){var k=x.x+O[M].x,j=x.y+O[M].y,T={x:k,y:j};if(a&&g<Math.abs(j-w))throw new Error("maxYCoordDiff "+g+' less than distance by "y" to ('+k+", "+j+") from ("+h+", "+w+")");if(!u(T)){var L=p(x,T);if(a&&(!r(L)||1>L))throw new Error("weight returned not positive integer for ("+x.x+", "+x.y+"), ("+k+", "+j+"): "+L);if(T.distance=x.distance+L,T.prev=x,k===v&&j===y){f=T,m=T.distance-1;break}if(!e(T)){var _=T.distance+i(v-k,y-j,b),I=_-n;d.push(T,I)}}}}return f}function f(){if([h,w,v,y,o,g].forEach(function(e,t){if(!r(e))throw new Error("argument #"+t+" must be an integer: "+e)}),1>o)throw new Error("maxAllowedDistance must be at least 1: "+o);if(h===v&&w===y)throw new Error("starting and destination points must be different: "+h+", "+w);if(u({x:v,y:y}))throw new Error("destination must not be blocked: "+v+", "+y)}var h=e.x,w=e.y,v=t.x,y=t.y,p=arguments.length<=4||void 0===arguments[4]?function(){return 1}:arguments[4],g=arguments.length<=5||void 0===arguments[5]?Math.ceil(Math.sqrt(o)):arguments[5],m=arguments.length<=6||void 0===arguments[6]?null:arguments[6];f();var b=null===m,x=d(),C=x&&n(x);return C}function n(e){var t=e,n=[];do n.push({x:t.x,y:t.y});while(t=t.prev);return n.reverse()}function o(e,t,n){var r=Math.floor((t+n)/2),i=e(r);return 0>i?r>t?o(e,t,r):[t,!1]:i>0?n>r+1?o(e,r+1,n):[n,!1]:[r,!0]}function r(e){return e===Math.floor(e)&&isFinite(e)}function i(e,t,n){return n?e>0&&t>0?e+t:0>e&&0>t?-e-t:Math.max(Math.abs(e),Math.abs(t)):Math.abs(e)+Math.abs(t)}var a=(window.flatworld.log,!0),l=[{x:0,y:1},{x:-1,y:1},{x:1,y:0},{x:1,y:-1},{x:-1,y:0},{x:0,y:-1}],s=[{x:0,y:1},{x:1,y:0},{x:-1,y:0},{x:0,y:-1}],c=function(){function e(){_classCallCheck(this,e),this.items=[]}return _createClass(e,[{key:"pop",value:function(){var e=this.items[this.items.length-1].stack,t=e.pop();return e.length||this.items.pop(),t}},{key:"push",value:function(e,t){var n=this,r=this.items.length?o(function(e){return n.items[e].loss-t},0,this.items.length):[0,!1],i=_slicedToArray(r,2),a=i[0],l=i[1];if(l)this.items[a].stack.push(e);else{var s={stack:[e],loss:t};this.items.splice(a,0,s)}}},{key:"length",get:function(){return this.items.length}}]),e}();window.flatworld.extensions.hexagons.pathfinding.findPath=t,window.flatworld.extensions.hexagons.pathfinding.findAll=e}();var _createClass=function(){function e(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(t,n,o){return n&&e(t.prototype,n),o&&e(t,o),t}}();!function(){function e(e){if(!e)throw new Error("Need radius!");var n=Math.round(l(e)),o=Math.round(s(e)),r=Math.round(e);this.anchor.set(.5,.5),this.areaHeight=this.HEIGHT=n,this.areaWidth=this.WIDTH=o,this.SIDE=r,this.ROW_HEIGHT=Math.round(.75*n),this.hitArea=t(e),this.hitTest=function(e){var t;return t=this.toLocal(new u.Point(e.x,e.y)),this.hitArea.contains(t.x*this.scale.x,t.y*this.scale.y)}}function t(e){return n||(n=c(e)),n}var n,o=window.flatworld.objects,r=o.ObjectSpriteTerrain,i=o.ObjectSpriteUnit,a=window.flatworld.extensions.hexagons.utils,l=a.calcLongDiagonal,s=a.calcShortDiagonal,c=a.createHexagon,u=window.flatworld_libraries.PIXI,d=function(t){function n(t){var o=arguments.length<=1||void 0===arguments[1]?{x:0,y:0}:arguments[1],r=arguments.length<=2||void 0===arguments[2]?{}:arguments[2],i=r.data,a=r.radius,l=r.minimapColor,s=r.minimapShape;_classCallCheck(this,n);var c=_possibleConstructorReturn(this,Object.getPrototypeOf(n).call(this,t,o,{data:i}));return c.name="DefaultTerrainObject_hexa",c.minimapColor=l,c.minimapShape=s,e.call(c,a),c}return _inherits(n,t),_createClass(n,[{key:"getCenterCoordinates",value:function(){return this.coordinates.center||(this.coordinates.center={x:this.WIDTH/2,y:this.HEIGHT/2}),this.coordinates.center}}]),n}(r),f=function(t){function n(t){var o=arguments.length<=1||void 0===arguments[1]?{x:0,y:0}:arguments[1],r=arguments.length<=2||void 0===arguments[2]?{}:arguments[2],i=r.data,a=r.radius,l=r.minimapColor,s=r.minimapShape;_classCallCheck(this,n);var c=_possibleConstructorReturn(this,Object.getPrototypeOf(n).call(this,t,o,{data:i}));return c.name="DefaultUnitObjects_hexa",c.minimapColor=l,c.minimapShape=s,c["static"]=!1,e.call(c,a),c}return _inherits(n,t),_createClass(n,[{key:"getCenterCoordinates",value:function(){return this.coordinates.center||(this.coordinates.center={x:this.WIDTH/2,y:this.HEIGHT/2}),this.coordinates.center}}]),n}(i);window.flatworld.extensions.hexagons.objects={ObjectHexaTerrain:d,ObjectHexaUnit:f}}(),function(){function e(){function e(e){r=e,r.hexagonIndexes=t(r.getMovableLayer(),r.allMapObjects.terrainLayer),n(r)}function n(e){return o(e)}var r={};return{init:e,pluginName:"selectHexagonObject"}}function t(e,t){var n={},o=void 0;return t.forEach(function(e){var t=e.getMapCoordinates();t.x+=e.getCenterCoordinates().x,t.y+=e.getCenterCoordinates().y,o=r.coordinatesToIndexes(t),n[o.x]=n[o.x]||{},n[o.x][o.y]=e}),n}var n=window.flatworld.extensions.hexagons,o=n.setupHexagonClick,r=n.utils;window.flatworld.extensions.hexagons.selectHexagonObject=e(),window.flatworld.extensions.hexagons._tests.createHexagonDataStructure=t}(),function(){function e(){function e(e){m=e,o(),i(),m.drawOnNextTick(),g&&(window.FlaTWorld_mapMovement_subCheck=function(){m.getPrimaryLayers().forEach(function(e){var t,n,o=e.getSubcontainers();t=o.filter(function(e){return e.visible}),n=o.filter(function(e){return!e.visible});var r=t.reduce(function(e,t){e+t.x+""});window.flatworld.log.debug("visible subcontainers: "+t.length+", "+r+"\n\ninvisible: "+n.length)})},window.FlaTWorld_mapMovement_deactivate=function(){m.getPrimaryLayers().forEach(function(e){var t=e.getSubcontainers();t.forEach(function(e){e.visible=!1})})})}function o(){b=m.getViewportArea(!0,2),x=f(b,{zoom:m.getZoom()}),m.getPrimaryLayers().forEach(function(e){var t=e.getSubcontainers();t.forEach(function(e){e.visible=!a(e,b)})})}function r(){function e(){s(!0,w),l(b,m.getPrimaryLayers())}return p.processing?!1:(p.processing=!0,void window.setTimeout(e(),v))}function i(){function e(){r()}function n(){x=f(b,{zoom:m.getZoom()}),r()}function o(){x=f(b,{zoom:m.getZoom()}),r()}t.subscribe("mapMoved",e),t.subscribe("mapResized",n),t.subscribe("mapZoomed",o)}function a(e,t){var n,o;return o=e.getSubcontainerArea({toGlobal:!1}),n=!d(o,t)}function l(e,t){var o,r,i=[];r=u(e),t=n.chunkArray(t,w),o=t.map(function(e){var t=window.Q.defer();return window.setTimeout(function(){var n;n=e.map(function(e){return e.getSubcontainersByCoordinates(r)}),i=i.concat(n),t.resolve(i)}),t.promise}),o=window.Q.all(o).then(function(){var t,o;return i=n.flatten2Levels(i),t=n.chunkArray(i,y),o=t.map(function(t){var n=window.Q.defer();return window.setTimeout(function(){n.resolve(t.filter(function(t){return t.visible=!a(t,e)}))}),n.promise})}),window.Q.all(o).then(function(){p.processing=!1,m.drawOnNextTick()}).then(null,function(e){window.flatworld.log.debug(e)})}function s(){var e=arguments.length<=0||void 0===arguments[0]?!0:arguments[0],t=arguments.length<=1||void 0===arguments[1]?2:arguments[1];b=m.getViewportArea(e,t)}function c(e){x=f(e,{zoom:m.getZoom()})}function u(e){if(!x)throw new Error("getViewportWithOffset requires module variable offsetSize to have been set");return{x:Math.round(e.x-x),y:Math.round(e.y-x),width:Math.round(e.width+2*x),height:Math.round(e.height+2*x)}}function d(e,t){return e.x<=t.x+t.width&&t.x<=e.x+e.width&&e.y<=t.y+t.height&&t.y<=e.y+e.height}function f(e){var t=arguments.length<=1||void 0===arguments[1]?{zoom:1}:arguments[1];return Math.abs(e.width/t.zoom*w)}function h(e){m=e}var w=.2,v=20,y=40,p={},g=!0,m=void 0,b=void 0,x=void 0;return{init:e,pluginName:"mapMovement",addAll:o,check:r,startEventListeners:i,_testObject:{isObjectOutsideViewport:a,checkAndSetSubcontainers:l,getViewportWithOffset:u,testRectangleIntersect:d,_setMap:h,setupOffsetSize:c}}}var t=window.flatworld.mapEvents,n=window.flatworld.generalUtils.arrays;window.flatworld.extensions.mapMovement=e()}(),window.flatworld.extensions.minimaps={},function(){function e(){function e(e){p=e,b=new i.Manager(p.minimapCanvas),p.initMinimap=a,g=p.getMinimapLayer()}function a(e,n,o,r,i,a){var d=arguments.length<=6||void 0===arguments[6]?{}:arguments[6],f=d.xPadding,h=void 0===f?10:f,y=d.yPadding,p=void 0===y?10:y;return O=h,M=p,g.minimapSize=n,x=i,l(e),s(o),c(r),v(g.minimapSize.x,g.minimapSize.y,g.minimapSize.width,g.minimapSize.height),u(),w(),m=a,g.addChild(m),t.publish("minimapInitialized",g),g}function l(e){g.addChild(e)}function s(e){var t=new o({type:"filter",object:"layer",property:"zoomLayer",value:!0}),n=y();p.getAllObjects({filters:t}).forEach(function(t){n.addChild(e(t))}),n.cacheAsBitmap=!0,g.addChild(n)}function c(e){var t=new o({type:"filter",object:"object",property:"static",value:!1});S=y(),p.getAllObjects({filters:t}).forEach(function(t){S.addChild(e(t))}),S.cacheAsBitmap=!0,g.addChild(S)}function u(){t.subscribe("mapMoved",d),t.subscribe("mapZoomed",f),t.subscribe("minimapClicked",h)}function d(){if(!(C-Date.now()>-5)){var e=x(p.getMovableLayer(),!0);m.x=e.x,m.y=e.y,p.drawOnNextTick()}}function f(){m.scale.x+=.1,m.scale.y=.1}function h(e){var t=r.mouse.eventData.getHAMMERPointerCoords(e),n=new PIXI.Point(e.srcEvent.layerX,e.srcEvent.layerY);t=r.mouse.coordinatesFromGlobalToRelative(t,p.minimapCanvas),C=Date.now(),t.x-=Math.round(m.width/2),t.y-=Math.round(m.height/2),n=x(t,!0),m.x=n.x,m.y=n.y,n=x(t,!1),p.moveMap(n,{absolute:!0,noEvent:!0}),p.drawOnNextTick()}function w(){var e,t={on:function(t){var n=new i.Tap;e=t,b.add(n),b.on("tap",e)},off:function(){b.on("tap",e)}};n.setDetector("minimapClicked",t.on,t.off),n.on("minimapClicked",h)}function v(e,t,n,o){var r=p.getRenderer("minimap");g.position=new PIXI.Point(e,t),r.autoResize=!0,r.resize(n+2*O,o+2*M),p.drawOnNextTick()}function y(){var e=new PIXI.Container;return e.x=O,e.y=M,e}var p,g,m,b,x,C,S,O=0,M=0;return{init:e,pluginName:"pixelizedMinimap",initMinimap:a,_testObject:{}}}var t=window.flatworld.mapEvents,n=window.flatworld.eventListeners,o=window.flatworld.MapDataManipulator,r=window.flatworld.utils,i=window.flatworld_libraries.Hammer;window.flatworld.extensions.minimaps.pixelizedMinimap=e()}(),function(){function e(){function e(e){l=e,l.initMinimap=o,n=l.getMinimapLayer()}function o(e,o,l){var c=e.width,u=e.height,d=arguments.length<=3||void 0===arguments[3]?{}:arguments[3],f=d.x,h=void 0===f?0:f,w=d.y,v=void 0===w?0:w;PIXI.Texture.fromFrame(o);n.targetSize.x=c,n.targetSize.y=u,r(o),i(l),a(Math.round(h),Math.round(v)),t.publish("minimapInitialized",s)}function r(e){var t=PIXI.Texture.fromFrame(e),n=new PIXI.Sprite(t);l.getMinimapLayer().addChild(n)}function i(e){e.width=n.targetSize.x/l.width,e.height=n.targetSize.y/l.height,n.addChild(e)}function a(e){var t=e.x,n=e.y;l.getMinimapLayer().position(new PIXI.Point(t,n))}var l,s;return{init:e,pluginName:"scaledMinimap",_testObject:{}}}var t=window.flatworld.mapEvents;window.flatworld.extensions.minimaps.scaledMinimap=e();var n}(),window.flatworld.extensions.fogOfWars={},function(){function e(){function e(e){C=e,C.activateFogOfWar=n,m=C.getMovableLayer(),b=C.getZoomLayer(),x=C.getRenderer(),O=C.createSpecialLayer("FoWStageMaskLayer"),S=C.createSpecialLayer("FoWMovableMaskLayer"),S.x=m.x,S.y=m.y}function n(e,t){var n=arguments.length<=2||void 0===arguments[2]?{}:arguments[2];j=n.color||2236962,M=e,k=C.getPrimaryLayers({filters:t}).map(function(e){return e.getObjects(t)}),k=r.arrays.flatten2Levels(k),w(),a(),v()}function a(){var e=d(M);if(h(g),e.length>0){var n;(n=S).addChild.apply(n,_toConsumableArray(e))}O.filterArea=new t.Rectangle(0,0,x.width,x.height),u(),b.mask=y,C.registerPreRenderer("renderFoW",s)}function l(){x.render(O,p,!0,null,!1),y.texture=p}function s(){S.position=m.position,l()}function c(){O.scale.x=C.getZoom(),O.scale.y=C.getZoom(),w(),l()}function u(){w(),l()}function d(e){return k.map(function(t){return e(f(t))})}function f(e){var n=e.toGlobal(new t.Point(0,0));return n.x=Math.round(n.x),n.y=Math.round(n.y),n.anchor=e.anchor,n.pivot=e.pivot,n.scale=C.getZoom(),n}function h(){S.children&&S.removeChildren(),O.children&&O.removeChildren(),O.addChild(g),O.addChild(S)}function w(){var e={x:-100,y:-100,width:x.width+200+x.width/C.getZoom(),height:x.height+200+x.height/C.getZoom()};g.clear(),g.beginFill(j),g.drawRect(e.x,e.y,e.width,e.height),g.endFill()}function v(){o.subscribe("mapResized",u),o.subscribe("mapZoomed",c)}var y=new t.Sprite(t.Texture.EMPTY),p=new t.RenderTexture(new t.BaseRenderTexture(i.getWindowSize().x,i.getWindowSize().y)),g=new t.Graphics,m=void 0,b=void 0,x=void 0,C=void 0,S=void 0,O=void 0,M=void 0,k=void 0,j=void 0;return{init:e,pluginName:"simpleFogOfWar",activateFogOfWar:n,refreshFoW:l,getFoWObjectArray:d,calculateCorrectCoordinates:f,FOR_TESTS:{setObjectsForFoW:function(e){return k=e}}}}var t=window.flatworld_libraries.PIXI,n=window.flatworld,o=n.mapEvents,r=n.generalUtils,i=window.flatworld.utils.resize;window.flatworld.extensions.fogOfWars.simpleFogOfWar=e()}(),window.flatworld.UIs=window.flatworld.UIs||{},window.flatworld.UIs["default"]={},window.flatworld.UIs["default"].utils={},window.flatworld.UIs["default"].layout={},function(){window.flatworld.UIs["default"].utils.drawShapes=function(){function e(e,t,n,o,r,i,a,l,s){function c(e,t,n,o,r,i,a,l){var s;switch(t=+t,n=+n,o=+o,r=+r,i=+i,a=+a,e.beginStroke("#F00").moveTo(t,n).lineTo(o,r).lineTo(i,a),l){case 0:s=Math.sqrt((i-t)*(i-t)+(a-n)*(a-n)),e.arcTo(o,r,t,n,.55*s),e.fill();break;case 1:e.beginStroke("#F00").moveTo(t,n).lineTo(o,r).lineTo(i,a).lineTo(t,n).fill();break;case 2:break;case 3:var c=(t+o+i)/3,u=(n+r+a)/3;e.beginFill().quadraticCurveTo(c,u,t,n);break;case 4:var d,f,h,w,v=5;if(i===t)s=a-n,d=(o+t)/2,h=(o+t)/2,f=r+s/v,w=r-s/v;else{s=Math.sqrt((i-t)*(i-t)+(a-n)*(a-n));var y=(t+i)/2,p=(n+a)/2,g=(y+o)/2,m=(p+r)/2,b=(a-n)/(i-t),x=s/(2*Math.sqrt(b*b+1))/v,C=b*x;d=g-x,f=m-C,h=g+x,w=m+C}e.bezierCurveTo(d,f,h,w,t,n),e.fill()}}var u,d,f,h,w,v,y=e.graphics,p="#000";"string"==typeof t&&(t=parseInt(t,10)),"string"==typeof n&&(n=parseInt(n,10)),"string"==typeof o&&(o=parseInt(o,10)),"string"==typeof r&&(r=parseInt(r,10)),i="undefined"!=typeof i?i:3,a="undefined"!=typeof a?a:1,l="undefined"!=typeof l?l:Math.PI/8,s="undefined"!=typeof s?s:10;var g,m,b,x,C="function"!=typeof i?c:i,S=Math.sqrt((o-t)*(o-t)+(r-n)*(r-n)),O=(S-s/3)/S;1&a?(g=Math.round(t+(o-t)*O),m=Math.round(n+(r-n)*O)):(g=o,m=r),2&a?(b=t+(o-t)*(1-O),x=n+(r-n)*(1-O)):(b=t,x=n),y.beginStroke(p).moveTo(b,x).lineTo(g,m);var M=Math.atan2(r-n,o-t),k=Math.abs(s/Math.cos(l));return 1&a&&(u=M+Math.PI+l,d=o+Math.cos(u)*k,f=r+Math.sin(u)*k,h=M+Math.PI-l,w=o+Math.cos(h)*k,v=r+Math.sin(h)*k,C(y,d,f,o,r,w,v,i)),2&a&&(u=M+l,d=t+Math.cos(u)*k,f=n+Math.sin(u)*k,h=M-l,w=t+Math.cos(h)*k,v=n+Math.sin(h)*k,C(y,d,f,t,n,w,v,i)),!0}function t(t,n,o,r,i,a,l,s,c,u,d){var f,h,w,v,y;s="undefined"!=typeof s?s:3,c="undefined"!=typeof c?c:1,u="undefined"!=typeof u?u:Math.PI/8,d="undefined"!=typeof d?d:10,t.beginPath(),t.arc(n,o,r,i,a,l),t.stroke(),t.strokeStyle="rgba(0,0,0,0)",1&c&&(f=Math.cos(i)*r+n,h=Math.sin(i)*r+o,w=Math.atan2(n-f,h-o),l?(v=f+10*Math.cos(w),y=h+10*Math.sin(w)):(v=f-10*Math.cos(w),y=h-10*Math.sin(w)),e(t,f,h,v,y,s,2,u,d)),2&c&&(f=Math.cos(a)*r+n,h=Math.sin(a)*r+o,w=Math.atan2(n-f,h-o),l?(v=f-10*Math.cos(w),y=h-10*Math.sin(w)):(v=f+10*Math.cos(w),y=h+10*Math.sin(w)),e(t,f,h,v,y,s,2,u,d))}function n(e,t,n){var o=arguments.length<=3||void 0===arguments[3]?{color:"#000000",style:5}:arguments[3],r=o.color,i=o.style;return e.lineStyle(i,r),e.moveTo(t.x,t.y),e.lineTo(n.x,n.y),e}return{normal:e,arced:t,line:n}}()}(),function(){var e=window.flatworld_libraries.Handlebars;window.flatworld.UIs=window.flatworld.UIs||{},window.flatworld.UIs["default"]=window.flatworld.UIs["default"]||{},window.flatworld.UIs["default"].templates={multiSelection:e.compile("\n      <span style='font-size:200%;display:block;margin-bottom:20px;'>\n        {{title}}\n      </span>\n      <ul>\n        {{#each objects}}\n        <li>\n          {{this.data.typeData.name}}\n        </li>\n        {{/each}}\n      </ul>"),singleSelection:e.compile("\n      <span style='font-size:200%;display:block;margin-bottom:20px;'>\n        {{title}}\n      </span>\n      <ul>\n        <li>\n          {{object.name}}\n        </li>\n      </ul>")}}();var _createClass=function(){function e(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(t,n,o){return n&&e(t.prototype,n),o&&e(t,o),t}}();!function(){function e(e){if(!c[e]){var t=document.querySelector(s[e]);c[e]=t}return c[e]}var t=window.flatworld_libraries.PIXI,n=window.flatworld.UIs["default"].templates,o=window.flatworld.extensions.hexagons.utils.createVisibleHexagon,r=window.flatworld.UIs["default"].utils.drawShapes,i=window.flatworld.log,a="movementArrow",l=void 0,s=void 0,c={},u=function(){function c(e,t){var n=arguments.length<=2||void 0===arguments[2]?{}:arguments[2],o=n.radius,r=void 0===o?71:o,i=n.styles,a=void 0===i?"#F0F0F0":i,u=n.elements;_classCallCheck(this,c),this.RADIUS=r,s=u,l=this.addStyleElement();var d="\n        "+s.select+" {\n          z-index: 9999;\n          opacity: 0.9;\n          position: fixed;\n          left: 0px;\n          bottom: 0px;\n          background-color: brown;\n          border: 1px solid rgb(255, 186, 148);;\n          border-bottom: 0px;\n          padding:15px;\n          margin-left:10px;\n        }";this.addCSSRulesToScriptTag(l,d),this.FTW=t,this.modal=e||document.getElementById("dialog_select"),this.styles=a}return _createClass(c,[{key:"setFlatworld",value:function(e){this.FTW=e}},{key:"getTemplates",value:function(){return n}},{key:"showSelections",value:function(t,o,r){var a,l=this,c=this.FTW.drawOnNextTick.bind(this.FTW),u=this.FTW.getMovableLayer();a=t&&t.length>1?function(){l.modal.innerHTML=n.multiSelection({title:"Objects",objects:t}),l.showModal(l.modal,s),e("select").style.display="block"}:t&&1===t.length?function(){l.highlightSelectedObject(t[0])}:function(){u.deleteUIObjects(),c(),i.debug("Error occured selecting the objects on this coordinates! Nothing found")},e("select").style.display="none",a()}},{key:"highlightSelectedObject",value:function(t,o){var r,i,a=arguments.length<=2||void 0===arguments[2]?{shadow:{color:"0x0000",distance:5,alpha:.55,angle:45,blur:5}}:arguments[2],l=a.shadow;return i=o.allData(t),this.modal.innerHTML=n.singleSelection({title:"Selected",object:{name:i.name}}),this.showModal(this.modal,s),r=this._highlightSelectedObject(t,this.FTW.getRenderer()),r.dropShadow({color:l.color,distance:l.distance,alpha:l.alpha,angle:l.angle,blur:l.blur}),this.FTW.drawOnNextTick(),e("select").style.display="block",r}},{key:"showUnitMovement",value:function(e){var t=this;if(!Array.isArray(e))throw new Error("showUnitMovement demands path array!");var n=[],o=void 0;this.FTW.removeUIObject(this.FTW.layerTypes.movableType.id,a),e.forEach(function(e,r){return 0===r?void(o=e):(n.push(t._createArrow(o,e)),void(o=e))}),this.FTW.addUIObject(this.FTW.layerTypes.movableType.id,n,a),this.FTW.drawOnNextTick()}},{key:"_highlightSelectedObject",value:function(e,n){var o,r=this.FTW.getMovableLayer();o=e.clone(n,{anchor:!0,scale:!0});var i=e.toGlobal(new t.Point(0,0));return i=r.toLocal(i),this.createHighlight(o,{coords:i}),o}},{key:"_createArrow",value:function(e,n){return r.line(new t.Graphics,e,n)}},{key:"createHighlight",value:function(e){var n,r=arguments.length<=1||void 0===arguments[1]?{coords:new t.Point(0,0)}:arguments[1],i="unit highlight",a=this.FTW.getMovableLayer(),l=new this.FTW.createSpecialLayer("UILayer",{toLayer:a}),s={x:Number(e.x),y:Number(e.y)};n=o(this.RADIUS,{color:"#F0F0F0"}),n.position.set(s.x,s.y),n.alpha=.5,l.addChild(n),l.addChild(e),l.position=r.coords,this.FTW.removeUIObject(this.FTW.layerTypes.movableType.id),this.FTW.addUIObject(this.FTW.layerTypes.movableType.id,l,i)}},{key:"addCSSRulesToScriptTag",value:function(e,t){e.insertRule(t,0)}},{key:"addStyleElement",value:function(){var e=document.createElement("style");return e.appendChild(document.createTextNode("")),document.head.appendChild(e),e.sheet}},{key:"showModal",value:function(e,t){e.classList.add(t.select)}}]),c}();window.flatworld.UIs["default"].init=u}();var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol?"symbol":typeof e},_createClass=function(){function e(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(t,n,o){return n&&e(t.prototype,n),o&&e(t,o),t}}();!function(){var e=window.flatworld_libraries,t=e.Q,n=e.PIXI,o=window.flatworld,r=o.mapLayers,i=o.ObjectManager,a=o.mapEvents,l=o.generalUtils,s=o.log,c=o.utils,u=o.constants,d=0,f=1,h=2,w={},v=!1,y=[],p=void 0,g=void 0,m=void 0,b=void 0,x=void 0,C=function(){function e(){var t=arguments.length<=0||void 0===arguments[0]?null:arguments[0],o=arguments.length<=1||void 0===arguments[1]?{}:arguments[1],a=o.bounds,s=void 0===a?{width:0,height:0}:a,v=o.mapSize,y=void 0===v?{x:0,y:0}:v,C=o.rendererOptions,S=void 0===C?{autoResize:!0,antialias:!1}:C,O=o.minimapCanvas,M=o.subcontainers,k=void 0===M?{width:100,height:100,maxDetectionOffset:0}:M,j=o.trackFPSCB,T=void 0===j?!1:j,L=o.defaultScaleMode,_=void 0===L?n.SCALE_MODES.DEFAULT:L;if(_classCallCheck(this,e),!t)throw new Error(this.constructor.name+" needs canvas element!");"string"==typeof t&&(t=document.querySelector(t)),t.innerHTML="",S.view=t,w.main=new n.WebGLRenderer(s.width,s.height,S),w.main.getResponsibleLayer=this.getZoomLayer,O&&(w.minimap=O?new n.WebGLRenderer(0,0,{view:O,autoResize:!0}):void 0,w.minimap.plugins.interaction.destroy(),w.minimap.getResponsibleLayer=this.getMinimapLayer),w.main.plugins.interaction.destroy(),x=r.MapLayerParent,g=new r.MapLayer({name:"zoomLayer",coord:{x:0,y:0}}),m=new r.MapLayer({name:"movableLayer",coord:{x:0,y:0}}),b=new r.MapLayer({name:"minimapLayer",coord:{x:0,y:0}}),g.addChild(m),c.general.fullsizeCanvasCSS(w.main.view),t.style.overflow="hidden",c.mouse.disableContextMenu(w.main.view),this.defaultScaleMode=n.SCALE_MODES.DEFAULT=_,p=Object.keys(w).map(function(e){return w[e]}),this.canvas=w.main.view,this.minimapCanvas=w.minimap?w.minimap.view:void 0,
this.mapSize=y,this.plugins=new Set,k.maxDetectionOffset=k.maxDetectionOffset||100,this.subcontainersConfig=k,this.trackFPSCB=T,this.objectManager=new i,this.isSupportedTouch=l.environmentDetection.isTouchDevice(),this.currentlySelectedObjects=[],this.layerTypes={staticType:{id:d,layer:g},movableType:{id:f,layer:m},minimapType:{id:h,layer:b}},this.VERSION=u.VERSION,this.preRenderers={},this.allMapObjects={}}return _createClass(e,[{key:"init",value:function(){var e=arguments.length<=0||void 0===arguments[0]?[]:arguments[0],t=arguments.length<=1||void 0===arguments[1]?{x:0,y:0}:arguments[1],n=this,o=arguments.length<=2||void 0===arguments[2]?null:arguments[2],r=arguments.length<=3||void 0===arguments[3]?{fullsize:!0}:arguments[3],i=[];return r.fullsize&&this.toggleFullsize(),this.getAllObjects().forEach(function(e){e&&e.initializeCoordinates&&e.initializeCoordinates(n)}),this.allMapObjects=this._createArrayStructure(),t&&Object.assign(m,t),e.length&&(i=this.activatePlugins(e)),this._defaultTick(),o&&this.customTickOn(o),y=i,this.drawOnNextTick(),i||Promise.resolve()}},{key:"whenReady",value:function(){return t.all(y)}},{key:"drawOnNextTick",value:function(){v=!0}},{key:"collectGarbage",value:function(){p.forEach(function(e){return e.textureGC.run()})}},{key:"addUIObject",value:function(e,t,n){var o=this;Array.isArray(t)?t.forEach(function(t,r){o._addObjectToUIlayer(e,t,n)}):this._addObjectToUIlayer(e,t,n)}},{key:"removeUIObject",value:function(e,t){switch(e){case d:this.getZoomLayer().deleteUIObjects(t);break;case f:this.getMovableLayer().deleteUIObjects(t)}}},{key:"createSpecialLayer",value:function(){var e=arguments.length<=0||void 0===arguments[0]?"default special layer":arguments[0],t=arguments.length<=1||void 0===arguments[1]?{coord:{x:0,y:0},toLayer:!1}:arguments[1],n=t.coord||{x:0,y:0},o=new r.MapLayer({name:e,coord:n});return o.specialLayer=!0,t.toLayer&&t.toLayer.addChild(o),o}},{key:"addLayer",value:function(e){var t=void 0;return this.getSubcontainerConfigs()&&e.subcontainers!==!1&&(e.subcontainers=this.getSubcontainerConfigs()),t=new x(e),this.getMovableLayer().addChild(t),t}},{key:"usesSubcontainers",value:function(){return!(!this.getSubcontainerConfigs().width||!this.getSubcontainerConfigs().height)}},{key:"getSubcontainerConfigs",value:function(){return this.subcontainersConfig}},{key:"getViewportArea",value:function(){var e=arguments.length<=0||void 0===arguments[0]?!1:arguments[0],t=arguments.length<=1||void 0===arguments[1]?0:arguments[1],o=e?this.getMovableLayer():this.getZoomLayer(),r=new n.Point(0,0),i=new n.Point(window.innerWidth,window.innerHeight);e&&(i=o.toLocal(i),r=o.toLocal(r));var a={x:r.x,y:r.y},l={x2:i.x,y2:i.y},s={x:(Math.abs(l.x2)-a.x)*t,y:(Math.abs(l.y2)-a.y)*t};return{x:Math.round(a.x-s.x),y:Math.round(a.y-s.y),width:Math.round(Math.abs(Math.abs(l.x2)-a.x)+2*s.x),height:Math.round(Math.abs(Math.abs(l.y2)-a.y)+2*s.y)}}},{key:"removeLayer",value:function(e){return m.removeChild(e),e}},{key:"getMapsize",value:function(){return this.mapSize}},{key:"moveMap",value:function(e){var t=e.x,o=void 0===t?0:t,r=e.y,i=void 0===r?0:r,l=arguments.length<=1||void 0===arguments[1]?{}:arguments[1],s=l.absolute,c=void 0===s?!1:s,u={x:Math.round(o/this.getZoomLayer().getZoom()),y:Math.round(i/this.getZoomLayer().getZoom())};c?m.position=new n.Point(o,i):m.move(u),a.publish("mapMoved",u),this.drawOnNextTick()}},{key:"activatePlugins",value:function(){var e=this,t=arguments.length<=0||void 0===arguments[0]?[]:arguments[0],n=[];return t.forEach(function(t){"object"===("undefined"==typeof t?"undefined":_typeof(t))?e.activatePlugin(t):s.error("problem with initializing a plugin: "+t.name)}),n}},{key:"activatePlugin",value:function(e){try{if(!e||!e.pluginName||!e.init)throw new Error("plugin, plugin.pluginName or plugin.init import is missing!");this.plugins.add(e[e.pluginName]),this.plugins.has(e[e.pluginName])&&e.init(this)}catch(t){s.error('An error initializing plugin. JSON.stringify: "'+JSON.stringify(e)+'" ',t)}}},{key:"registerPreRenderer",value:function(e,t){if(!e&&!t)throw new Error("name and callback required for registerPreRenderer");this.preRenderers[e]={cb:t}}},{key:"removePreRenderer",value:function(e){delete this.preRenderers[e]}},{key:"setPrototype",value:function(e,t){var n=Object.getPrototypeOf(this);n[e]=t}},{key:"getObjectsUnderArea",value:function(e){var t=e.x,o=void 0===t?0:t,r=e.y,i=void 0===r?0:r,a=e.width,l=void 0===a?0:a,s=e.height,c=void 0===s?0:s,u=arguments.length<=1||void 0===arguments[1]?{}:arguments[1],d=u.filters,f=void 0===d?null:d,h={x:o,y:i,width:l,height:c},w={globalCoords:h,localCoords:this.getMovableLayer().toLocal(new n.Point(h.x,h.y))},v=[];w.localCoords.width=h.width/this.getZoom(),w.localCoords.height=h.height/this.getZoom();var y=this._getSubcontainersUnderArea(w,{filters:f});return v=this._retrieveObjects(w,y),f&&f.doesItFilter("object")&&(v=f.filter(v)),v}},{key:"getPrimaryLayers",value:function(){var e=arguments.length<=0||void 0===arguments[0]?{}:arguments[0],t=e.filters;return this.getMovableLayer().getPrimaryLayers({filters:t})}},{key:"getAllObjects",value:function(){var e=arguments.length<=0||void 0===arguments[0]?{}:arguments[0],t=e.filters,n=void 0,o=void 0;return n=this.getPrimaryLayers({filters:t}).map(function(e){var n=void 0;if(e.hasSubcontainers()){var r=e.getSubcontainers();return n=r.map(function(e){return o=e.children.map(function(e){return t?t.filter(e):e}),l.arrays.flatten2Levels(o)}),l.arrays.flatten2Levels(n)}}),n=l.arrays.flatten2Levels(n)}},{key:"getZoomLayer",value:function(){return g}},{key:"setZoom",value:function(e){return this.getZoomLayer().setZoom(e),a.publish({name:"mapZoomed",cooldown:!0},{previousScale:this.getZoom(),newScale:e}),e}},{key:"getZoom",value:function(){return this.getZoomLayer().getZoom()}},{key:"getRenderer",value:function(e){return"minimap"===e?w.minimap:w.main}},{key:"getMovableLayer",value:function(){return m}},{key:"getMapCoordinates",value:function(e){return e.toGlobal?m.toLocal(u.ZERO_COORDINATES,e):m.toLocal(e)}},{key:"getMinimapLayer",value:function(){return b}},{key:"removeMinimapLayer",value:function(){b=void 0}},{key:"zoomIn",value:function(){return"notImplementedYet. Activate with plugin"}},{key:"zoomOut",value:function(){return"notImplementedYet. Activate with plugin"}},{key:"toggleFullsize",value:function(){return"notImplementedYet. Activate with plugin"}},{key:"toggleFullScreen",value:function(){return"notImplementedYet. Activate with plugin"}},{key:"initMinimap",value:function(){return"notImplementedYet. Activate with plugin"}},{key:"activateFogOfWar",value:function(){return"notImplementedYet. Activate with plugin"}},{key:"_retrieveObjects",value:function(e){var t=arguments.length<=1||void 0===arguments[1]?[]:arguments[1],n=arguments.length<=2||void 0===arguments[2]?{}:arguments[2],o=n.type,r=void 0===o?"":o;return this.objectManager.retrieve(e,t,{type:r,size:{width:e.globalCoords.width,height:e.globalCoords.height}})}},{key:"_getLayersWithAttributes",value:function(e,t){return this.getMovableLayer().children[0].children.filter(function(n){return n[e]===t})}},{key:"_getSubcontainersUnderArea",value:function(e){var t=arguments.length<=1||void 0===arguments[1]?{}:arguments[1],n=t.filters,o=this.getPrimaryLayers({filters:n}),r=[],i=void 0;return o.forEach(function(t){i=t.getSubcontainersByCoordinates(e.localCoords),r=r.concat(i)}),r}},{key:"_defaultTick",value:function(){var e=this,t=1e3,o=0,r=(new Date).getTime(),i=void 0,a=void 0;n.ticker.shared.add(function(){v&&(e.trackFPSCB&&(i=(new Date).getTime()),Object.keys(e.preRenderers).forEach(function(t){return e.preRenderers[t].cb()}),p.forEach(function(e){return e.render(e.getResponsibleLayer())}),e.trackFPSCB&&(a+=Math.round(Math.abs(i-(new Date).getTime()))),v=!1),e.trackFPSCB&&(o++,r+t<(new Date).getTime()&&(e.trackFPSCB({FPS:o,FPStime:r,renderTime:a,drawCount:w.main.drawCount}),o=0,a=0,r=(new Date).getTime()))})}},{key:"_addObjectToUIlayer",value:function(e,t,n){switch(e){case d:this.getZoomLayer().addUIObject(t,n);break;case f:this.getMovableLayer().addUIObject(t,n)}}},{key:"_createArrayStructure",value:function(){var e={};return this.getPrimaryLayers().forEach(function(t){e[t.name]=t.getObjects()}),e}}]),e}();window.flatworld.Flatworld=C}();var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol?"symbol":typeof e};!function(){function e(e,n){var l=arguments.length<=2||void 0===arguments[2]?{}:arguments[2],s=l.trackFPSCB,c=void 0===s?!1:s,u=l.isHiddenByDefault,d=void 0===u?!0:u,f=l.minimapCanvas,h=l.scaleMode,w=void 0===h?t.SCALE_MODES.DEFAULT:h;i.debug("============== Hexagonal Map factory started =============");var v=r.environmentDetection.getPixelRatio(),y="string"==typeof n.map?JSON.parse(n.map):n.map,p="string"==typeof n.type?JSON.parse(n.type):n.type,g="string"==typeof n.game?JSON.parse(n.game):n.game,m="string"==typeof n.graphic?JSON.parse(n.graphic):n.graphic,b=r.resize.getWindowSize(),x={ObjectTerrain:a.objects.ObjectHexaTerrain,ObjectUnit:a.objects.ObjectHexaUnit},C={mapSize:g.mapSize,bounds:{x:0,y:0,width:b.x,height:b.y},rendererOptions:{resolution:v,autoResize:!0,transparent:!0,antialias:!1},subcontainers:{width:500,height:500,maxDetectionOffset:100,isHiddenByDefault:d},trackFPSCB:c,defaultScaleMode:w,minimapCanvas:f},S=new o(e,C);return t.SCALE_MODES.DEFAULT=1,y.layers.forEach(function(e){if("object"!==("undefined"==typeof e?"undefined":_typeof(e)))throw i.error("Problem in hexaFactory, with layerData:"+JSON.stringify(e)),new Error("Problem in hexaFactory, with layerData:",e);var n,o=S.getRenderer(),r={name:e.name,coord:e.coord,drawOutsideViewport:{x:o.width,y:o.height},selectable:"unitLayer"===e.name};try{n=S.addLayer(r),e.objectGroups.forEach(function(e){var o=e.typeImageData;return o?void e.objects.forEach(function(r){var a,l,s,c;try{if(a=p[o][r.objType],!a)throw i.error("Bad mapData for type:",o,r.objType,r.name),new Error("Bad mapData for type:",o,r.objType,r.name);s=t.Texture.fromFrame(a.image),l={data:{typeData:a,activeData:r.data},radius:g.hexagonRadius,minimapColor:a.minimapColor,minimapSize:a.minimapSize},c=new x[e.type](s,r.coord,l),m[e.typeImageData].initialScale&&(c.scale.x=m[e.typeImageData].initialScale,c.scale.y=m[e.typeImageData].initialScale),n.addChild(c)}catch(u){i.error(u)}}):void i.error("Error with spritesheetType-data")})}catch(a){i.error("Problem:"+JSON.stringify(e.type)+" ---- "+JSON.stringify(a.stack))}}),S.moveMap(g.startPoint),S}var t=window.flatworld_libraries.PIXI,n=window.flatworld,o=n.Flatworld,r=n.utils,i=n.log,a=window.flatworld.extensions.hexagons;window.flatworld.factories.hexaFactory=e}();