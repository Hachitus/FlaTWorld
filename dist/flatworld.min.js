"use strict";function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _toConsumableArray(e){if(Array.isArray(e)){for(var t=0,n=Array(e.length);t<e.length;t++)n[t]=e[t];return n}return Array.from(e)}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function filterChildren(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[],n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:void 0;return t.filter(function(t){if(n&&n!==t.type)return!1;var o=!t.hitTest||t.hitTest(e);return o})}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _toConsumableArray(e){if(Array.isArray(e)){for(var t=0,n=Array(e.length);t<e.length;t++)n[t]=e[t];return n}return Array.from(e)}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}function _toConsumableArray(e){if(Array.isArray(e)){for(var t=0,n=Array(e.length);t<e.length;t++)n[t]=e[t];return n}return Array.from(e)}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}!function(){window.flatworld_libraries={},window.flatworld_libraries.PIXI=window.PIXI,window.flatworld_libraries.Q=window.Q,window.flatworld_libraries.Hammer=window.Hammer,window.flatworld_libraries.Hamster=window.Hamster,window.flatworld_libraries.Handlebars=window.Handlebars,window.flatworld_libraries.log=window.log,window.flatworld_libraries.Howler=window.Howl,window.flatworld_libraries.EventEmitter=window.EventEmitter,window.flatworld={},window.flatworld.generalUtils={},window.flatworld.log={},window.flatworld.objects={},window.flatworld.extensions={},window.flatworld.mapLayers={},window.flatworld.utils={},window.flatworld.factories={},window.flatworld.UIs={},window.flatworld.UIs["default"]={}}(),function(){var e=window.flatworld_libraries.log;e.enableAll(),window.flatworld.log={debug:function(t){e.debug(t)},error:function(t){e.error(t)}}}();var _createClass=function(){function e(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(t,n,o){return n&&e(t.prototype,n),o&&e(t,o),t}}();!function(){var e=window.flatworld_libraries,t=e.Q,n=e.PIXI,o=function(){function e(t){var o=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{concurrency:15,crossOrigin:!1};_classCallCheck(this,e);var i=o.concurrency;this.preloaderClass=new n.loaders.Loader(t,i)}return _createClass(e,[{key:"resolveOnComplete",value:function(){var e=t.defer();return this.preloaderClass.load(),this.preloaderClass.once("complete",function(t,n){e.resolve(t,n)}),e.promise}},{key:"addResource",value:function(e){this.preloaderClass.add(e)}},{key:"loadManifest",value:function(){return this}},{key:"setErrorHandler",value:function(e){return this.preloaderClass.on("error",e),this}},{key:"setProgressHandler",value:function(e){return this.preloaderClass.on("error",e),this}},{key:"activateSound",value:function(){this.preloaderClass.installPlugin()}}]),e}();window.flatworld.Preload=o}(),function(){var e=window.flatworld_libraries.PIXI,t={ZERO_COORDINATES:new e.Point(0,0),VERSION:"0.5.0"};window.flatworld.constants=t}(),function(){function e(){function e(){Array.prototype.find||(Array.prototype.find=function(e){if(null===this)throw new TypeError("Array.prototype.find called on null or undefined");if("function"!=typeof e)throw new TypeError("predicate must be a function");for(var t=Object(this),n=t.length>>>0,o=arguments[1],i=void 0,r=0;r<n;r++)if(i=t[r],e.call(o,i,r,t))return i})}function t(){"function"!=typeof Object.assign&&!function(){Object.assign=function(e){if(void 0===e||null===e)throw new TypeError("Cannot convert undefined or null to object");for(var t=Object(e),n=1;n<arguments.length;n++){var o=arguments[n];if(void 0!==o&&null!==o)for(var i in o)o.hasOwnProperty(i)&&(t[i]=o[i])}return t}}()}function n(){String.prototype.repeat||!function(){var e=void 0,t=function(){try{var t={},n=Object.defineProperty;e=n(t,t,t)&&n}catch(o){return e}return e}(),n=function(e){if(null==this)throw TypeError();var t=String(this),n=e?Number(e):0;if(n!=n&&(n=0),n<0||n==1/0)throw RangeError();for(var o="";n;)n%2==1&&(o+=t),n>1&&(t+=t),n>>=1;return o};t?t(String.prototype,"repeat",{value:n,configurable:!0,writable:!0}):String.prototype.repeat=n}()}function o(){Object.setPrototypeOf=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e}}return{arrayFind:e,objectAssign:t,es6String:n,setPrototypeOf:o}}window.flatworld.generalUtils.polyfills=e()}(),function(){function e(){function e(e){var t;return(t=[]).concat.apply(t,_toConsumableArray(e))}function t(e,t){for(var n=[],o=0;o<e.length;o+=t)n.push(e.slice(o,t+o));return n}return{flatten2Levels:e,chunkArray:t}}window.flatworld.generalUtils.arrays=e()}(),function(){function e(){function e(){var e=screen.width<=640||window.matchMedia&&window.matchMedia("only screen and (max-width: 640px)").matches,t="ontouchstart"in window||navigator.maxTouchPoints>0||navigator.msMaxTouchPoints>0;return t&&e}return{isMobile:e,isTouchDevice:t}}function t(){return"ontouchstart"in document.documentElement}window.flatworld.generalUtils.environmentDetection=e()}(),function(){function e(){function e(e){return Object.keys(e).map(function(t){return e[t]})}function t(e){var t=[];return t.concat.apply(t,e)}return{mapObjectsToArray:e,flattenArrayBy1Level:t}}window.flatworld.utils.dataManipulation=e()}(),function(){function e(){function e(){}return{dropShadow:e}}window.flatworld.utils.effects=e()}(),function(){function e(){function e(e){return 3===e.which}function t(e){e.addEventListener("contextmenu",function(e){e.preventDefault()})}function n(e){return new i.Point(e.offsetX,e.offsetY)}function o(e){return new i.Point(e.center.x,e.center.y)}function r(e,t){return t?o(e):n(e)}function a(e,t){var n=l(t);return{x:e.x-n.x,y:e.y-n.y}}function l(e){for(var t=0,n=0;e;){if("body"===e.tagName.toLowerCase()){var o=e.scrollLeft||document.documentElement.scrollLeft,i=e.scrollTop||document.documentElement.scrollTop;t+=e.offsetLeft-o+e.clientLeft,n+=e.offsetTop-i+e.clientTop}else t+=e.offsetLeft-e.scrollLeft+e.clientLeft,n+=e.offsetTop-e.scrollTop+e.clientTop;e=e.offsetParent}return{x:t,y:n}}function s(e){var t={x:0,y:0};return e||(e=window.event),e.pageX||e.pageY?(t.x=e.pageX,t.y=e.pageY):(e.clientX||e.clientY)&&(t.x=e.clientX+document.body.scrollLeft+document.documentElement.scrollLeft,t.y=e.clientY+document.body.scrollTop+document.documentElement.scrollTop),t}return{isRightClick:e,disableContextMenu:t,eventData:{getPointerCoords:n,getHAMMERPointerCoords:o,getGlobalCoordinates:r},coordinatesFromGlobalToRelative:a,eventMouseCoords:s}}function t(){function e(){function e(e){var t=e.cancelFullScreen||e.webkitCancelFullScreen||e.mozCancelFullScreen||e.exitFullscreen;if(t)t.call(e);else if("undefined"!=typeof window.ActiveXObject){var n=new ActiveXObject("WScript.Shell");null!==n&&n.SendKeys("{F11}")}}function t(e){var t=e.requestFullScreen||e.webkitRequestFullScreen||e.mozRequestFullScreen||e.msRequestFullScreen;if(t)t.call(e);else if("undefined"!=typeof window.ActiveXObject){var n=new ActiveXObject("WScript.Shell");null!==n&&n.SendKeys("{F11}")}return!1}var n=document.body,o=document.fullScreenElement&&null!==document.fullScreenElement||document.mozFullScreen||document.webkitIsFullScreen;return o?e(document):t(n),!1}function t(e){return function(){var t=n();e.canvas.width=t.x,e.canvas.height=t.y}}function n(){return{x:window.innerWidth,y:window.innerHeight}}function o(e,t){var o=n();e.autoResize=!0,e.resize(o.x,o.y),t()}return{toggleFullScreen:e,setToFullSize:t,getWindowSize:n,resizePIXIRenderer:o}}function n(){function e(e){var t=window.devicePixelRatio||1,n=e&&e.getContext("2d")||document.createElement("canvas").getContext("2d"),o=n.webkitBackingStorePixelRatio||n.mozBackingStorePixelRatio||n.msBackingStorePixelRatio||n.oBackingStorePixelRatio||n.backingStorePixelRatio||1;return t/o}return{getPixelRatio:e}}function o(){function e(e,t){return Math.abs(e)-Math.abs(t)<i}function t(e){e.style.position="absolute",e.style.display="block",e.style.left="0px",e.style.top="0px"}function n(e,t){throw new Error("Function '"+e+"' requires parameter "+t)}function o(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:document.getElementsByTagName("body")[0];e.style.webkitTouchCallout="none",e.style.webkitUserSelect="none",e.style.khtmlUserSelect="none",e.style.mozUserSelect="none",e.style.msUserSelect="none",e.style.userSelect="none"}var i=.01;return{pixelEpsilonEquality:e,fullsizeCanvasCSS:t,requireParameter:n,toggleMouseTextSelection:o}}var i=window.flatworld_libraries.PIXI;window.flatworld.utils.mouse=e(),window.flatworld.utils.resize=t(),window.flatworld.utils.environmentDetection=n(),window.flatworld.utils.general=o()}(),function(){function e(){var e=new t.Graphics;return e.lineStyle(2,255,1),e.drawRect(50,250,100,100),e}var t=window.flatworld_libraries.PIXI;window.flatworld.utils.shapes={createSquare:e}}(),function(){function e(){function e(e,t){return a("get",e,t)}function n(e,t){return a("post",e,t)}function o(e,n,o){s[e]&&t.debug("API endpoint already exists and has been defined "+e+", "+o+", "+JSON.stringify(n)),s[e]={baseUrl:o,cbs:n?[n]:[]}}function i(e){s[e]||t.debug("API endpoint not found for removing!"),delete s[e]}function r(e,n){s[e]&&s[e].cbs||t.debug("API endpoint not found for updating!"),s[e].cbs.push(n)}function a(e,n,o){if(!s[n])return void t.error("API endpoint for fetch not found: "+e+"/"+n+", "+(o?o[0]:"no params"));var i=s[n];return s[n].cbs.forEach(function(t){i=t(e,i,o)}),fetch(i.url,{method:e,body:i.body}).then(function(e){return e.json()}).then(function(e){t.debug("parsed json",e)})["catch"](function(e){t.debug("mapAPI http request failed",e)})}function l(){return s}var s={};return{get:e,post:n,add:o,remove:i,update:r,getAllAPIs:l}}var t=window.flatworld.log;window.flatworld.mapAPI=e()}(),function(){function e(){function e(e,t){a.on(e,t),r[e]=0}function n(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"",t=arguments[1],n=(new Date).getTime(),o=e.name||e;r[o]+(e.cooldown||i)<n&&(r[o]=n,a.emit(o,t))}function o(e,t,n){var o=void 0;return function(){var i=this,r=arguments,a=function(){o=null,n||e.apply(i,r)},l=n&&!o;clearTimeout(o),o=setTimeout(a,t),l&&e.apply(i,r)}}var i=50,r={},a=new t;return{subscribe:e,publish:n,debounce:o,removeAllListeners:a.removeAllListeners.bind(a)}}var t=window.flatworld_libraries.EventEmitter;window.flatworld.mapEvents=e()}(),function(){function e(){function e(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"",t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(!o[e]||!o[e].on)throw new Error("eventlisteners.on needs to have detector set with this event type!");o[e].on(d("Map"+e,t)),n[e]=n[e]||new Set,n[e].add(t)}function r(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"",t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];o[e].off(t),t?n[e]["delete"](t):delete n[e]}function a(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"",t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];return t?n[e].has(t):!!n[e].size}function l(e,n){t[e]=n}function s(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"";return t[e]}function c(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"",t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:function(){},n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:function(){};o[e]={},o[e]={on:t,off:n}}function u(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"";n[e].forEach(function(t){o[e].cbOff(t)}),delete n[e],delete o[e]}function d(e,t){return function(){i.publish(e),t.apply(void 0,arguments)}}return{on:e,off:r,isOn:a,setActivityState:l,getActivityState:s,setDetector:c,clearDetector:u}}var t={},n={},o={},i=window.flatworld.mapEvents;window.flatworld.eventListeners=e()}();var _get=function e(t,n,o){null===t&&(t=Function.prototype);var i=Object.getOwnPropertyDescriptor(t,n);if(void 0===i){var r=Object.getPrototypeOf(t);return null===r?void 0:e(r,n,o)}if("value"in i)return i.value;var a=i.get;if(void 0!==a)return a.call(o)},_createClass=function(){function e(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(t,n,o){return n&&e(t.prototype,n),o&&e(t,o),t}}();!function(){function e(e,t){var n=t.subcontainersConfig,o=t.subcontainerList,i=Math.floor(e.x/n.width),r=Math.floor(e.y/n.height),a=void 0;return o[i]=o[i]||[],a=o[i][r]=o[i][r]||[],o[i][r].length<=0&&(a=new s({x:i*n.width,y:r*n.height,width:n.width,height:n.height}),o[i][r]=a,a.x=i*n.width,a.y=r*n.height,a.visible=!n.isHiddenByDefault),e.x-=a.x,e.y-=a.y,o[i][r].addChild(e),o[i][r]}function t(e,t){for(var n=e.getSubcontainerConfigs(),o=n.width,i=n.height,r=n.maxDetectionOffset,a={x:t.x>=0?t.x-r:-r,y:t.y>=0?t.y-r:-r,width:(t.width||0)+2*r,height:(t.height||0)+2*r},l=[],s=Math.floor(a.x/o),c=Math.floor(a.y/i),u=a.width?a.x+a.width:+a.x,d=a.height?a.y+a.height:+a.y,f=Math.floor(u/o),h=Math.floor(d/i),v=e.subcontainerList,w=s;w<=f;w++)if(w>=0&&v&&v[w])for(var p=c;p<=h;p++)p>=0&&v[w][p]&&l.push(v[w][p]);return l}function n(e,t){Array.isArray(e)?e.forEach(function(e){t.removeChild(e)}):t.removeChild(e)}var o=window.flatworld_libraries.PIXI,i=window.flatworld.generalUtils,r=[],a=function(e){function t(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},n=e.name,o=void 0===n?"":n,i=e.coord,r=void 0===i?{x:0,y:0}:i,a=e.specialLayer,l=void 0!==a&&a,s=e.zoomLayer,c=void 0===s||s,u=e.selectable,d=void 0!==u&&u;_classCallCheck(this,t);var f=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return Object.assign(f,r),f.name=""+o,f.specialLayer=!!l,f.zoomLayer=!!c,f.selectable=d,f.UIObjectList={},f}return _inherits(t,e),_createClass(t,[{key:"hasSubcontainers",value:function(){return!!(this.subcontainersConfig&&this.subcontainersConfig.width&&this.subcontainersConfig.height)}},{key:"move",value:function(e){this.x+=e.x,this.y+=e.y}},{key:"setZoom",value:function(e){return this.scale.x=this.scale.y=+e.toFixed(2),this.scale.x}},{key:"getZoom",value:function(){return this.scale.x}},{key:"getUIObjects",value:function(){return r}},{key:"getPrimaryLayers",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=e.filters;return this.children.filter(function(e){return!(t&&t.doesItFilter("layer")&&!t.filter(e).length||e.specialLayer)})}},{key:"getObjects",value:function(e){throw new Error("Has to be implemented in child class")}},{key:"createUILayer",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"default UI layer",n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{x:0,y:0},o=new t(e,n);return o.specialLayer=!0,this.addChild(o),this.UILayer=o,o}},{key:"getUILayer",value:function(){return this.UILayer}},{key:"addUIObject",value:function(e,t){return r=r||[],this.UIObjectList[t]&&Array.isArray(this.UIObjectList[t])?this.UIObjectList[t].push(e):this.UIObjectList[t]?(this.UIObjectList[t]=[this.UIObjectList[t]],this.UIObjectList[t].push(e)):this.UIObjectList[t]=e,this.getUILayer()||(this.UILayer=this.createUILayer()),this.UILayer.addChild(e),r.push(e),r}},{key:"deleteUIObjects",value:function(e){var t=this,o=this.getUILayer();if(e){var i=this.UIObjectList[e];return n(i,o),void(this.UIObjectList[e]=void 0)}return Object.keys(this.UIObjectList).map(function(e){var i=t.UIObjectList[e];n(i,o),t.UIObjectList[e]=void 0}),r}}]),t}(o.Container),l=function(n){function o(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=(e.name,e.coord,e.subcontainers),n=void 0===t?{width:0,height:0,maxDetectionOffset:100}:t,i=e.specialLayer,r=void 0!==i&&i,a=(e.zoomLayer,e.selectable),l=void 0!==a&&a;_classCallCheck(this,o);var s=_possibleConstructorReturn(this,(o.__proto__||Object.getPrototypeOf(o)).call(this,arguments[0]));return s.oldAddChild=_get(o.prototype.__proto__||Object.getPrototypeOf(o.prototype),"addChild",s).bind(s),s.subcontainersConfig=n,s.subcontainerList=[],s.selectable=l,s.specialLayer=r,s}return _inherits(o,n),_createClass(o,[{key:"addChild",value:function(t){if(this.hasSubcontainers()){var n=e(t,this);this.oldAddChild(n)}else this.oldAddChild(t);return t}},{key:"getObjects",value:function(e){var t=[],n=e&&e.doesItFilter("object"),o=void 0;return this.getSubcontainers().forEach(function(i){o=n?i.children.filter(function(t){return!!e.filter(t).length}):i.children,t.push(o)}),i.arrays.flatten2Levels(t)}},{key:"getSubcontainerConfigs",value:function(){return this.subcontainersConfig}},{key:"getSubcontainersByCoordinates",value:function(e){if(!this.hasSubcontainers())throw new Error("tried to retrieve subcontainers, when they are not present");var n=t(this,e);return n}},{key:"getSubcontainers",value:function(){return i.arrays.flatten2Levels(this.subcontainerList)}}]),o}(a),s=function(e){function t(e){_classCallCheck(this,t);var n=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return n.specialLayer=!0,n.size=e,n.selectable=!1,n}return _inherits(t,e),_createClass(t,[{key:"getSubcontainerArea",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{toGlobal:!0},t=e.toGlobal?this.toGlobal(new o.Point(0,0)):this;return{x:Math.round(t.x),y:Math.round(t.y),width:Math.round(this.size.width),height:Math.round(this.size.height)}}}]),t}(o.Container),c=function(e){function t(e){_classCallCheck(this,t);var n=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return n.specialLayer=!0,n.targetSize=e,n.selectable=!1,n}return _inherits(t,e),t}(o.Container);window.flatworld.mapLayers=window.flatworld.mapLayers||{},window.flatworld.mapLayers.MapLayer=a,window.flatworld.mapLayers.MapLayerParent=l,window.flatworld.mapLayers.MinimapLayer=c}();var _createClass=function(){function e(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(t,n,o){return n&&e(t.prototype,n),o&&e(t,o),t}}();!function(){var e=window.flatworld.mapLayers,t=window.flatworld.objects,n=window.flatworld.utils,o=function(){function o(){var i=arguments.length>0&&void 0!==arguments[0]?arguments[0]:n.general.requireParameter("MapDataManipulator","rules");_classCallCheck(this,o),this.rules=Array.isArray(i)?i:[i],this.classes={layer:Object.keys(e).map(function(t){return e[t]}),object:Object.keys(t).map(function(e){return t[e]})}}return _createClass(o,[{key:"filter",value:function(e){var t=this,n=void 0;return n=Array.isArray(e)?e.filter(function(e){return t._runRule(e)}):this._runRule(e)?[e]:[]}},{key:"addRule",value:function(e){this.rules.concat(e)}},{key:"getOnlyFiltersOf",value:function(){}},{key:"doesItFilter",value:function(e){return this.rules.some(function(t){return t.object===e})}},{key:"_runRule",value:function(e){var t=this,n=!0,o=void 0;return Object.keys(this.classes).forEach(function(n){var i=t.classes[n].filter(function(t){return e instanceof t});o=i.length?n:o}),this.rules.forEach(function(i){if("filter"===i.type){if(i.object!==o)return;"layer"===o?n=t._getObject(e,i):"object"===o&&(n=t._getObject(e,i))}}),n}},{key:"_getObject",value:function(e,t){var n=!1;if(Array.isArray(t.property))try{n=""+o.getPropertyWithArray(e,t.property,0)==""+t.value}catch(i){return!1}else n=e[t.property]===t.value;return n}}],[{key:"getPropertyWithArray",value:function(e,t,n){var i=t[n],r=e[i];return t[n+1]?o.getPropertyWithArray(r,t,++n):r}}]),o}();o.OBJECT_LAYER="layer",o.OBJECT_OBJECT="object",window.flatworld.MapDataManipulator=o}(),function(){function e(e,o){if(n)return n;if(!e||!o)throw new Error("UI-module requires UITheme and map object, This is a singleton class, so it's possible it should have been already called earlier");return n={},n.showSelections=function(t,n){var o=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},i=o.filters,r=o.UIThemeOptions;return i&&(t=i.filterObjects(t)),t=Array.isArray(t)?t:[t],1===t.length?e.highlightSelectedObject(t[0],n,r):t.length>1?e.showSelections(t,n,r):e.showSelections([])},n.showUnitMovement=function(n){var o=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},i=o.UIThemeOptions;return Array.isArray(n)||t.error("Array expected for showUnitMovement"),e.showUnitMovement(n,i)},n.extend=function(t){n[t]=function(){e[t]()}},n}var t=window.flatworld.log,n=void 0;window.flatworld.UI=e}();var _createClass=function(){function e(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(t,n,o){return n&&e(t.prototype,n),o&&e(t,o),t}}();!function(){var e=function(){function e(){_classCallCheck(this,e)}return _createClass(e,[{key:"retrieve",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[],n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{type:void 0,size:{width:0,height:0}},o=n.size,i=n.type,r=e.globalCoords,a=[];return t.length>0?(t.forEach(function(e){a=a.concat(e.children)}),o.width&&o.height||(a=filterChildren(r,a,i)),a):[]}}]),e}();window.flatworld.ObjectManager=e}();var _createClass=function(){function e(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(t,n,o){return n&&e(t.prototype,n),o&&e(t,o),t}}();!function(){function e(e){e.center=null,e.map=null}var t=window.flatworld_libraries.PIXI,n=window.flatworld,o=n.constants,i=n.utils,r=n.mapAPI,a=n.mapEvents,l=function(n){function i(t){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{x:0,y:0},o=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},r=o.data,a=void 0===r?null:r;_classCallCheck(this,i);var l=_possibleConstructorReturn(this,(i.__proto__||Object.getPrototypeOf(i)).call(this,t)),s={x:Math.round(n.x),y:Math.round(n.y)};return l.position.set(s.x,s.y),l.name="Objects_sprite_"+l.id,l.type="None",l.highlightable=!0,l.data=a,l.areaWidth=l.width,l.areaHeight=l.height,l["static"]=!0,l.minimapColor=16711680,l.coordinates={},e(l.coordinates),l}return _inherits(i,n),_createClass(i,[{key:"innerDraw",value:function(e,t){return this.fromFrame(this.currentFrame),this.x=e,this.y=t,this}},{key:"drawNewFrame",value:function(e,t,n){return this.currentFrame=n,this.innerDraw(e,t)}},{key:"getGraphicalArea",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{toGlobal:!0},n=e.toGlobal?this.toGlobal(new t.Point(0,0)):this;return{x:Math.round(n.x),y:Math.round(n.y),width:Math.round(this.width),height:Math.round(this.height)}}},{key:"clone",value:function(e){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{position:!1,anchor:!1,scale:!1},o=new t.Sprite;return o.texture=e.generateTexture(this),n.anchor&&o.anchor.set(this.anchor.x,this.anchor.y),n.position&&o.position.set(this.x,this.y),n.scale&&o.scale.set(this.scale.x,this.scale.y),Object.setPrototypeOf(o,this.constructor.prototype),o}},{key:"initializeCoordinates",value:function(t){e(this.coordinates),this.getMapCoordinates(t),this.getCenterCoordinates()}},{key:"getGlobalCoordinates",value:function(e){return this.toGlobal(e||o.ZERO_COORDINATES)}},{key:"getMapCoordinates",value:function(e){return this.coordinates.map=this.coordinates.map||e.getMapCoordinates(this),Object.assign({},this.coordinates.map)}},{key:"getCenterCoordinates",value:function(){return this.coordinates.center||(this.coordinates.center={x:this.width/2,y:this.height/2}),this.coordinates.center}}]),i}(t.Sprite),s=function(e){function t(e,n){var o=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},i=o.data,r=void 0===i?null:i;_classCallCheck(this,t);var a=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e,n,{data:r}));return a.name="DefaultTerrainObject",a.type="terrain",a.highlightable=!1,a}return _inherits(t,e),t}(l),c=function(e){function t(e,n){var o=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},i=o.data,r=void 0===i?null:i;_classCallCheck(this,t);var a=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e,n,{data:r}));return a.name="DefaultUnitObjects",a.type="unit",a.actions={},a}return _inherits(t,e),_createClass(t,[{key:"doAction",value:function(e){this.actions[e].forEach(function(e){e()})}},{key:"addActionType",value:function(e){this.actions[e]=this.actions[e]||[]}},{key:"addCallbackToAction",value:function(e,t){this.actions[e].push(t)}},{key:"dropShadow",value:function(){var e;return(e=i.effects).dropShadow.apply(e,arguments)}},{key:"move",value:function(e){a.publish("objectMove",this),r.post("objectMove",{id:this.id,from:{x:this.x,y:this.y},to:e})}}]),t}(l);window.flatworld.objects.ObjectSprite=l,window.flatworld.objects.ObjectSpriteTerrain=s,window.flatworld.objects.ObjectSpriteUnit=c}();var _createClass=function(){function e(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(t,n,o){return n&&e(t.prototype,n),o&&e(t,o),t}}();!function(){var e=window.flatworld_libraries.Q,t=window.flatworld_libraries.Howler,n=function(){function n(){_classCallCheck(this,n),this._allSounds={}}return _createClass(n,[{key:"add",value:function(e,n){var o=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{loop:!1,volume:1},i=o.loop,r=o.volume;return this._allSounds[e]={},this._allSounds[e]=new t({src:[].concat(n),autoplay:!1,loop:i,volume:r}),this._allSounds[e]}},{key:"remove",value:function(e){delete this._allSounds[e]}},{key:"play",value:function(t){var n=e.defer();this._allSounds[t]._onend=function(){n.resolve(!0)},this._allSounds[t].play()}},{key:"stop",value:function(e){this._allSounds[e].stop()}},{key:"fade",value:function(t,n,o,i){var r=e.defer(),a=function(){r.resolve(!0)};return this._allSounds[t].fade(n,o,i,a),r.promise}}]),n}();window.flatworld.Sound=n}(),function(){function e(){return t.create({initial:"statusQuo",events:[{name:"objectSelectDialog",from:["statusQuo","objectSelected"],to:"objectSelectDialogOpened"},{name:"objectSelect",from:["statusQuo","objectSelected","objectSelectDialogOpened"],to:"objectSelected"},{name:"normalize",from:["objectSelected","objectSelectDialogOpened"],to:"statusQuo"},{name:"objectOrder",from:"objectSelected",to:"animatingObject"},{name:"objectOrderEnd",from:"animatingObject",to:"objectSelected"},{name:"UIOpen",from:["statusQuo","objectSelected","objectSelectDialogOpened"],to:"mainUIOpened"},{name:"UIClose",from:"mainUIOpened",to:"statusQuo"}]})}var t=window.StateMachine;window.flatworld.mapStates=e()}(),function(){function e(){function e(){g=this.mapInstance;var e=f(),n=d();p=new l.Manager(this.mapInstance.canvas),y=new s(this.mapInstance.canvas),r.setDetector("fullSize",t().on,t().off),r.on("fullSize",v),r.setDetector("fullscreen",a().on,a().off),this.mapInstance.setPrototype("setFullScreen",function(){r.on("fullscreen",h)}),r.setDetector("zoom",c().on,c().off),r.setDetector("drag",u().on,u().off),r.setDetector("select",n.on,n.off),r.setDetector("order",e.on,e.off)}function t(){var e=void 0;return w.fullsize||(w.fullsize={on:function(t){e=t,window.addEventListener("resize",e)},off:function(){window.removeEventListener("resize",e)}}),w.fullsize}function a(){var e=void 0;return w.fullscreen?w.fullscreen:(w.fullscreen={on:function(t){e=t,window.addEventListener("fullscreen",e)},off:function(){window.removeEventListener("fullscreen",e)}},w.fullscreen)}function c(){var e=void 0;return w.zoom||(w.zoom={on:function(t){var n=new l.Pinch;e=t,p.add(n),p.on("pinch",e),y.wheel(e)},off:function(){p.on("pinch",e),y.unwheel(e)}}),w.zoom}function u(){var e=void 0;return w.drag||(w.drag={on:function(t){var n=new l.Pan({pointers:1,threshold:5,direction:l.DIRECTION_ALL});e=t,p.add(n),p.on("pan",e)},off:function(){p.off("pan",e)}}),w.drag}function d(){var e=void 0;return w.select||(w.select={on:function(t){var n=new l.Tap;e=t,p.add(n),p.on("tap",e)},off:function(){p.off("tap",e)}}),w.select}function f(){function e(e){if(o.mouse.isRightClick(e)||"press"===e.type)return!(!i.can("objectOrder")&&(g.isSupportedTouch||o.mouse.isRightClick(e)))&&void t(e)}var t=void 0;return w.order||(w.order={on:function(n){t=n;var o=new l.Press;p.add(o),p.on("press",e),g.canvas.addEventListener("mouseup",function(t){3===t.which&&e(t)},!0)},off:function(){p.off("press",e),g.canvas.removeEventListener("mouseup",e,!0)}}),w.order}function h(){o.resize.toggleFullScreen(),n.publish("mapResized"),v()}function v(){o.resize.resizePIXIRenderer(g.getRenderer(),g.drawOnNextTick.bind(g)),n.publish("mapResized")}var w={},p=void 0,y=void 0,g=void 0;return{init:e,toggleFullSize:t,toggleFullscreen:a,toggleZoom:c,toggleDrag:u,toggleSelect:d,toggleOrder:f,pluginName:"baseEventlisteners"}}var t=window.flatworld,n=t.mapEvents,o=t.utils,i=t.mapStates,r=t.eventListeners,a=window.flatworld_libraries,l=a.Hammer,s=a.Hamster;window.flatworld.extensions.baseEventlisteners=e()}(),function(){function e(){function e(){l=o(this.mapInstance),t.on("drag",l)}function o(e){var o=!1;return function(r){if(t.getActivityState("zoom"))return!1;var l=n.mouse.eventData.getHAMMERPointerCoords(r);return l.x=Math.round(l.x),l.y=Math.round(l.y),o?(r.isFinal===!0&&(o=!1),void i(r,e,l)):(a.setOffset({x:l.x,y:l.y}),void(o=!0))}}function i(e,t,n){var o=a.getOffset(),i={x:n.x-o.x,y:n.y-o.y};(i.x>0||i.y>0||i.x<0||i.y<0)&&t.moveMap(i),a.setOffset({x:n.x,y:n.y}),e.preventDefault()}function r(){function e(e){return n=e}function t(){return n}var n=void 0;return{setOffset:e,getOffset:t}}var a=r(),l=void 0;return{init:e,pluginName:"mapDrag",
_startDragListener:o}}var t=window.flatworld.eventListeners,n=window.flatworld.utils;window.flatworld.extensions.mapDrag=e()}(),function(){function e(){function e(){g=this.mapInstance,this.mapInstance.setPrototype("zoomIn",a),this.mapInstance.setPrototype("zoomOut",l),this.mapInstance.setPrototype("setZoomLimits",r),this.mapInstance.setPrototype("setZoomModifier",t),i.on("zoom",s)}function t(e){if(!(e>0||e<=.5))throw new Error("Wrong zoom modifier! (needs to be >0 and <=0.5, given:"+e);return b=e,this}function r(e,t){return m.farther=e,m.closer=t,this}function a(e){var t=this.getZoom(),n=!0;return h(this,t,Math.abs(e)||b,n)}function l(e){var t=this.getZoom(),n=!1;return e=e<0?e:-e,h(this,t,e||-b,n)}function s(e,n,o,i){n?c(e,n,o,i):e.pointers&&(p||(p=!0,t(.5*b)),u(e))}function c(e,t,n,o){var i=o,r=g.getZoom();e.preventDefault(),i>0?g.zoomIn()&&g.moveMap(f(r,!0)):i<0&&g.zoomOut()&&g.moveMap(f(r))}function u(e){var t=e.pointers,n=[{x:t[0].pageX,y:t[0].pageY},{x:t[1].pageX,y:t[1].pageY}],r=Math.abs(n[0].x-n[1].x),a=Math.abs(n[0].y-n[1].y);e.preventDefault();try{if(!w)return y={x:r,y:a},i.setActivityState("zoom",!0),void(w=!0);4!==e.eventType&&8!==e.eventType||(window.setTimeout(function(){i.setActivityState("zoom",!1)},v),w=!1),y.x+y.y<r+a?g.zoomIn()&&g.moveMap(f(g.getZoom(),!0)):g.zoomOut()&&g.moveMap(f(g.getZoom())),y={x:r,y:a}}catch(l){o("Error! ",l)}}function d(e,t){return!!(t&&e>m.closer||!t&&e<m.farther)}function f(e,t){var o=n.resize.getWindowSize(),i={x:o.x/2/e,y:o.y/2/e},r={x:i.x*(t?-b:b),y:i.y*(t?-b:b)};return r}function h(e,t,n,o){var i=void 0;return d(t,o)||(i=e.setZoom(n?t+n:t+b)),i}var v=40,w=!1,p=!1,y={},g=void 0,m={farther:.4,closer:2.5},b=.1;return{init:e,pluginName:"mapZoom"}}var t=window.flatworld,n=t.utils,o=t.log,i=t.eventListeners;window.flatworld.extensions.mapZoom=e()}(),window.flatworld.extensions.hexagons={},window.flatworld.extensions.hexagons.utils={},window.flatworld.extensions.hexagons.eventlisteners={},window.flatworld.extensions.hexagons.pathfinding={},window.flatworld.extensions.hexagons._tests={},function(){function e(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{x:0,y:0},n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},o=n.orientation,i=void 0===o?"horizontal":o;e||u.error("You need to pass radius as a parameter"),d=e,f=t,h=i}function t(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=e.radius,n=void 0===t?d:t,o=e.orientation,i=void 0===o?h:o,r="horizontal"===i?.5:0,a={x:n,y:n},l=[],s=2*Math.PI/6*r,c=a.x*Math.cos(s),u=a.y*Math.sin(s);l.push({x:c,y:u});for(var f=1;f<7;f++)s=2*Math.PI/6*(f+r),c=a.x*Math.cos(s),u=a.y*Math.sin(s),l.push({x:c,y:u});return l}function n(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=e.radius,n=void 0===t?d:t,o=e.floorNumbers,i=void 0===o||o,r=n*Math.sqrt(3);return r=i?Math.floor(r):r}function o(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=e.radius,n=void 0===t?d:t,o=e.floorNumbers,i=void 0===o||o,r=2*n;return r=i?Math.floor(r):r}function i(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=e.radius,n=void 0===t?d:t;return o(n)-n/2}function r(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{x:0,y:0},o=e.map(function(e){return{x:e.x+n.x,y:e.y+n.y}});return c(t,o)}function a(e){for(var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},i=t.radius,r=void 0===i?d:i,a=t.orientation,l=void 0===a?h:a,s=e.rows,c=e.columns,u=[],f=n(r),v=o(r)-r/2,w="horizontal"===l?v:f,p="horizontal"===l?f:v,y=0;s>y;y++)for(var g=0;c>g;g++)u.push({x:Math.round(g*p+("horizontal"!==l||0!==y&&y%2!==0?-f/2:0)),y:y*w});return u}function l(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},o=t.startingPoint,r=void 0===o?f:o,a={x:Math.floor((e.x-r.x)/n()),y:Math.floor((e.y-r.y)/i())};return a.x-=Math.floor(e.y/(2*i())),a}function s(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},o=t.startingPoint,r=void 0===o?f:o,a={x:Math.floor(e.x*n()+r.x),y:Math.floor(e.y*i()+r.y)};return a.x+=Math.floor(e.y*(n()/2)),a}function c(e,t){for(var n=e.x,o=e.y,i=!1,r=void 0,a=void 0,l=void 0,s=void 0,c=void 0,u=0,d=t.length-1;u<t.length;d=u++)r=t[u].x,l=t[u].y,a=t[d].x,s=t[d].y,c=l>o!=s>o&&n<(a-r)*(o-l)/(s-l)+r,c&&(i=!i);return i}var u=window.flatworld.log;window.flatworld.extensions.hexagons.utils.init=e,window.flatworld.extensions.hexagons.utils.createHexagonGridCoordinates=a,window.flatworld.extensions.hexagons.utils.getHexagonPoints=t,window.flatworld.extensions.hexagons.utils.calcShortDiagonal=n,window.flatworld.extensions.hexagons.utils.calcLongDiagonal=o,window.flatworld.extensions.hexagons.utils.calcSpecialDistance=i,window.flatworld.extensions.hexagons.utils.hexaHitTest=r,window.flatworld.extensions.hexagons.utils.coordinatesToIndexes=l,window.flatworld.extensions.hexagons.utils.indexesToCoordinates=s;var d=void 0,f=void 0,h=void 0}(),function(){function e(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},i=t.orientation,r=void 0===i?"horizontal":i;if("horizontal"!==r)throw new Error("Nothing else than horizontal supported so far!");var a=n(e);return new o.Polygon(a)}function t(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},i=t.color,r=void 0===i?16711680:i,a=t.isFlatTop,l=void 0!==a&&a,s=new o.Graphics,c=n(e,l);return s.beginFill(r,1),s.drawPolygon(c,l),s.endFill(),s}function n(e){return i({radius:e}).map(function(e){return new o.Point(e.x,e.y)})}var o=window.flatworld_libraries.PIXI,i=window.flatworld.extensions.hexagons.utils.getHexagonPoints;window.flatworld.extensions.hexagons.utils.createHexagon=e,window.flatworld.extensions.hexagons.utils.createVisibleHexagon=t}(),function(){function e(e,o){if(!e)throw new Error("eventlisteners initialization requires flatworld instance as a parameter");return y=e,g=s(),u.on("select",t),u.on("order",n),p=o||p,!0}function t(e){var t=a.mouse.eventData.getHAMMERPointerCoords(e),n={allData:function(e){return e.data.typeData}};d.objectSelect();var o=y.getObjectsUnderArea(t,{filters:v});return o=a.dataManipulation.mapObjectsToArray(o),o=a.dataManipulation.flattenArrayBy1Level(o),o.length?(y.currentlySelectedObjects=o,l.publish("objectsSelected",o),g.showSelections(o,n),void y.drawOnNextTick()):(y.currentlySelectedObjects=void 0,f.debug("No objects found for selection!"),void g.showSelections([]))}function n(e){try{if(d.objectOrder(),!y.currentlySelectedObjects)throw"No objects selected for orders!";if(y.currentlySelectedObjects.length>1)throw"the selected object is only supported to be one atm."+JSON.stringify(y.currentlySelectedObjects[0]);var t=y.currentlySelectedObjects[0],n=t.getMapCoordinates(),i=a.mouse.eventData.getGlobalCoordinates(e,y.isSupportedTouch),r=y.getObjectsUnderArea(i,{filters:w});if(!r.length)throw"No terrain objects found for destination!";var s=h.utils.coordinatesToIndexes(n),c={x:r[0].getMapCoordinates().x,y:r[0].getMapCoordinates().y},u=h.utils.coordinatesToIndexes(c),v=void 0;try{var p=t.data.typeData.move;v=h.pathfinding.findPath(s,u,+y.getMapsize().x,+y.getMapsize().y,+p,o),v=v.map(function(e){return h.utils.indexesToCoordinates(e)})}catch(e){throw!v||v.length<1?e.message="the destination was farther than the given maximum distance":e.message+=", EXTRA INFO: start and end point are same, destination is blocked, unit could not reach the destination or something else happened",e}t.move(v[v.length-1]),l.publish("objectMoves",t),g.showUnitMovement(v),d.objectOrderEnd(),y.drawOnNextTick()}catch(e){return d.objectOrderEnd(),void f.debug(e)}}function o(e){var t=y.hexagonIndexes[e.x]&&y.hexagonIndexes[e.x][e.y],n=p(t,y.currentlySelectedObjects[0],e);if(!t)return-1;if(n&&i(n))return n;if(n&&!i(n))throw new Error("weight callback has to return an integer");return-1}function i(e){return e===Math.floor(e)&&isFinite(e)}var r=window.flatworld,a=r.utils,l=r.mapEvents,s=r.UI,c=r.MapDataManipulator,u=r.eventListeners,d=r.mapStates,f=r.log,h=window.flatworld.extensions.hexagons;window.flatworld.extensions.hexagons.setupHexagonClick=e,window.flatworld.extensions.hexagons._tests._isBlocked=o,window.flatworld.extensions.hexagons._tests._orderListener=n,window.flatworld.extensions.hexagons._tests._tapListener=t;var v=new c({type:"filter",object:"layer",property:"name",value:"unitLayer"}),w=new c({type:"filter",object:"layer",property:"name",value:"terrainLayer"}),p=function(){return 0},y=void 0,g=void 0}();var _slicedToArray=function(){function e(e,t){var n=[],o=!0,i=!1,r=void 0;try{for(var a,l=e[Symbol.iterator]();!(o=(a=l.next()).done)&&(n.push(a.value),!t||n.length!==t);o=!0);}catch(s){i=!0,r=s}finally{try{!o&&l["return"]&&l["return"]()}finally{if(i)throw r}}return n}return function(t,n){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return e(t,n);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),_createClass=function(){function e(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(t,n,o){return n&&e(t.prototype,n),o&&e(t,o),t}}();!function(){function e(e,n,s,c,u,d){function f(){function e(e){var t=(e.x-v+s)*c+(e.y-w);if(t<0)throw new Error("negative key: "+t);return o[t]?o[t]<=e.time||(o[t]=e.time,!1):(o[t]=e.time,!1)}var o=[],f=n&&i(n.x-v,n.y-w,b),h=new l,p={x:v,y:w,time:0,prev:null};e(p),h.push(p,0);for(var y=null,m=u;h.length;){g++;var x=h.pop(),S=m-x.time,O=!n||S<1?1:i(n.x-x.x,n.y-x.y,b);if(!(O>S))for(var C=b?r:a,M=C.length;M-- >0;){var _=x.x+C[M].x,k=x.y+C[M].y,j={x:_,y:k},I=d(j,x);if(!(I<0||x.time+I>u)){if(j.time=x.time+I,j.prev=x,n&&_===n.x&&k===n.y){y=j,m=j.time-1;break}if(!e(j)){var T=j.time+(n?i(n.x-_,n.y-k,b)-f:0);h.push(j,T)}}}}return n?y&&t(y):o.reduce(function(e,t,n){var o=n%c,i=(n-o)/c-s;return(i||o)&&e.push({x:i+v,y:o+w,time:t}),e},[])}function h(){if([v,w].concat(n?[n.x,n.y]:[]).concat([s,c,u]).forEach(function(e,t){if(!o(e))throw new Error("argument #"+t+" must be an integer: "+e)}),u<1)throw new Error("maxTime must be at least 1: "+u);if(n&&v===n.x&&w===n.y)throw new Error("starting and destination points must be different: "+v+", "+w)}var v=e.x,w=e.y,p=arguments.length>6&&void 0!==arguments[6]?arguments[6]:null,y=arguments.length>7&&void 0!==arguments[7]&&arguments[7];h();var g=0,m=Date.now(),b=null===p,x=f();if(y){var S;(S=console).log.apply(S,_toConsumableArray(n?[]:["reachable: "]).concat([Date.now()-m+"ms",x&&x.length,g+" oper",u+" cells",g/u/Math.log(u)+" coeff"]))}return x}function t(e){var t=e,n=[];do n.push(t),t=t.prev;while(t);return n.reverse()}function n(e,t,o){var i=Math.floor((t+o)/2),r=e(i);return r<0?i>t?n(e,t,i):[t,!1]:r>0?i+1<o?n(e,i+1,o):[o,!1]:[i,!0]}function o(e){return e===Math.floor(e)&&isFinite(e)}function i(e,t,n){return n?e>0&&t>0?e+t:e<0&&t<0?-e-t:Math.max(Math.abs(e),Math.abs(t)):Math.abs(e)+Math.abs(t)}window.flatworld.utils.findPath=e;var r=[{x:0,y:1},{x:-1,y:1},{x:1,y:0},{x:1,y:-1},{x:-1,y:0},{x:0,y:-1}],a=[{x:0,y:1},{x:1,y:0},{x:-1,y:0},{x:0,y:-1}],l=function(){function e(){_classCallCheck(this,e),this.items=[]}return _createClass(e,[{key:"pop",value:function(){var e=this.items[this.items.length-1].stack,t=e.pop();return e.length||this.items.pop(),t}},{key:"push",value:function(e,t){var o=this,i=this.items.length?n(function(e){return o.items[e].loss-t},0,this.items.length):[0,!1],r=_slicedToArray(i,2),a=r[0],l=r[1];if(l)this.items[a].stack.push(e);else{var s={stack:[e],loss:t};this.items.splice(a,0,s)}}},{key:"length",get:function(){return this.items.length}}]),e}();window.flatworld.extensions.hexagons.pathfinding.findPath=e}();var _createClass=function(){function e(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(t,n,o){return n&&e(t.prototype,n),o&&e(t,o),t}}();!function(){function e(e){if(!e)throw new Error("Need radius!");var n=Math.round(a(e)),o=Math.round(l(e)),i=Math.round(e);this.anchor.set(.5,.5),this.areaHeight=this.HEIGHT=n,this.areaWidth=this.WIDTH=o,this.SIDE=i,this.ROW_HEIGHT=Math.round(.75*n),this.hitArea=t(e),this.hitTest=function(e){var t=this.toLocal(new c.Point(e.x,e.y));return this.hitArea.contains(t.x*this.scale.x,t.y*this.scale.y)}}function t(e){return u||(u=s(e)),u}var n=window.flatworld.objects,o=n.ObjectSpriteTerrain,i=n.ObjectSpriteUnit,r=window.flatworld.extensions.hexagons.utils,a=r.calcLongDiagonal,l=r.calcShortDiagonal,s=r.createHexagon,c=window.flatworld_libraries.PIXI,u=void 0,d=function(t){function n(t){var o=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{x:0,y:0},i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},r=i.data,a=i.radius,l=i.minimapColor,s=i.minimapShape;_classCallCheck(this,n);var c=_possibleConstructorReturn(this,(n.__proto__||Object.getPrototypeOf(n)).call(this,t,o,{data:r}));return c.name="DefaultTerrainObject_hexa",c.minimapColor=l,c.minimapShape=s,e.call(c,a),c}return _inherits(n,t),_createClass(n,[{key:"getCenterCoordinates",value:function(){return this.coordinates.center||(this.coordinates.center={x:this.WIDTH/2,y:this.HEIGHT/2}),this.coordinates.center}}]),n}(o),f=function(t){function n(t){var o=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{x:0,y:0},i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},r=i.data,a=i.radius,l=i.minimapColor,s=i.minimapShape;_classCallCheck(this,n);var c=_possibleConstructorReturn(this,(n.__proto__||Object.getPrototypeOf(n)).call(this,t,o,{data:r}));return c.name="DefaultUnitObjects_hexa",c.minimapColor=l,c.minimapShape=s,c["static"]=!1,e.call(c,a),c}return _inherits(n,t),_createClass(n,[{key:"getCenterCoordinates",value:function(){return this.coordinates.center||(this.coordinates.center={x:this.WIDTH/2,y:this.HEIGHT/2}),this.coordinates.center}}]),n}(i);window.flatworld.extensions.hexagons.objects={ObjectHexaTerrain:d,ObjectHexaUnit:f}}(),function(){function e(){function e(e){var o=this;if(!e.isBlocked)throw new Error("hexagon pathFinding plugin requires cb and filter properties");return this.mapInstance.hexagonIndexes=t(this.mapInstance.getMovableLayer(),function(){return o.mapInstance.allMapObjects.terrainLayer}),n(this.mapInstance,e.isBlocked),Promise.resolve()}function n(e,t){return o(e,t)}return{init:e,pluginName:"selectHexagonObject"}}function t(e,t){var n={},o=t(),r=void 0;return o.forEach(function(e){var t=e.getMapCoordinates();r=i.coordinatesToIndexes(t),n[r.x]=n[r.x]||{},n[r.x][r.y]=e}),n}var n=window.flatworld.extensions.hexagons,o=n.setupHexagonClick,i=n.utils;window.flatworld.extensions.hexagons.selectHexagonObject=e(),window.flatworld.extensions.hexagons._tests.createHexagonDataStructure=t}(),function(){function e(){function e(){return x=this.mapInstance,o(this.mapInstance),r(),this.mapInstance.drawOnNextTick(),v&&(window.FlaTWorld_mapMovement_subCheck=function(){x.getPrimaryLayers().forEach(function(e){var t=e.getSubcontainers(),n=t.filter(function(e){return e.visible}),o=t.filter(function(e){return!e.visible}),i=n.reduce(function(e,t){e+t.x+""});window.flatworld.log.debug("visible subcontainers: "+n.length+", "+i+"\n\ninvisible: "+o.length)})},window.FlaTWorld_mapMovement_deactivate=function(){x.getPrimaryLayers().forEach(function(e){e.getSubcontainers().forEach(function(e){e.visible=!1})})}),Promise.resolve()}function o(e){m=s(!0,w),b=c(m),e.getPrimaryLayers().forEach(function(e){e.getSubcontainers().forEach(function(e){e.visible=!a(e,m)})})}function i(){function e(){m=s(!0,w),l(m,x.getPrimaryLayers())}return!g.processing&&(g.processing=!0,void window.setTimeout(e(),p))}function r(){function e(){i()}function n(){b=c(m),i()}function o(){b=c(m),i()}t.subscribe("mapMoved",e),t.subscribe("mapResized",n),t.subscribe("mapZoomed",o)}function a(e,t){var n=e.getSubcontainerArea({toGlobal:!1}),o=!d(n,t);return o}function l(e,t){var o=u(e),i=[],r=void 0;t=n.chunkArray(t,w),r=t.map(function(e){var t=window.Q.defer();return window.setTimeout(function(){var n=e.map(function(e){return e.getSubcontainersByCoordinates(o)});i=i.concat(n),t.resolve(i)}),t.promise}),r=window.Q.all(r).then(function(){i=n.flatten2Levels(i);var t=n.chunkArray(i,y),o=t.map(function(t){var n=window.Q.defer();return window.setTimeout(function(){n.resolve(t.filter(function(t){return t.visible=!a(t,e)}))}),n.promise});return o}),window.Q.all(r).then(function(){g.processing=!1,x.drawOnNextTick()}).then(null,function(e){window.flatworld.log.debug(e)})}function s(){var e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0],t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:2;return x.getViewportArea(e,t)}function c(e){return f(e,{zoom:x.getZoom()})}function u(e){if(!b)throw new Error("getViewportWithOffset requires module variable offsetSize to have been set");return{x:Math.round(e.x-b),y:Math.round(e.y-b),width:Math.round(e.width+2*b),height:Math.round(e.height+2*b)}}function d(e,t){return e.x<=t.x+t.width&&t.x<=e.x+e.width&&e.y<=t.y+t.height&&t.y<=e.y+e.height}function f(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{zoom:1};return Math.abs(e.width/t.zoom*w)}function h(e){this.mapInstance=x=e}var v=arguments.length>0&&void 0!==arguments[0]&&arguments[0],w=.2,p=20,y=40,g={},m=void 0,b=void 0,x=void 0;return{init:e,pluginName:"mapMovement",addAll:o,check:i,startEventListeners:r,_testObject:{isObjectOutsideViewport:a,checkAndSetSubcontainers:l,getViewportWithOffset:u,testRectangleIntersect:d,_setMap:h,setupOffsetSize:c}}}var t=window.flatworld.mapEvents,n=window.flatworld.generalUtils.arrays;window.flatworld.extensions.mapMovement=e()}(),window.flatworld.extensions.minimaps={},function(){function e(){function e(){return S=new o.Manager(this.mapInstance.minimapCanvas),this.mapInstance.initMinimap=t,b=this.mapInstance.getMinimapLayer(),Promise.resolve()}function t(e,t,n,o,a,l){var s=arguments.length>6&&void 0!==arguments[6]?arguments[6]:{},f=s.xPadding,h=void 0===f?10:f,v=s.yPadding,y=void 0===v?10:v;return g=h,m=y,b.minimapSize=t,O=a,i(e),c(n),u(o),p(b.minimapSize.x,b.minimapSize.y,b.minimapSize.width,b.minimapSize.height),d(),w(),x=l,b.addChild(x),r.publish("minimapInitialized",b),b}function i(e){b.addChild(e)}function c(e){var t=new l({type:"filter",object:"layer",property:"zoomLayer",value:!0}),n=y();_.getAllObjects({filters:t}).forEach(function(t){n.addChild(e(t))}),n.cacheAsBitmap=!0,b.addChild(n)}function u(e){var t=new l({type:"filter",object:"object",property:"static",value:!1});M=y(),_.getAllObjects({filters:t}).forEach(function(t){M.addChild(e(t))}),M.cacheAsBitmap=!0,b.addChild(M)}function d(){r.subscribe("mapMoved",f),r.subscribe("mapZoomed",h),r.subscribe("minimapClicked",v)}function f(){if(!(C-Date.now()>-5)){var e=O(_.getMovableLayer(),!0);x.x=e.x,x.y=e.y,_.drawOnNextTick()}}function h(){x.scale.x+=.1,x.scale.y=.1}function v(e){var t=s.mouse.eventData.getHAMMERPointerCoords(e),o=new n.Point(e.srcEvent.layerX,e.srcEvent.layerY);t=s.mouse.coordinatesFromGlobalToRelative(t,_.minimapCanvas),C=Date.now(),t.x-=Math.round(x.width/2),t.y-=Math.round(x.height/2),o=O(t,!0),x.x=o.x,x.y=o.y,o=O(t,!1),_.moveMap(o,{absolute:!0,noEvent:!0}),_.drawOnNextTick()}function w(){var e=void 0,t={on:function(t){var n=new o.Tap;e=t,S.add(n),S.on("tap",e)},off:function(){S.on("tap",e)}};a.setDetector("minimapClicked",t.on,t.off),a.on("minimapClicked",v)}function p(e,t,o,i){var r=_.getRenderer("minimap");b.position=new n.Point(e,t),r.autoResize=!0,r.resize(o+2*g,i+2*m),_.drawOnNextTick()}function y(){var e=new n.Container;return e.x=g,e.y=m,e}var g=0,m=0,b=void 0,x=void 0,S=void 0,O=void 0,C=void 0,M=void 0,_=void 0;return{init:e,pluginName:"pixelizedMinimap",initMinimap:t,_testObject:{}}}var t=window.flatworld_libraries,n=t.PIXI,o=t.Hammer,i=window.flatworld.mapEvents,r=i.mapEvents,a=i.eventListeners,l=i.MapDataManipulator,s=i.utils;window.flatworld.extensions.minimaps.pixelizedMinimap=e()}(),function(){function e(){function e(e){s=e,s.initMinimap=i,o=s.getMinimapLayer()}function i(e,n,i){var s=e.width,u=e.height,d=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{},f=d.x,h=void 0===f?0:f,v=d.y,w=void 0===v?0:v;o.targetSize.x=s,o.targetSize.y=u,r(n),a(i),l(Math.round(h),Math.round(w)),t.publish("minimapInitialized",c)}function r(e){var t=n.Texture.fromFrame(e),o=new n.Sprite(t);s.getMinimapLayer().addChild(o)}function a(e){e.width=o.targetSize.x/s.width,e.height=o.targetSize.y/s.height,o.addChild(e)}function l(e){var t=e.x,o=e.y;s.getMinimapLayer().position(new n.Point(t,o))}var s=void 0,c=void 0;return{init:e,pluginName:"scaledMinimap",_testObject:{}}}var t=window.flatworld.mapEvents,n=window.flatworld_libraries.PIXI;window.flatworld.extensions.minimaps.scaledMinimap=e();var o=void 0}(),window.flatworld.extensions.fogOfWars={},function(){function e(){function e(e){if(!e.cb&&!e.filter)throw new Error("SimpleFogOfWar plugin requires cb and filter properties");return k=this.mapInstance,m=this.mapInstance.getMovableLayer(),b=this.mapInstance.getZoomLayer(),x=this.mapInstance.getRenderer(),O=this.mapInstance.createSpecialLayer("FoWStageMaskLayer"),S=this.mapInstance.createSpecialLayer("FoWMovableMaskLayer"),S.x=m.x,S.y=m.y,n(this.mapInstance,e.cb,e.filter),Promise.resolve()}function n(e,t,n){var o=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{};_=o.color||2236962,C=t;var r=n();M=e.getPrimaryLayers({filters:r}).map(function(e){return e.getObjects(r)}),M=i.arrays.flatten2Levels(M),v(),a(),w()}function a(){var e=d(C);if(h(g),e.length>0){var t;(t=S).addChild.apply(t,_toConsumableArray(e))}u(),b.mask=p,k.registerPreRenderer("renderFoW",s)}function l(){x.render(O,y,!0,null,!1),p.texture=y}function s(){S.position=m.position,l()}function c(){O.scale.x=k.getZoom(),O.scale.y=k.getZoom(),v(),l()}function u(){v(),l()}function d(e){return M.map(function(t){return e(f(t))})}function f(e){var n=e.toGlobal(new t.Point(0,0));return n.x=Math.round(n.x),n.y=Math.round(n.y),n.anchor=e.anchor,n.pivot=e.pivot,n.scale=k.getZoom(),n}function h(){S.children&&S.removeChildren(),O.children&&O.removeChildren(),O.addChild(g),O.addChild(S)}function v(){var e={x:-100,y:-100,width:x.width+200+x.width/k.getZoom(),height:x.height+200+x.height/k.getZoom()};g.clear(),g.beginFill(_),g.drawRect(e.x,e.y,e.width,e.height),g.endFill()}function w(){o.subscribe("mapResized",u),o.subscribe("mapZoomed",c)}var p=new t.Sprite(t.Texture.EMPTY),y=new t.RenderTexture(new t.BaseRenderTexture(r.getWindowSize().x,r.getWindowSize().y)),g=new t.Graphics,m=void 0,b=void 0,x=void 0,S=void 0,O=void 0,C=void 0,M=void 0,_=void 0,k=void 0;return{init:e,pluginName:"simpleFogOfWar",activateFogOfWar:n,refreshFoW:l,getFoWObjectArray:d,calculateCorrectCoordinates:f,FOR_TESTS:{setObjectsForFoW:function(e){return M=e}}}}var t=window.flatworld_libraries.PIXI,n=window.flatworld,o=n.mapEvents,i=n.generalUtils,r=window.flatworld.utils.resize;window.flatworld.extensions.fogOfWars.simpleFogOfWar=e()}(),window.flatworld.UIs=window.flatworld.UIs||{},window.flatworld.UIs["default"]={},window.flatworld.UIs["default"].utils={},window.flatworld.UIs["default"].layout={},function(){window.flatworld.UIs["default"].utils.drawShapes=function(){function e(e,t,n,o,i,r,a,l,s){function c(e,t,n,o,i,r,a,l){var s;switch(t=+t,n=+n,o=+o,i=+i,r=+r,a=+a,e.beginStroke("#F00").moveTo(t,n).lineTo(o,i).lineTo(r,a),l){case 0:s=Math.sqrt((r-t)*(r-t)+(a-n)*(a-n)),e.arcTo(o,i,t,n,.55*s),e.fill();break;case 1:e.beginStroke("#F00").moveTo(t,n).lineTo(o,i).lineTo(r,a).lineTo(t,n).fill();break;case 2:break;case 3:var c=(t+o+r)/3,u=(n+i+a)/3;e.beginFill().quadraticCurveTo(c,u,t,n);break;case 4:var d,f,h,v,w=5;if(r===t)s=a-n,d=(o+t)/2,h=(o+t)/2,f=i+s/w,v=i-s/w;else{s=Math.sqrt((r-t)*(r-t)+(a-n)*(a-n));var p=(t+r)/2,y=(n+a)/2,g=(p+o)/2,m=(y+i)/2,b=(a-n)/(r-t),x=s/(2*Math.sqrt(b*b+1))/w,S=b*x;d=g-x,f=m-S,h=g+x,v=m+S}e.bezierCurveTo(d,f,h,v,t,n),e.fill()}}var u,d,f,h,v,w,p=e.graphics,y="#000";"string"==typeof t&&(t=parseInt(t,10)),"string"==typeof n&&(n=parseInt(n,10)),"string"==typeof o&&(o=parseInt(o,10)),"string"==typeof i&&(i=parseInt(i,10)),r="undefined"!=typeof r?r:3,a="undefined"!=typeof a?a:1,l="undefined"!=typeof l?l:Math.PI/8,s="undefined"!=typeof s?s:10;var g,m,b,x,S="function"!=typeof r?c:r,O=Math.sqrt((o-t)*(o-t)+(i-n)*(i-n)),C=(O-s/3)/O;1&a?(g=Math.round(t+(o-t)*C),m=Math.round(n+(i-n)*C)):(g=o,m=i),2&a?(b=t+(o-t)*(1-C),x=n+(i-n)*(1-C)):(b=t,x=n),p.beginStroke(y).moveTo(b,x).lineTo(g,m);var M=Math.atan2(i-n,o-t),_=Math.abs(s/Math.cos(l));return 1&a&&(u=M+Math.PI+l,d=o+Math.cos(u)*_,f=i+Math.sin(u)*_,h=M+Math.PI-l,v=o+Math.cos(h)*_,w=i+Math.sin(h)*_,S(p,d,f,o,i,v,w,r)),2&a&&(u=M+l,d=t+Math.cos(u)*_,f=n+Math.sin(u)*_,h=M-l,v=t+Math.cos(h)*_,w=n+Math.sin(h)*_,S(p,d,f,t,n,v,w,r)),!0}function t(t,n,o,i,r,a,l,s,c,u,d){var f,h,v,w,p;s="undefined"!=typeof s?s:3,c="undefined"!=typeof c?c:1,u="undefined"!=typeof u?u:Math.PI/8,d="undefined"!=typeof d?d:10,t.beginPath(),t.arc(n,o,i,r,a,l),t.stroke(),t.strokeStyle="rgba(0,0,0,0)",1&c&&(f=Math.cos(r)*i+n,h=Math.sin(r)*i+o,v=Math.atan2(n-f,h-o),l?(w=f+10*Math.cos(v),p=h+10*Math.sin(v)):(w=f-10*Math.cos(v),p=h-10*Math.sin(v)),e(t,f,h,w,p,s,2,u,d)),2&c&&(f=Math.cos(a)*i+n,h=Math.sin(a)*i+o,v=Math.atan2(n-f,h-o),l?(w=f-10*Math.cos(v),p=h-10*Math.sin(v)):(w=f+10*Math.cos(v),p=h+10*Math.sin(v)),e(t,f,h,w,p,s,2,u,d))}function n(e,t,n){var o=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{color:"#000000",style:5},i=o.color,r=o.style;return e.lineStyle(r,i),e.moveTo(t.x,t.y),e.lineTo(n.x,n.y),e}return{normal:e,arced:t,line:n}}()}(),function(){var e=window.flatworld_libraries.Handlebars;window.flatworld.UIs=window.flatworld.UIs||{},window.flatworld.UIs["default"]=window.flatworld.UIs["default"]||{},window.flatworld.UIs["default"].templates={multiSelection:e.compile("\n      <span style='font-size:200%;display:block;margin-bottom:20px;'>\n        {{title}}\n      </span>\n      <ul>\n        {{#each objects}}\n        <li>\n          {{this.data.typeData.name}}\n        </li>\n        {{/each}}\n      </ul>"),singleSelection:e.compile("\n      <span style='font-size:200%;display:block;margin-bottom:20px;'>\n        {{title}}\n      </span>\n      <ul>\n        <li>\n          {{object.name}}\n        </li>\n      </ul>")}}();var _createClass=function(){function e(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(t,n,o){return n&&e(t.prototype,n),o&&e(t,o),t}}();!function(){function e(e){if(!c[e]){var t=document.querySelector(s[e]);c[e]=t}return c[e]}var t=window.flatworld_libraries.PIXI,n=window.flatworld.UIs["default"].templates,o=window.flatworld.extensions.hexagons.utils.createVisibleHexagon,i=window.flatworld.UIs["default"].utils.drawShapes,r=window.flatworld.log,a="movementArrow",l=void 0,s=void 0,c={},u=function(){function c(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},o=n.radius,i=void 0===o?71:o,r=n.styles,a=void 0===r?"#F0F0F0":r,u=n.elements;_classCallCheck(this,c),this.RADIUS=i,s=u,l=this.addStyleElement();var d="\n        "+s.select+" {\n          z-index: 9999;\n          opacity: 0.9;\n          position: fixed;\n          left: 0px;\n          bottom: 0px;\n          background-color: brown;\n          border: 1px solid rgb(255, 186, 148);;\n          border-bottom: 0px;\n          padding:15px;\n          margin-left:10px;\n        }";this.addCSSRulesToScriptTag(l,d),this.FTW=t,this.modal=e||document.getElementById("dialog_select"),this.styles=a}return _createClass(c,[{key:"setFlatworld",value:function(e){this.FTW=e}},{key:"getTemplates",value:function(){return n}},{key:"showSelections",value:function(t){var o=this,i=this.FTW.drawOnNextTick.bind(this.FTW),a=this.FTW.getMovableLayer(),l=void 0;l=t&&t.length>1?function(){o.modal.innerHTML=n.multiSelection({title:"Objects",objects:t}),o.showModal(o.modal,s),e("select").style.display="block"}:t&&1===t.length?function(){o.highlightSelectedObject(t[0])}:function(){a.deleteUIObjects(),i(),r.debug("Error occured selecting the objects on this coordinates! Nothing found")},e("select").style.display="none",l()}},{key:"highlightSelectedObject",value:function(t,o){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{shadow:{color:"0x0000",distance:5,alpha:.55,angle:45,blur:5}},r=i.shadow,a=o.allData(t),l=this._highlightSelectedObject(t,this.FTW.getRenderer());return this.modal.innerHTML=n.singleSelection({title:"Selected",object:{name:a.name}}),this.showModal(this.modal,s),l.dropShadow({color:r.color,distance:r.distance,alpha:r.alpha,angle:r.angle,blur:r.blur}),this.FTW.drawOnNextTick(),e("select").style.display="block",l}},{key:"showUnitMovement",value:function(e){var t=this;if(!Array.isArray(e))throw new Error("showUnitMovement demands path array!");var n=[],o=void 0;this.FTW.removeUIObject(this.FTW.layerTypes.movableType.id,a),e.forEach(function(e,i){return 0===i?void(o=e):(n.push(t._createArrow(o,e)),void(o=e))}),this.FTW.addUIObject(this.FTW.layerTypes.movableType.id,n,a),this.FTW.drawOnNextTick()}},{key:"_highlightSelectedObject",value:function(e,n){var o=this.FTW.getMovableLayer(),i=e.clone(n,{anchor:!0,scale:!0}),r=e.toGlobal(new t.Point(0,0));return r=o.toLocal(r),this.createHighlight(i,{coords:r}),i}},{key:"_createArrow",value:function(e,n){return i.line(new t.Graphics,e,n)}},{key:"createHighlight",value:function(e){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{coords:new t.Point(0,0)},i="unit highlight",r=this.FTW.getMovableLayer(),a=new this.FTW.createSpecialLayer("UILayer",{toLayer:r}),l={x:Number(e.x),y:Number(e.y)},s=o(this.RADIUS,{color:"#F0F0F0"});s.position.set(l.x,l.y),s.alpha=.5,a.addChild(s),a.addChild(e),a.position=n.coords,this.FTW.removeUIObject(this.FTW.layerTypes.movableType.id),this.FTW.addUIObject(this.FTW.layerTypes.movableType.id,a,i)}},{key:"addCSSRulesToScriptTag",value:function(e,t){e.insertRule(t,0)}},{key:"addStyleElement",value:function(){var e=document.createElement("style");return e.appendChild(document.createTextNode("")),document.head.appendChild(e),e.sheet}},{key:"showModal",value:function(e,t){e.classList.add(t.select)}}]),c}();window.flatworld.UIs["default"].init=u}();var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},_createClass=function(){function e(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(t,n,o){return n&&e(t.prototype,n),o&&e(t,o),t}}();!function(){var e=window.flatworld_libraries,t=e.Q,n=e.PIXI,o=window.flatworld,i=o.mapLayers,r=o.ObjectManager,a=o.mapEvents,l=o.generalUtils,s=o.log,c=o.utils,u=o.constants,d=0,f=1,h=2,v={},w={},p=!1,y=[],g=void 0,m=void 0,b=void 0,x=void 0,S=void 0,O=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,o=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},a=o.bounds,s=void 0===a?{width:0,height:0}:a,w=o.mapSize,p=void 0===w?{x:0,y:0}:w,y=o.rendererOptions,O=void 0===y?{autoResize:!0,antialias:!1}:y,C=o.minimapCanvas,M=o.subcontainers,_=void 0===M?{width:100,height:100,maxDetectionOffset:0}:M,k=o.trackFPSCB,j=void 0!==k&&k,I=o.defaultScaleMode,T=void 0===I?n.SCALE_MODES.DEFAULT:I,L=arguments.length>2&&void 0!==arguments[2]&&arguments[2];if(_classCallCheck(this,e),!t)throw new Error(this.constructor.name+" needs canvas element!");"string"==typeof t&&(t=document.querySelector(t)),t.innerHTML="",O.view=t,v.main=new n.WebGLRenderer(s.width,s.height,O),v.main.getResponsibleLayer=this.getZoomLayer,C&&(v.minimap=C?new n.WebGLRenderer(0,0,{view:C,autoResize:!0}):void 0,v.minimap.plugins.interaction.destroy(),v.minimap.getResponsibleLayer=this.getMinimapLayer),v.main.plugins.interaction.destroy(),S=i.MapLayerParent,m=new i.MapLayer({name:"zoomLayer",coord:{x:0,y:0}}),b=new i.MapLayer({name:"movableLayer",coord:{x:0,
y:0}}),x=new i.MapLayer({name:"minimapLayer",coord:{x:0,y:0}}),m.addChild(b),c.general.fullsizeCanvasCSS(v.main.view),t.style.overflow="hidden",c.mouse.disableContextMenu(v.main.view),!L&&c.general.toggleMouseTextSelection(),this.defaultScaleMode=n.SCALE_MODES.DEFAULT=T,g=Object.keys(v).map(function(e){return v[e]}),this.canvas=v.main.view,this.minimapCanvas=v.minimap?v.minimap.view:void 0,this.mapSize=p,this.plugins=new Set,_.maxDetectionOffset=_.maxDetectionOffset||100,this.subcontainersConfig=_,this.trackFPSCB=j,this.objectManager=new r,this.isSupportedTouch=l.environmentDetection.isTouchDevice(),this.currentlySelectedObjects=[],this.layerTypes={staticType:{id:d,layer:m},movableType:{id:f,layer:b},minimapType:{id:h,layer:x}},this.VERSION=u.VERSION,this.preRenderers={},this.allMapObjects={}}return _createClass(e,[{key:"init",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{x:0,y:0},n=this,o=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{fullsize:!0};if(!this.getPrimaryLayers().length)throw new Error("You should have layers created for the map, before initializing the map");return i.fullsize&&this.toggleFullsize(),this.getAllObjects().forEach(function(e){e&&e.initializeCoordinates&&e.initializeCoordinates(n)}),this.allMapObjects=this._createArrayStructure(),t&&Object.assign(b,t),y=e.length&&this.initPlugins(e),this._defaultTick(),o&&this.customTickOn(o),y||Promise.resolve()}},{key:"whenReady",value:function(){return t.all(y)}},{key:"drawOnNextTick",value:function(){p=!0}},{key:"collectGarbage",value:function(){g.forEach(function(e){return e.textureGC.run()})}},{key:"addUIObject",value:function(e,t,n){var o=this;Array.isArray(t)?t.forEach(function(t){o._addObjectToUIlayer(e,t,n)}):this._addObjectToUIlayer(e,t,n)}},{key:"removeUIObject",value:function(e,t){switch(e){case d:this.getZoomLayer().deleteUIObjects(t);break;case f:this.getMovableLayer().deleteUIObjects(t)}}},{key:"createSpecialLayer",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"default special layer",t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{coord:{x:0,y:0},toLayer:!1},n=t.coord||{x:0,y:0},o=new i.MapLayer({name:e,coord:n});return o.specialLayer=!0,t.toLayer&&t.toLayer.addChild(o),o}},{key:"addLayer",value:function(e){this.getSubcontainerConfigs()&&e.subcontainers!==!1&&(e.subcontainers=this.getSubcontainerConfigs());var t=new S(e);return this.getMovableLayer().addChild(t),t}},{key:"usesSubcontainers",value:function(){return!(!this.getSubcontainerConfigs().width||!this.getSubcontainerConfigs().height)}},{key:"getSubcontainerConfigs",value:function(){return this.subcontainersConfig}},{key:"getViewportArea",value:function(){var e=arguments.length>0&&void 0!==arguments[0]&&arguments[0],t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,o=e?this.getMovableLayer():this.getZoomLayer(),i=new n.Point(0,0),r=new n.Point(window.innerWidth,window.innerHeight);e&&(r=o.toLocal(r),i=o.toLocal(i));var a={x:i.x,y:i.y},l={x2:r.x,y2:r.y},s={x:(Math.abs(l.x2)-a.x)*t,y:(Math.abs(l.y2)-a.y)*t};return{x:Math.round(a.x-s.x),y:Math.round(a.y-s.y),width:Math.round(Math.abs(Math.abs(l.x2)-a.x)+2*s.x),height:Math.round(Math.abs(Math.abs(l.y2)-a.y)+2*s.y)}}},{key:"removeLayer",value:function(e){return b.removeChild(e),e}},{key:"getMapsize",value:function(){return this.mapSize}},{key:"moveMap",value:function(e){var t=e.x,o=void 0===t?0:t,i=e.y,r=void 0===i?0:i,l=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},s=l.absolute,c=void 0!==s&&s,u={x:Math.round(o/this.getZoomLayer().getZoom()),y:Math.round(r/this.getZoomLayer().getZoom())};c?b.position=new n.Point(o,r):b.move(u),a.publish("mapMoved",u),this.drawOnNextTick()}},{key:"initPlugins",value:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],n=[];return t.forEach(function(t){"object"===_typeof(t.plugin)?!function(){var o={};t.parameters=t.parameters||{},Object.keys(t.parameters).forEach(function(e){if(!t.parameters[e].bind)throw new Error("All parameters to plugins must be functions with bind-method!");o[e]=t.parameters[e].bind(t.plugin)}),n.push(e.initPlugin(t.plugin,o))}():s.error(new Error("Plugin '"+t.plugin.pluginName+"' was not an object"))}),n}},{key:"initPlugin",value:function(e){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[],o=void 0;try{if(!e||!e.pluginName||!e.init)throw new Error("plugin, plugin.pluginName or plugin.init import is missing!");this.plugins.add(e[e.pluginName]),this.plugins.has(e[e.pluginName])&&(e.mapInstance=this,e._properties=w,o=e.init(n))}catch(i){i.message+=' INFO: An error initializing plugin. JSON.stringify: "'+e.pluginName+'" ',s.error(i),o=t.reject()}return o}},{key:"registerPreRenderer",value:function(e,t){if(!e&&!t)throw new Error("name and callback required for registerPreRenderer");this.preRenderers[e]={cb:t}}},{key:"removePreRenderer",value:function(e){delete this.preRenderers[e]}},{key:"setPrototype",value:function(e,t){var n=Object.getPrototypeOf(this);n[e]=t}},{key:"getObjectsUnderArea",value:function(e){var t=e.x,o=void 0===t?0:t,i=e.y,r=void 0===i?0:i,a=e.width,l=void 0===a?0:a,s=e.height,c=void 0===s?0:s,u=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},d=u.filters,f=void 0===d?null:d,h={x:o,y:r,width:l,height:c},v={globalCoords:h,localCoords:this.getMovableLayer().toLocal(new n.Point(h.x,h.y))},w=[];v.localCoords.width=h.width/this.getZoom(),v.localCoords.height=h.height/this.getZoom();var p=this._getSubcontainersUnderArea(v,{filters:f});return w=this._retrieveObjects(v,p),f&&f.doesItFilter("object")&&(w=f.filter(w)),w}},{key:"getPrimaryLayers",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=e.filters;return this.getMovableLayer().getPrimaryLayers({filters:t})}},{key:"getAllObjects",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=e.filters,n=void 0,o=void 0;return n=this.getPrimaryLayers({filters:t}).map(function(e){var n=void 0;if(e.hasSubcontainers()){var i=e.getSubcontainers();return n=i.map(function(e){return o=e.children.map(function(e){return t?t.filter(e):e}),l.arrays.flatten2Levels(o)}),l.arrays.flatten2Levels(n)}}),n=l.arrays.flatten2Levels(n)}},{key:"getZoomLayer",value:function(){return m}},{key:"setZoom",value:function(e){return this.getZoomLayer().setZoom(e),a.publish({name:"mapZoomed",cooldown:!0},{previousScale:this.getZoom(),newScale:e}),e}},{key:"getZoom",value:function(){return this.getZoomLayer().getZoom()}},{key:"getRenderer",value:function(e){return"minimap"===e?v.minimap:v.main}},{key:"getMovableLayer",value:function(){return b}},{key:"getMapCoordinates",value:function(e){return e.toGlobal?b.toLocal(u.ZERO_COORDINATES,e):b.toLocal(e)}},{key:"getMinimapLayer",value:function(){return x}},{key:"removeMinimapLayer",value:function(){x=void 0}},{key:"zoomIn",value:function(){return"notImplementedYet. Activate with plugin"}},{key:"zoomOut",value:function(){return"notImplementedYet. Activate with plugin"}},{key:"toggleFullsize",value:function(){return"notImplementedYet. Activate with plugin"}},{key:"toggleFullScreen",value:function(){return"notImplementedYet. Activate with plugin"}},{key:"initMinimap",value:function(){return"notImplementedYet. Activate with plugin"}},{key:"activateFogOfWar",value:function(){return"notImplementedYet. Activate with plugin"}},{key:"_retrieveObjects",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[],n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},o=n.type,i=void 0===o?"":o;return this.objectManager.retrieve(e,t,{type:i,size:{width:e.globalCoords.width,height:e.globalCoords.height}})}},{key:"_getLayersWithAttributes",value:function(e,t){return this.getMovableLayer().children[0].children.filter(function(n){return n[e]===t})}},{key:"_getSubcontainersUnderArea",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=t.filters,o=this.getPrimaryLayers({filters:n}),i=[],r=void 0;return o.forEach(function(t){r=t.getSubcontainersByCoordinates(e.localCoords),i=i.concat(r)}),i}},{key:"_defaultTick",value:function(){var e=this,t=1e3,o=0,i=(new Date).getTime(),r=void 0,a=void 0;n.ticker.shared.add(function(){p&&(e.trackFPSCB&&(r=(new Date).getTime()),Object.keys(e.preRenderers).forEach(function(t){return e.preRenderers[t].cb()}),g.forEach(function(e){return e.render(e.getResponsibleLayer())}),e.trackFPSCB&&(a+=Math.round(Math.abs(r-(new Date).getTime()))),p=!1),e.trackFPSCB&&(o++,i+t<(new Date).getTime()&&(e.trackFPSCB({FPS:o,FPStime:i,renderTime:a,drawCount:v.main.drawCount}),o=0,a=0,i=(new Date).getTime()))})}},{key:"_addObjectToUIlayer",value:function(e,t,n){switch(e){case d:this.getZoomLayer().addUIObject(t,n);break;case f:this.getMovableLayer().addUIObject(t,n)}}},{key:"_createArrayStructure",value:function(){var e={};return this.getPrimaryLayers().forEach(function(t){e[t.name]=t.getObjects()}),e}}]),e}();window.flatworld.Flatworld=O}();var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};!function(){function e(e,n){var l=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},s=l.trackFPSCB,c=void 0!==s&&s,u=l.isHiddenByDefault,d=void 0===u||u,f=l.minimapCanvas,h=l.scaleMode,v=void 0===h?t.SCALE_MODES.DEFAULT:h;r.debug("============== Hexagonal Map factory started =============");var w=i.environmentDetection.getPixelRatio(),p="string"==typeof n.map?JSON.parse(n.map):n.map,y="string"==typeof n.type?JSON.parse(n.type):n.type,g="string"==typeof n.game?JSON.parse(n.game):n.game,m="string"==typeof n.graphic?JSON.parse(n.graphic):n.graphic,b=i.resize.getWindowSize(),x={ObjectTerrain:a.objects.ObjectHexaTerrain,ObjectUnit:a.objects.ObjectHexaUnit},S={mapSize:g.mapSize,bounds:{x:0,y:0,width:b.x,height:b.y},rendererOptions:{resolution:w,autoResize:!0,transparent:!0,antialias:!1},subcontainers:{width:500,height:500,maxDetectionOffset:100,isHiddenByDefault:d},trackFPSCB:c,defaultScaleMode:v,minimapCanvas:f},O=new o(e,S);return t.SCALE_MODES.DEFAULT=1,p.layers.forEach(function(e){if("object"!==("undefined"==typeof e?"undefined":_typeof(e)))throw r.error("Problem in hexaFactory, with layerData:"+JSON.stringify(e)),new Error("Problem in hexaFactory, with layerData:",e);var n=O.getRenderer(),o={name:e.name,coord:e.coord,drawOutsideViewport:{x:n.width,y:n.height},selectable:"unitLayer"===e.name},i=void 0;try{i=O.addLayer(o),e.objectGroups.forEach(function(e){var n=e.typeImageData;return n?void e.objects.forEach(function(o){var a=void 0,l=void 0,s=void 0,c=void 0;try{if(a=y[n][o.objType],!a){var u=new Error("Bad mapData for type:"+n.toString()+o.objType.toString()+o.name.toString());throw r.error(u),u}s=t.Texture.fromFrame(a.image),l={data:{typeData:a,activeData:o.data},radius:g.hexagonRadius,minimapColor:a.minimapColor,minimapSize:a.minimapSize},c=new x[e.type](s,o.coord,l),m[e.typeImageData].initialScale&&(c.scale.x=m[e.typeImageData].initialScale,c.scale.y=m[e.typeImageData].initialScale),i.addChild(c)}catch(d){r.error(d)}}):void r.error("Error with spritesheetType-data")})}catch(a){r.error("Problem:"+JSON.stringify(e.type)+" ---- "+JSON.stringify(a.stack))}}),O.moveMap(g.startPoint),O}var t=window.flatworld_libraries.PIXI,n=window.flatworld,o=n.Flatworld,i=n.utils,r=n.log,a=window.flatworld.extensions.hexagons;window.flatworld.factories.hexaFactory=e}();