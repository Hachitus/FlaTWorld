"use strict";function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function filterChildren(e){var t=arguments.length<=1||void 0===arguments[1]?[]:arguments[1],n=arguments.length<=2||void 0===arguments[2]?void 0:arguments[2];return t.filter(function(t){if(n&&n!==t.type)return!1;var o=t.hitTest?t.hitTest(e):!0;return o})}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}function _toConsumableArray(e){if(Array.isArray(e)){for(var t=0,n=Array(e.length);t<e.length;t++)n[t]=e[t];return n}return Array.from(e)}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}!function(){window.flatworld_libraries={},window.flatworld_libraries.PIXI=window.PIXI,window.flatworld_libraries.Q=window.Q,window.flatworld_libraries.Hammer=window.Hammer,window.flatworld_libraries.Hamster=window.Hamster,window.flatworld_libraries.Handlebars=window.Handlebars,window.flatworld_libraries.log=window.log,window.flatworld_libraries.Howler=window.Howl,window.flatworld={},window.flatworld.generalUtils={},window.flatworld.log={},window.flatworld.objects={},window.flatworld.extensions={},window.flatworld.mapLayers={},window.flatworld.utils={},window.flatworld.factories={},window.flatworld.UIs={},window.flatworld.UIs["default"]={}}(),function(){var e=window.flatworld_libraries.log;e.enableAll(),window.flatworld.log={debug:function(t,n){e.debug(n,t)},error:function(t,n){e.error(n,t)}}}(),function(){function e(){function e(){Array.prototype.find||(Array.prototype.find=function(e){if(null===this)throw new TypeError("Array.prototype.find called on null or undefined");if("function"!=typeof e)throw new TypeError("predicate must be a function");for(var t,n=Object(this),o=n.length>>>0,i=arguments[1],r=0;o>r;r++)if(t=n[r],e.call(i,t,r,n))return t})}function t(){"function"!=typeof Object.assign&&!function(){Object.assign=function(e){if(void 0===e||null===e)throw new TypeError("Cannot convert undefined or null to object");for(var t=Object(e),n=1;n<arguments.length;n++){var o=arguments[n];if(void 0!==o&&null!==o)for(var i in o)o.hasOwnProperty(i)&&(t[i]=o[i])}return t}}()}function n(){String.prototype.repeat||!function(){var e=function(){try{var e={},t=Object.defineProperty,n=t(e,e,e)&&t}catch(o){}return n}(),t=function(e){if(null==this)throw TypeError();var t=String(this),n=e?Number(e):0;if(n!=n&&(n=0),0>n||n==1/0)throw RangeError();for(var o="";n;)n%2==1&&(o+=t),n>1&&(t+=t),n>>=1;return o};e?e(String.prototype,"repeat",{value:t,configurable:!0,writable:!0}):String.prototype.repeat=t}()}return{arrayFind:e,objectAssign:t,es6String:n}}window.flatworld.generalUtils.polyfills=e()}(),function(){function e(){function e(e){return[].concat.apply([],e)}function t(e,t){for(var n=[],o=0;o<e.length;o+=t)n.push(e.slice(o,t+o));return n}return{flatten2Levels:e,chunkArray:t}}window.flatworld.generalUtils.arrays=e()}(),function(){function e(){function e(){var e=screen.width<=640||window.matchMedia&&window.matchMedia("only screen and (max-width: 640px)").matches,t="ontouchstart"in window||navigator.maxTouchPoints>0||navigator.msMaxTouchPoints>0;return t&&e}return{isMobile:e,isTouchDevice:t}}function t(){return"ontouchstart"in document.documentElement}window.flatworld.generalUtils.environmentDetection=e()}();var _createClass=function(){function e(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(t,n,o){return n&&e(t.prototype,n),o&&e(t,o),t}}();!function(){var e=window.flatworld_libraries,t=e.Q,n=e.PIXI,o=function(){function e(t){var o=arguments.length<=1||void 0===arguments[1]?{concurrency:15,crossOrigin:!1}:arguments[1];_classCallCheck(this,e);var i=o.concurrency;this.preloaderClass=new n.loaders.Loader(t,i)}return _createClass(e,[{key:"resolveOnComplete",value:function(){var e=t.defer();return this.preloaderClass.load(),this.preloaderClass.once("complete",function(t,n){e.resolve(t,n)}),e.promise}},{key:"addResource",value:function(e){this.preloaderClass.add(e)}},{key:"loadManifest",value:function(){return this}},{key:"setErrorHandler",value:function(e){return this.preloaderClass.on("error",e),this}},{key:"setProgressHandler",value:function(e){return this.preloaderClass.on("error",e),this}},{key:"activateSound",value:function(){this.preloaderClass.installPlugin()}}]),e}();window.flatworld.Preload=o}(),function(){function e(){function e(e){return Object.keys(e).map(function(t){return e[t]})}function t(e){var t=[];return t.concat.apply(t,e)}return{mapObjectsToArray:e,flattenArrayBy1Level:t}}window.flatworld.utils.dataManipulation=e()}(),function(){function e(){function e(){arguments.length<=0||void 0===arguments[0]?{color:"#000000",distance:5,alpha:.5,"amgÃ¶e":45,blur:5}:arguments[0]}return{dropShadow:e}}window.flatworld_libraries.PIXI;window.flatworld.utils.effects=e()}(),function(){function e(){function e(e){return 3===e.which}function t(e){e.addEventListener("contextmenu",function(e){e.preventDefault()})}function n(e){return{x:e.offsetX,y:e.offsetY}}function o(e){return e.center}function i(e,t){var n=r(t);return{x:e.x-n.x,y:e.y-n.y}}function r(e){for(var t=0,n=0;e;){if("body"===e.tagName.toLowerCase()){var o=e.scrollLeft||document.documentElement.scrollLeft,i=e.scrollTop||document.documentElement.scrollTop;t+=e.offsetLeft-o+e.clientLeft,n+=e.offsetTop-i+e.clientTop}else t+=e.offsetLeft-e.scrollLeft+e.clientLeft,n+=e.offsetTop-e.scrollTop+e.clientTop;e=e.offsetParent}return{x:t,y:n}}function a(e){var t={x:0,y:0};return e||(e=window.event),e.pageX||e.pageY?(t.x=e.pageX,t.y=e.pageY):(e.clientX||e.clientY)&&(t.x=e.clientX+document.body.scrollLeft+document.documentElement.scrollLeft,t.y=e.clientY+document.body.scrollTop+document.documentElement.scrollTop),t}return{isRightClick:e,disableContextMenu:t,eventData:{getPointerCoords:n,getHAMMERPointerCoords:o},coordinatesFromGlobalToRelative:i,eventMouseCoords:a}}function t(){function e(){function e(e){var t=e.cancelFullScreen||e.webkitCancelFullScreen||e.mozCancelFullScreen||e.exitFullscreen;if(t)t.call(e);else if("undefined"!=typeof window.ActiveXObject){var n=new ActiveXObject("WScript.Shell");null!==n&&n.SendKeys("{F11}")}}function t(e){var t=e.requestFullScreen||e.webkitRequestFullScreen||e.mozRequestFullScreen||e.msRequestFullScreen;if(t)t.call(e);else if("undefined"!=typeof window.ActiveXObject){var n=new ActiveXObject("WScript.Shell");null!==n&&n.SendKeys("{F11}")}return!1}var n=document.body,o=document.fullScreenElement&&null!==document.fullScreenElement||document.mozFullScreen||document.webkitIsFullScreen;return o?e(document):t(n),!1}function t(e){return function(){var t=n();e.canvas.width=t.x,e.canvas.height=t.y}}function n(){return{x:window.innerWidth,y:window.innerHeight}}function o(e,t){var o=n();e.autoResize=!0,e.resize(o.x,o.y),t()}return{toggleFullScreen:e,setToFullSize:t,getWindowSize:n,resizePIXIRenderer:o}}function n(){function e(e){var t=window.devicePixelRatio||1,n=e&&e.getContext("2d")||document.createElement("canvas").getContext("2d"),o=n.webkitBackingStorePixelRatio||n.mozBackingStorePixelRatio||n.msBackingStorePixelRatio||n.oBackingStorePixelRatio||n.backingStorePixelRatio||1;return t/o}return{getPixelRatio:e}}function o(){function e(e,t){return Math.abs(e)-Math.abs(t)<o}function t(e){e.style.position="absolute",e.style.display="block",e.style.left="0px",e.style.top="0px"}function n(e,t){throw new Error("Function '"+e+"' requires parameter "+t)}var o=.01;return{pixelEpsilonEquality:e,fullsizeCanvasCSS:t,requireParameter:n}}window.flatworld.utils.mouse=e(),window.flatworld.utils.resize=t(),window.flatworld.utils.environmentDetection=n(),window.flatworld.utils.general=o()}(),function(){function e(){var e=new PIXI.Graphics;return e.lineStyle(2,255,1),e.drawRect(50,250,100,100),e}window.flatworld.utils.shapes={createSquare:e}}(),function(){function e(){function e(e,t){return a("get",e,t)}function n(e,t){return a("post",e,t)}function o(e,n,o){s[e]&&t.debug("API endpoint already exists and has been defined "+e+", "+o+", "+JSON.stringify(n)),s[e]={baseUrl:o,cbs:n?[n]:[]}}function i(e){s[e]||t.debug("API endpoint not found for removing!"),delete s[e]}function r(e,n,o){s[e]&&s[e].cbs||t.debug("API endpoint not found for updating!"),s[e].cbs.push(n)}function a(e,n,o){if(!s[n])return void t.error("API endpoint for fetch not found: "+e+"/"+n+", "+(o?o[0]:"no params"));var i=s[n];return s[n].cbs.forEach(function(t){i=t(e,i,o)}),fetch(i.url,{method:e,body:i.body}).then(function(e){return e.json()}).then(function(e){t.debug("parsed json",e)})["catch"](function(e){t.debug("mapAPI http request failed",e)})}function l(){return s}var s={};return{get:e,post:n,add:o,remove:i,update:r,getAllAPIs:l}}var t=window.flatworld.log;window.flatworld.mapAPI=e()}(),function(){function e(){function e(e,t){document.addEventListener(e,t),i[e]=0}function n(e){var n;if(n=(new Date).getTime(),i[e]+o<n){var r=void 0;r=t(e);for(var a=arguments.length,l=Array(a>1?a-1:0),s=1;a>s;s++)l[s-1]=arguments[s];r.customData=l,document.dispatchEvent(r),i[e]=n}}var o=50,i={};return{subscribe:e,publish:n}}function t(e){var t;try{t=new Event(e)}catch(n){t=document.createEvent("Event"),t.initEvent(e,!0,!0)}return t}window.flatworld.mapEvents=e()}(),function(){function e(){function e(){var e=arguments.length<=0||void 0===arguments[0]?"":arguments[0],t=arguments.length<=1||void 0===arguments[1]?!1:arguments[1];if(!o[e]&&!o[e].size)throw new Error("eventlisteners.on needs to have detector set with this event type!");o[e].on(d("Map"+e,t)),n[e]=n[e]||new Set,n[e].add(t)}function r(){var e=arguments.length<=0||void 0===arguments[0]?"":arguments[0],t=arguments.length<=1||void 0===arguments[1]?!1:arguments[1];o[e].off(t),t?n[e]["delete"](t):delete n[e]}function a(){var e,t=arguments.length<=0||void 0===arguments[0]?"":arguments[0],o=arguments.length<=1||void 0===arguments[1]?!1:arguments[1];return e=o?n[t].has(o):!!n[t].size}function l(e,n){t[e]=n}function s(){var e=arguments.length<=0||void 0===arguments[0]?"":arguments[0];return t[e]}function c(){var e=arguments.length<=0||void 0===arguments[0]?"":arguments[0],t=arguments.length<=1||void 0===arguments[1]?function(){}:arguments[1],n=arguments.length<=2||void 0===arguments[2]?function(){}:arguments[2];o[e]={},o[e]={on:t,off:n}}function u(){var e=arguments.length<=0||void 0===arguments[0]?"":arguments[0];n[e].forEach(function(t){o[e].cbOff(t)}),delete n[e],delete o[e]}function d(e,t){return function(){i.publish(e),t.apply(void 0,arguments)}}return{on:e,off:r,isOn:a,setActivityState:l,getActivityState:s,setDetector:c,clearDetector:u}}var t={},n={},o={},i=window.flatworld.mapEvents;window.flatworld.eventListeners=e()}();var _get=function e(t,n,o){null===t&&(t=Function.prototype);var i=Object.getOwnPropertyDescriptor(t,n);if(void 0===i){var r=Object.getPrototypeOf(t);return null===r?void 0:e(r,n,o)}if("value"in i)return i.value;var a=i.get;if(void 0!==a)return a.call(o)},_createClass=function(){function e(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(t,n,o){return n&&e(t.prototype,n),o&&e(t,o),t}}();!function(){function e(e,t){var n,o=t.subcontainersConfig,i=t.subcontainerList,r=Math.floor(e.x/o.width),l=Math.floor(e.y/o.height);return i[r]=i[r]||[],n=i[r][l]=i[r][l]||[],i[r][l].length<=0&&(n=new a({x:r*o.width,y:l*o.height,width:o.width,height:o.height}),i[r][l]=n,n.x=r*o.width,n.y=l*o.height,n.visible=!o.isHiddenByDefault),e.x-=n.x,e.y-=n.y,i[r][l].addChild(e),i[r][l]}function t(e,t){for(var n=e.getSubcontainerConfigs(),o=n.width,i=n.height,r=n.maxDetectionOffset,a={x:t.x>=0?t.x-r:-r,y:t.y>=0?t.y-r:-r,width:(t.width||0)+2*r,height:(t.height||0)+2*r},l=[],s=Math.floor(a.x/o),c=Math.floor(a.y/i),u=a.width?a.x+a.width:+a.x,d=a.height?a.y+a.height:+a.y,f=Math.floor(u/o),h=Math.floor(d/i),w=e.subcontainerList,v=s;f>=v;v++)if(v>=0&&w&&w[v])for(var y=c;h>=y;y++)y>=0&&w[v][y]&&l.push(w[v][y]);return l}var n=window.flatworld_libraries.PIXI,o=[],i=function(e){function t(){var e=arguments.length<=0||void 0===arguments[0]?{}:arguments[0],n=e.name,o=void 0===n?"":n,i=e.coord,r=void 0===i?{x:0,y:0}:i,a=e.specialLayer,l=void 0===a?!1:a,s=e.staticLayer,c=void 0===s?!0:s,u=e.selectable,d=void 0===u?!1:u;_classCallCheck(this,t);var f=_possibleConstructorReturn(this,Object.getPrototypeOf(t).call(this));return Object.assign(f,r),f.name=""+o,f.specialLayer=!!l,f.staticLayer=!!c,f.selectable=d,f.UIObjectList={},f}return _inherits(t,e),_createClass(t,[{key:"hasSubcontainers",value:function(){return!(!this.subcontainersConfig.width||!this.subcontainersConfig.height)}},{key:"isCached",value:function(){return this.cacheAsBitmap}},{key:"move",value:function(e){this.x+=e.x,this.y+=e.y,this.drawThisChild=!0}},{key:"setZoom",value:function(e){return this.scale.x=this.scale.y=+e.toFixed(2),this.scale.x}},{key:"getZoom",value:function(){return this.scale.x}},{key:"getUIObjects",value:function(){return o}},{key:"getPrimaryLayers",value:function(){var e=arguments.length<=0||void 0===arguments[0]?{}:arguments[0],t=e.filters;return this.children.filter(function(e){return!(t&&!t.filter(e).length||e.specialLayer)})}},{key:"getObjects",value:function(){var e=[];return this.hasSubcontainers()&&this.subcontainerList.forEach(function(t){e.concat(t.children)}),e}},{key:"setCache",value:function(e){var t=!!e;return this.cacheAsBitmap=t,t}},{key:"createUILayer",value:function(){var e=arguments.length<=0||void 0===arguments[0]?"default UI layer":arguments[0],n=arguments.length<=1||void 0===arguments[1]?{x:0,y:0}:arguments[1],o=new t(e,n);return o.specialLayer=!0,this.addChild(o),this.UILayer=o,o}},{key:"getUILayer",value:function(){return this.UILayer}},{key:"addUIObject",value:function(e,t){var n;return o=o||[],t&&this.UIObjectList[t]&&this.deleteUIObjects(t),this.UIObjectList[t]=e,n=this.getUILayer()?this.getUILayer:this.createUILayer(),this.UILayer.addChild(e),o.push(e),o}},{key:"deleteUIObjects",value:function(e){var t=this,n=this.getUILayer();if(e){var i=this.UIObjectList[e];return n.removeChild(i),void(i=null)}return Object.keys(this.UIObjectList).map(function(e){var o=t.UIObjectList[e];n.removeChild(o),o=null}),o}}]),t}(n.Container),r=function(n){function o(){var e=arguments.length<=0||void 0===arguments[0]?{}:arguments[0],t=(e.name,e.coord,e.subcontainers),n=void 0===t?{width:0,height:0,maxDetectionOffset:100}:t,i=e.specialLayer,r=void 0===i?!1:i,a=(e.staticLayer,e.selectable),l=void 0===a?!1:a;_classCallCheck(this,o);var s=_possibleConstructorReturn(this,Object.getPrototypeOf(o).call(this,arguments[0]));return s.oldAddChild=_get(Object.getPrototypeOf(o.prototype),"addChild",s).bind(s),s.subcontainersConfig=n,s.subcontainerList=[],s.selectable=l,s.specialLayer=r,s}return _inherits(o,n),_createClass(o,[{key:"addChild",value:function(t){if(this.hasSubcontainers()){var n=e(t,this);this.oldAddChild(n)}else this.oldAddChild(t);return t}},{key:"getSubcontainerConfigs",value:function(){return this.subcontainersConfig}},{key:"getSubcontainersByCoordinates",value:function(e){if(!this.hasSubcontainers())throw new Error("tried to retrieve subcontainers, when they are not present");var n;return n=t(this,e)}},{key:"getSubcontainers",value:function(){return this.subcontainerList}}]),o}(i),a=function(e){function t(e){_classCallCheck(this,t);var n=_possibleConstructorReturn(this,Object.getPrototypeOf(t).call(this));return n.specialLayer=!0,n.size=e,n.selectable=!1,n}return _inherits(t,e),_createClass(t,[{key:"getSubcontainerArea",value:function(){var e,t=arguments.length<=0||void 0===arguments[0]?{toGlobal:!0}:arguments[0];return e=t.toGlobal?this.toGlobal(new n.Point(0,0)):this,{x:Math.round(e.x),y:Math.round(e.y),width:Math.round(this.size.width),height:Math.round(this.size.height)}}},{key:"setCache",value:function(e){var t=!!e;return this.cacheAsBitmap=t,t}}]),t}(n.Container),l=function(e){function t(e){_classCallCheck(this,t);var n=_possibleConstructorReturn(this,Object.getPrototypeOf(t).call(this));return n.specialLayer=!0,n.targetSize=e,n.selectable=!1,n}return _inherits(t,e),_createClass(t,[{key:"setCache",value:function(e){var t=!!e;return this.cacheAsBitmap=t,t}}]),t}(n.Container);window.flatworld.mapLayers=window.flatworld.mapLayers||{},window.flatworld.mapLayers.MapLayer=i,window.flatworld.mapLayers.MapLayerParent=r,window.flatworld.mapLayers.MinimapLayer=l}();var _createClass=function(){function e(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(t,n,o){return n&&e(t.prototype,n),o&&e(t,o),t}}();!function(){var e=window.flatworld.mapLayers,t=window.flatworld.objects,n=window.flatworld.utils,o=function(){function o(){var i=arguments.length<=0||void 0===arguments[0]?n.general.requireParameter("MapDataManipulator","rules"):arguments[0];_classCallCheck(this,o),this.rules=Array.isArray(i)?i:[i],this.classes={layer:Object.keys(e).map(function(t){return e[t]}),object:Object.keys(t).map(function(e){return t[e]})}}return _createClass(o,[{key:"filter",value:function(e){var t,n=this;return t=Array.isArray(e)?e.filter(function(e){return n._runRule(e)}):this._runRule(e)?[e]:[]}},{key:"addRule",value:function(e){this.rules.concat(e)}},{key:"_runRule",value:function(e){var t,n=this,o=!0;return Object.keys(this.classes).forEach(function(o){var i=n.classes[o].filter(function(t){return e instanceof t});t=i.length?o:t}),this.rules.forEach(function(i){if("filter"===i.type){if(i.object!==t)return;"layer"===t?o=n._getObject(e,i):"object"===t&&(o=n._getObject(e,i))}}),o}},{key:"_getObject",value:function(e,t){return e[t.property]===t.value}}]),o}();window.flatworld.MapDataManipulator=o}();var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol?"symbol":typeof e};!function(){function e(e,o){var i;if(t)return t;if(!e||!o)throw new Error("UI-module requires UITheme and map object, This is an singletong class, so it's possible it should have been already called earlier");return i=o,t={},t.showSelections=function(t,n){var o=arguments.length<=2||void 0===arguments[2]?{}:arguments[2],i=o.filters,r=o.UIThemeOptions;return i&&(t=i.filterObjects(t)),t=Array.isArray(t)?t:[t],1===t.length?e.highlightSelectedObject(t[0],n,r):t.length>1?e.showSelections(t,n,r):e.showSelections([])},t.showUnitMovement=function(t,o){var i=arguments.length<=2||void 0===arguments[2]?{}:arguments[2],r=i.filters,a=i.UIThemeOptions;return r&&(t=r.filterObjects(t)),(Array.isArray(t)||"object"!==("undefined"==typeof t?"undefined":_typeof(t))||null===t)&&n.error("Object was an Array, should be plain object: "+t.length),e.showUnitMovement(t,o,a)},t.extend=function(n){t[n]=function(){e[n]()}},t}var t,n=window.flatworld.log;window.flatworld.UI=e}();var _createClass=function(){function e(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(t,n,o){return n&&e(t.prototype,n),o&&e(t,o),t}}();!function(){var e=function(){function e(){_classCallCheck(this,e)}return _createClass(e,[{key:"retrieve",value:function(e){var t=arguments.length<=1||void 0===arguments[1]?[]:arguments[1],n=arguments.length<=2||void 0===arguments[2]?{type:void 0,size:{width:0,height:0}}:arguments[2],o=n.size,i=n.type,r=e.globalCoords,a=[];return t.length>0?(t.forEach(function(e){a=a.concat(e.children)}),o.width&&o.height||(a=filterChildren(r,a,i)),a):[]}}]),e}();window.flatworld.ObjectManager=e}();var _createClass=function(){function e(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(t,n,o){return n&&e(t.prototype,n),o&&e(t,o),t}}();!function(){var e=window.flatworld.utils,t=window.flatworld_libraries.PIXI,n=window.flatworld.mapAPI,o=window.flatworld.mapEvents,i=function(e){function n(e){var t=arguments.length<=1||void 0===arguments[1]?{x:0,y:0}:arguments[1],o=arguments.length<=2||void 0===arguments[2]?{}:arguments[2],i=o.data,r=void 0===i?null:i;_classCallCheck(this,n);var a=_possibleConstructorReturn(this,Object.getPrototypeOf(n).call(this,e)),l={x:Math.round(t.x),y:Math.round(t.y)};return a.position.set(l.x,l.y),a.name="Objects_sprite_"+a.id,a.type="None",a.highlightable=!0,a.data=r,a.areaWidth=a.width,a.areaHeight=a.height,a["static"]=!0,a.minimapColor=16711680,a}return _inherits(n,e),_createClass(n,[{key:"innerDraw",value:function(e,t){return this.fromFrame(this.currentFrame),this.x=e,this.y=t,this}},{key:"drawNewFrame",value:function(e,t,n){return this.currentFrame=n,this.innerDraw(e,t)}},{key:"getGraphicalArea",value:function(){var e,n=arguments.length<=0||void 0===arguments[0]?{toGlobal:!0}:arguments[0];return e=n.toGlobal?this.toGlobal(new t.Point(0,0)):this,{x:Math.round(e.x),y:Math.round(e.y),width:Math.round(this.width),height:Math.round(this.height)}}},{key:"clone",value:function(e){var n=arguments.length<=1||void 0===arguments[1]?{position:!1,anchor:!1}:arguments[1],o=new t.Sprite;return o.texture=e.generateTexture(this),n.anchor&&(o.anchor=Object.assign({},this.anchor)),n.position&&(o.position=Object.assign({},this.position)),o.constructor.prototype=this.constructor.prototype,o}}]),n}(t.Sprite),r=function(e){function t(e,n){var o=arguments.length<=2||void 0===arguments[2]?{}:arguments[2],i=o.data,r=void 0===i?null:i;_classCallCheck(this,t);var a=_possibleConstructorReturn(this,Object.getPrototypeOf(t).call(this,e,n,{data:r}));return a.name="DefaultTerrainObject",a.type="terrain",a.highlightable=!1,a}return _inherits(t,e),t}(i),a=function(t){function i(e,t){var n=arguments.length<=2||void 0===arguments[2]?{}:arguments[2],o=n.data,r=void 0===o?null:o;_classCallCheck(this,i);var a=_possibleConstructorReturn(this,Object.getPrototypeOf(i).call(this,e,t,{data:r}));return a.name="DefaultUnitObjects",a.type="unit",a.actions={},a}return _inherits(i,t),_createClass(i,[{key:"doAction",value:function(e){this.actions[e].forEach(function(e){e()})}},{key:"addActionType",value:function(e){this.actions[e]=this.actions[e]||[]}},{key:"addCallbackToAction",value:function(e,t){this.actions[e].push(t)}},{key:"dropShadow",value:function(){var t;return(t=e.effects).dropShadow.apply(t,arguments)}},{key:"move",value:function(e){o.publish("objectMove",this),n.post("objectMove",{id:this.id,from:{x:this.x,y:this.y},to:e})}}]),i}(i);window.flatworld.objects.ObjectSprite=i,window.flatworld.objects.ObjectSpriteTerrain=r,window.flatworld.objects.ObjectSpriteUnit=a}();var _createClass=function(){function e(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(t,n,o){return n&&e(t.prototype,n),o&&e(t,o),t}}();!function(){var e=window.flatworld_libraries.Q,t=window.flatworld_libraries.Howler,n=(window.flatworld.mapLayers,function(){function n(){_classCallCheck(this,n),this._allSounds={}}return _createClass(n,[{key:"add",value:function(e,n){var o=arguments.length<=2||void 0===arguments[2]?{loop:!1,volume:1}:arguments[2],i=o.loop,r=o.volume;return this._allSounds[e]={},this._allSounds[e]=new t({urls:[n],autoplay:!1,loop:i,volume:r}),this._allSounds[e]}},{key:"remove",value:function(e){delete this._allSounds[e]}},{key:"play",value:function(t){var n=e.defer();this._allSounds[t]._onend=function(){n.resolve(!0)},this._allSounds[t].play()}},{key:"stop",value:function(e){this._allSounds[e].stop()}},{key:"fade",value:function(t,n,o,i){var r,a=e.defer();return r=function(){a.resolve(!0)},this._allSounds[t].fade(n,o,i,r),a.promise}}]),n}());window.flatworld.Sound=n}(),function(){function e(){return t.create({initial:"statusQuo",events:[{name:"objectSelectDialog",from:["statusQuo","objectSelected"],to:"objectSelectDialogOpened"},{name:"objectSelect",from:["statusQuo","objectSelected","objectSelectDialogOpened"],to:"objectSelected"},{name:"normalize",from:["objectSelected","objectSelectDialogOpened"],to:"statusQuo"},{name:"objectOrder",from:"objectSelected",to:"animatingObject"},{name:"objectOrderEnd",from:"animatingObject",to:"objectSelected"},{name:"UIOpen",from:["statusQuo","objectSelected","objectSelectDialogOpened"],to:"mainUIOpened"},{name:"UIClose",from:"mainUIOpened",to:"statusQuo"}]})}var t=window.StateMachine;window.flatworld.mapStates=e()}(),function(){function e(){function e(e){var n=f(),o=d();g=e,y=new l.Manager(e.canvas),p=new s(e.canvas),r.setDetector("fullSize",t().on,t().off),r.on("fullSize",v),r.setDetector("fullscreen",a().on,a().off),e.setPrototype("setFullScreen",function(){r.on("fullscreen",w)}),r.setDetector("zoom",c().on,c().off),r.setDetector("drag",u().on,u().off),r.setDetector("select",o.on,o.off),r.setDetector("order",n.on,n.off)}function t(){var e;return m.fullsize||(m.fullsize={on:function(t){e=t,window.addEventListener("resize",e)},off:function(){window.removeEventListener("resize",e)}}),m.fullsize}function a(){var e;return m.fullscreen?m.fullscreen:(m.fullscreen={on:function(t){e=t,window.addEventListener("fullscreen",e)},off:function(){window.removeEventListener("fullscreen",e)}},m.fullscreen)}function c(){var e;return m.zoom||(m.zoom={on:function(t){var n=new l.Pinch;e=t,y.add(n),y.on("pinch",e),p.wheel(e)},off:function(){y.on("pinch",e),p.unwheel(e)}}),m.zoom}function u(){var e;return m.drag||(m.drag={on:function(t){var n=new l.Pan({pointers:1,threshold:5,direction:l.DIRECTION_ALL});e=t,y.add(n),y.on("pan",e)},off:function(){y.off("pan",e)}}),m.drag}function d(){var e;return m.select||(m.select={on:function(t){var n=new l.Tap;e=t,y.add(n),y.on("tap",e)},off:function(){y.off("tap",e)}}),m.select}function f(){function e(e){return o.mouse.isRightClick(e)||"press"===e.type?i.can("objectOrder")||!g.isSupportedTouch&&!o.mouse.isRightClick(e)?void t(e):!1:void 0}var t;return m.order||(m.order={on:function(n){t=n;var o=new l.Press;y.add(o),y.on("press",e),g.canvas.addEventListener("mouseup",function(t){3===t.which&&e(t)},!0)},off:function(){y.off("press",e),g.canvas.removeEventListener("mouseup",e,!0)}}),m.order}function h(){var e=document.getElementsByTagName("body")[0].style;e.webkitTouchCallout="none",e.webkitUserSelect="none",e.khtmlUserSelect="none",e.mozUserSelect="none",e.msUserSelect="none",e.userSelect="none"}function w(){o.resize.toggleFullScreen(),n.publish("mapResized"),v()}function v(){o.resize.resizePIXIRenderer(g.getRenderer(),g.drawOnNextTick.bind(g)),n.publish("mapResized")}var y,p,g,m={};return{init:e,toggleFullSize:t,toggleFullscreen:a,toggleZoom:c,toggleDrag:u,toggleSelect:d,toggleOrder:f,toggleMouseTextSelection:h,pluginName:"baseEventlisteners"}}var t=window.flatworld,n=t.mapEvents,o=t.utils,i=t.mapStates,r=t.eventListeners,a=(t.Flatworld,window.flatworld_libraries),l=a.Hammer,s=a.Hamster;window.flatworld.extensions.baseEventlisteners=e()}(),function(){function e(){function e(e){a=o(e),t.on("drag",a)}function o(e){var o=!1;return function(r){var a;return t.getActivityState("zoom")?!1:(a=n.mouse.eventData.getHAMMERPointerCoords(r),s=!0,a.x=Math.round(a.x),a.y=Math.round(a.y),o?(r.isFinal===!0&&(o=!1,s=!1),void i(r,e,a)):(l.setOffset({x:a.x,y:a.y}),void(o=!0)))}}function i(e,t,n){var o,i;o=l.getOffset(),i={x:n.x-o.x,y:n.y-o.y},(i.x>0||i.y>0||i.x<0||i.y<0)&&t.moveMap(i),e.isFinal&&(s=!1),l.setOffset({x:n.x,y:n.y}),e.preventDefault()}function r(){function e(e){return n=e}function t(){return n}var n;return{setOffset:e,getOffset:t}}var a,l=r(),s=!1;return{init:e,pluginName:"mapDrag",_startDragListener:o}}var t=window.flatworld.eventListeners,n=window.flatworld.utils;window.flatworld.mapStates,window.flatworld.log;window.flatworld.extensions.mapDrag=e()}(),function(){function e(){function e(e){h=e,h.setPrototype("zoomIn",r),h.setPrototype("zoomOut",a),h.setPrototype("setZoomLimits",i),h.setPrototype("setZoomModifier",o),t.on("zoom",l)}function o(e){if(!(e>0||.5>=e))throw new Error("Wrong zoom modifier! (needs to be >0 and <=0.5, given:"+e);return m=e,this}function i(e,t){return g.farther=e,g.closer=t,this}function r(e){var t=this.getZoom(),n=!0;return f(this,t,Math.abs(e)||m,n)}function a(e){var t=this.getZoom(),n=!1;return e=0>e?e:-e,f(this,t,e||-m,n)}function l(e,t,n,i){t?s(e,t,n,i):e.pointers&&(y||(y=!0,o(.5*m)),c(e))}function s(e,t,n,o){var i=o,r=h.getZoom();e.preventDefault(),i>0?h.zoomIn()&&h.moveMap(d(r,!0)):0>i&&h.zoomOut()&&h.moveMap(d(r))}function c(e){var n=e.pointers,o=[{x:n[0].pageX,y:n[0].pageY},{x:n[1].pageX,y:n[1].pageY}],i=Math.abs(o[0].x-o[1].x),r=Math.abs(o[0].y-o[1].y);e.preventDefault();try{if(!v)return p={x:i,y:r},t.setActivityState("zoom",!0),void(v=!0);4!==e.eventType&&8!==e.eventType||(window.setTimeout(function(){t.setActivityState("zoom",!1)},w),v=!1),p.x+p.y<i+r?h.zoomIn()&&h.moveMap(d(h.getZoom(),!0)):h.zoomOut()&&h.moveMap(d(h.getZoom())),p={x:i,y:r}}catch(a){console.log("Error! ",a)}}function u(e,t){return!!(t&&e>g.closer||!t&&e<g.farther)}function d(e,t){var o=n.resize.getWindowSize(),i={x:o.x/2/e,y:o.y/2/e},r={x:i.x*(t?-m:m),y:i.y*(t?-m:m)};return r}function f(e,t,n,o){var i;return u(t,o)||(i=e.setZoom(n?t+n:t+m)),i}var h,w=40,v=!1,y=!1,p={},g={farther:.4,closer:2.5},m=.1;return{init:e,pluginName:"mapZoom"}}var t=window.flatworld.eventListeners,n=window.flatworld.utils;window.flatworld.extensions.mapZoom=e()}(),window.flatworld.extensions.hexagons={},window.flatworld.extensions.hexagons.utils={},window.flatworld.extensions.hexagons.eventlisteners={},function(){function e(e){var t=arguments.length<=1||void 0===arguments[1]?{x:0,y:0}:arguments[1],n=arguments.length<=2||void 0===arguments[2]?{}:arguments[2],o=n.orientation,i=void 0===o?"horizontal":o;
d=e,f=t,h=i}function t(){var e=arguments.length<=0||void 0===arguments[0]?{}:arguments[0],t=e.radius,n=void 0===t?d:t,o=e.orientation,i=void 0===o?"horizontal":o;n||u.error("You need to define at least globalRadius for the hexagonMath utils class");var r="horizontal"===i?.5:0,a={x:n,y:n},l=2*Math.PI/6*r,s=a.x*Math.cos(l),c=a.y*Math.sin(l),f=[];f.push({x:s,y:c});for(var h=1;7>h;h++)l=2*Math.PI/6*(h+r),s=a.x*Math.cos(l),c=a.y*Math.sin(l),f.push({x:s,y:c});return f}function n(){var e,t=arguments.length<=0||void 0===arguments[0]?{}:arguments[0],n=t.radius,o=void 0===n?d:n,i=t.floorNumbers,r=void 0===i?!0:i;return e=o*Math.sqrt(3),e=r?Math.floor(e):e}function o(){var e,t=arguments.length<=0||void 0===arguments[0]?{}:arguments[0],n=t.radius,o=void 0===n?d:n,i=t.floorNumbers,r=void 0===i?!0:i;return e=2*o,e=r?Math.floor(e):e}function i(){var e=arguments.length<=0||void 0===arguments[0]?{}:arguments[0],t=e.radius,n=void 0===t?d:t;return o(n)-n/2}function r(e,t){var n,o=arguments.length<=2||void 0===arguments[2]?{x:0,y:0}:arguments[2];return n=e.map(function(e){return{x:e.x+o.x,y:e.y+o.y}}),c(t,n)}function a(e){var t,i,r=arguments.length<=1||void 0===arguments[1]?{}:arguments[1],a=r.radius,l=void 0===a?d:a,s=r.orientation,c=void 0===s?"horizontal":s,u=e.rows,f=e.columns,h=[],w=n(l),v=o(l)-l/2;t="horizontal"===c?v:w,i="horizontal"===c?w:v;for(var y=0;u>y;y++)for(var p=0;f>p;p++)h.push({x:Math.round(p*i+("horizontal"!==c||0!==y&&y%2!==0?-w/2:0)),y:y*t});return h}function l(e){var t,r=d;if(!h||!r||!f)throw new Error("getClosestHexagonCenter requirements not filled");return t="horizontal"===h?{x:Math.round(e.x-e.x%n(r)+n(r)/2+f.x),y:Math.round(e.y-e.y%i(r)+o(r)/2+f.y)}:{x:Math.floor(e.x-e.x%i(r)+f.x),y:Math.floor(e.y-e.y%n(r)+f.y)}}function s(e){return{x:e.x/n(),y:e.y/o()}}function c(e,t){for(var n,o,i,r,a,l=e.x,s=e.y,c=!1,u=0,d=t.length-1;u<t.length;d=u++)n=t[u].x,i=t[u].y,o=t[d].x,r=t[d].y,a=i>s!=r>s&&(o-n)*(s-i)/(r-i)+n>l,a&&(c=!c);return c}var u=window.flatworld.log;window.flatworld.extensions.hexagons.utils.init=e,window.flatworld.extensions.hexagons.utils.createHexagonGridCoordinates=a,window.flatworld.extensions.hexagons.utils.getHexagonPoints=t,window.flatworld.extensions.hexagons.utils.calcShortDiagonal=n,window.flatworld.extensions.hexagons.utils.calcLongDiagonal=o,window.flatworld.extensions.hexagons.utils.hexaHitTest=r,window.flatworld.extensions.hexagons.utils.getClosestHexagonCenter=l,window.flatworld.extensions.hexagons.utils.calculateIndex=s;var d,f,h}(),function(){function e(e){var t=arguments.length<=1||void 0===arguments[1]?{}:arguments[1],i=t.orientation,r=void 0===i?"horizontal":i,a=[];if("horizontal"!==r)throw new Error("Nothing else than horizontal supported so far!");return a=n(e),new o.Polygon(a)}function t(e){var t=arguments.length<=1||void 0===arguments[1]?{}:arguments[1],i=t.color,r=void 0===i?16711680:i,a=t.isFlatTop,l=void 0===a?!1:a,s=new o.Graphics,c=n(e,l);return s.beginFill(r,1),s.drawPolygon(c,l),s.endFill(),s}function n(e){return i({radius:e}).map(function(e){return new o.Point(e.x,e.y)})}var o=window.flatworld_libraries.PIXI,i=window.flatworld.extensions.hexagons.utils.getHexagonPoints;window.flatworld.extensions.hexagons.utils.createHexagon=e,window.flatworld.extensions.hexagons.utils.createVisibleHexagon=t}(),function(){function e(e){function s(o){var r,s=t.mouse.eventData.getHAMMERPointerCoords(o),c={allData:function(e){return e.data.typeData}},d=new i({type:"filter",object:"layer",property:"name",value:"unitLayer"});return a.objectSelect(),r=e.getObjectsUnderArea(s,{filters:d}),r=t.dataManipulation.mapObjectsToArray(r),r=t.dataManipulation.flattenArrayBy1Level(r),r.length?(e.currentlySelectedObjects=r,n.publish("objectsSelected",r),u.showSelections(r,c),void e.drawOnNextTick()):(e.currentlySelectedObjects=void 0,l.debug("No objects found for selection!"),void u.showSelections([]))}function c(o){var r,s;new i({type:"filter",object:"layer",property:"name",value:"unitLayer"});return e.currentlySelectedObjects?e.currentlySelectedObjects.length>1?void l.debug("the selected object is only supported to be one atm."+JSON.stringify(e.currentlySelectedObjects)):(s=e.currentlySelectedObjects[0],a.objectOrder(),r=e.isSupportedTouch?t.mouse.eventData.getHAMMERPointerCoords(o):t.mouse.eventData.getPointerCoords(o),s.move(r),n.publish("objectMoves",s),u.showUnitMovement(s,r),a.objectOrderEnd(),void e.drawOnNextTick()):void l.debug("No objects selected for orders! "+JSON.stringify(s))}var u;if(!e)throw new Error("eventlisteners initialization requires flatworld instance as a parameter");return u=o(),r.on("select",s),r.on("order",c),!0}var t=window.flatworld.utils,n=window.flatworld.mapEvents,o=window.flatworld.UI,i=window.flatworld.MapDataManipulator,r=window.flatworld.eventListeners,a=window.flatworld.mapStates,l=window.flatworld.log;window.flatworld.extensions.hexagons.setupHexagonClick=e}(),function(){function e(e){if(!e)throw new Error("Need radius!");var n=Math.round(l(e)),o=Math.round(s(e)),i=Math.round(e);this.anchor.set(.5,.5),this.areaHeight=this.HEIGHT=n,this.areaWidth=this.WIDTH=o,this.SIDE=i,this.ROW_HEIGHT=Math.round(.75*n),this.hitArea=t(e),this.hitTest=function(e){var t;return t=this.toLocal(new u.Point(e.x,e.y)),this.hitArea.contains(t.x,t.y)}}function t(e){return n||(n=c(e)),n}var n,o=window.flatworld.objects,i=o.ObjectSpriteTerrain,r=o.ObjectSpriteUnit,a=window.flatworld.extensions.hexagons.utils,l=a.calcLongDiagonal,s=a.calcShortDiagonal,c=a.createHexagon,u=window.flatworld_libraries.PIXI,d=function(t){function n(t){var o=arguments.length<=1||void 0===arguments[1]?{x:0,y:0}:arguments[1],i=arguments.length<=2||void 0===arguments[2]?{}:arguments[2],r=i.data,a=i.radius,l=i.minimapColor,s=i.minimapShape;_classCallCheck(this,n);var c=_possibleConstructorReturn(this,Object.getPrototypeOf(n).call(this,t,o,{data:r}));return c.name="DefaultTerrainObject_hexa",c.minimapColor=l,c.minimapShape=s,e.call(c,a),c}return _inherits(n,t),n}(i),f=function(t){function n(t){var o=arguments.length<=1||void 0===arguments[1]?{x:0,y:0}:arguments[1],i=arguments.length<=2||void 0===arguments[2]?{}:arguments[2],r=i.data,a=i.radius,l=i.minimapColor,s=i.minimapShape;_classCallCheck(this,n);var c=_possibleConstructorReturn(this,Object.getPrototypeOf(n).call(this,t,o,{data:r}));return c.name="DefaultUnitObjects_hexa",c.minimapColor=l,c.minimapShape=s,c["static"]=!1,e.call(c,a),c}return _inherits(n,t),n}(r);window.flatworld.extensions.hexagons.objects={ObjectHexaTerrain:d,ObjectHexaUnit:f}}(),function(){function e(){function e(e){o=e,n(o)}function n(e){return t(e)}var o={};return{init:e,pluginName:"selectHexagonObject"}}var t=window.flatworld.extensions.hexagons.setupHexagonClick;window.flatworld.extensions.hexagons.selectHexagonObject=e()}(),function(){function e(){function e(e){f=e,h=f.getZoom(),o(),r(),f.drawOnNextTick(),g&&(window.FlaTWorld_mapMovement_subCheck=function(){f.getPrimaryLayers().forEach(function(e){var t,o,i=n.flatten2Levels(e.getSubcontainers());t=i.filter(function(e){return e.visible}),o=i.filter(function(e){return!e.visible});var r=t.reduce(function(e,t){e+t.x+""});window.flatworld.log.debug("visible subcontainers: "+t.length+", "+r+"\n\ninvisible: "+o.length)})},window.FlaTWorld_mapMovement_deactivate=function(){f.getPrimaryLayers().forEach(function(e){var t,o=n.flatten2Levels(e.getSubcontainers());t=o.forEach(function(e){e.visible=!1})})})}function o(){var e;e=f.getViewportArea(!0),f.getPrimaryLayers().forEach(function(t){var o=n.flatten2Levels(t.getSubcontainers());o.forEach(function(t){t.visible=!a(t,e)})})}function i(){function e(){var e;e=f.getViewportArea(!0),l(e,f.getPrimaryLayers())}if(y.processing)return!1;y.processing=!0;var t=e();window.setTimeout(t,v)}function r(){function e(e){var t=e.customData[0];p.width+=t.x,p.height+=t.y,i()}function n(){i()}function o(e){h=e.customData[0].newScale,i()}t.subscribe("mapMoved",e),t.subscribe("mapResized",n),t.subscribe("mapZoomed",o)}function a(e,t){var n,o;return o=e.getSubcontainerArea({toGlobal:!1}),n=!c(o,t)}function l(e,t){var o,i,r=[];i=s(e),p.width=0,p.height=0,t=n.chunkArray(t,2),o=t.map(function(e){var t=window.Q.defer();return window.setTimeout(function(){var n;n=e.map(function(e){return e.getSubcontainersByCoordinates(i)}),r=r.concat(n),t.resolve(!0)}),t.promise}),o=window.Q.all(o).then(function(){var t,o;return r=n.flatten2Levels(r),t=n.chunkArray(r,40),o=t.map(function(t){var n=window.Q.defer();return window.setTimeout(function(){t.forEach(function(t){t.visible=!a(t,e)}),n.resolve(!0)}),n.promise})}),window.Q.all(o).then(function(){y.processing=!1,f.drawOnNextTick()}).then(null,function(e){window.flatworld.log.debug(e)})}function s(e){var t=arguments.length<=1||void 0===arguments[1]?{scale:1}:arguments[1],n=u(e,t);return{x:Math.round(e.x-n),y:Math.round(e.y-n),width:Math.round(e.width+2*n),height:Math.round(e.height+2*n)}}function c(e,t){return e.x<=t.x+t.width&&t.x<=e.x+e.width&&e.y<=t.y+t.height&&t.y<=e.y+e.height}function u(e){var t=arguments.length<=1||void 0===arguments[1]?{scale:1}:arguments[1];return Math.abs(e.width/t.scale*w)}function d(e){f=e}var f,h,w=.2,v=20,y={},p={width:0,height:0},g=!1;return{init:e,pluginName:"mapMovement",addAll:o,check:i,startEventListeners:r,_testObject:{isObjectOutsideViewport:a,viewportWorkerOnMessage:l,getViewportWithOffset:s,testRectangleIntersect:c,_setMap:d}}}var t=window.flatworld.mapEvents,n=window.flatworld.generalUtils.arrays;window.flatworld.extensions.mapMovement=e()}(),window.flatworld.extensions.minimaps={},function(){function e(){function e(e){p=e,b=new r.Manager(p.minimapCanvas),p.initMinimap=a,g=p.getMinimapLayer()}function a(e,n,o,i,r,a){var d=arguments.length<=6||void 0===arguments[6]?{}:arguments[6],f=d.xPadding,h=void 0===f?10:f,y=d.yPadding,p=void 0===y?10:y;return M=h,O=p,g.minimapSize=n,x=r,l(e),s(o),c(i),v(g.minimapSize.x,g.minimapSize.y,g.minimapSize.width,g.minimapSize.height),u(),w(),m=a,g.addChild(m),t.publish("minimapInitialized",g),g}function l(e){g.addChild(e)}function s(e){var t=new o({type:"filter",object:"layer",property:"staticLayer",value:!0}),n=y();p.getAllObjects({filters:t}).forEach(function(t){n.addChild(e(t))}),n.cacheAsBitmap=!0,g.addChild(n)}function c(e){var t=new o({type:"filter",object:"object",property:"static",value:!1});C=y(),p.getAllObjects({filters:t}).forEach(function(t){C.addChild(e(t))}),C.cacheAsBitmap=!0,g.addChild(C)}function u(){t.subscribe("mapMoved",d),t.subscribe("mapZoomed",f),t.subscribe("minimapClicked",h)}function d(){if(!(S-Date.now()>-5)){var e=x(p.getMovableLayer(),!0);m.x=e.x,m.y=e.y,p.drawOnNextTick()}}function f(e){m.scale.x+=.1,m.scale.y=.1}function h(e){var t=i.mouse.eventData.getHAMMERPointerCoords(e),n=new PIXI.Point(e.srcEvent.layerX,e.srcEvent.layerY);t=i.mouse.coordinatesFromGlobalToRelative(t,p.minimapCanvas),S=Date.now(),t.x-=Math.round(m.width/2),t.y-=Math.round(m.height/2),n=x(t,!0),m.x=n.x,m.y=n.y,n=x(t,!1),p.moveMap(n,{absolute:!0,noEvent:!0}),p.drawOnNextTick()}function w(){var e,t={on:function(t){var n=new r.Tap;e=t,b.add(n),b.on("tap",e)},off:function(){b.on("tap",e)}};n.setDetector("minimapClicked",t.on,t.off),n.on("minimapClicked",h)}function v(e,t,n,o){var i=p.getRenderer("minimap");g.position=new PIXI.Point(e,t),i.autoResize=!0,i.resize(n+2*M,o+2*O),p.drawOnNextTick()}function y(){var e=new PIXI.Container;return e.x=M,e.y=O,e}var p,g,m,b,x,S,C,M=0,O=0;return{init:e,pluginName:"pixelizedMinimap",initMinimap:a,_testObject:{}}}var t=window.flatworld.mapEvents,n=window.flatworld.eventListeners,o=window.flatworld.MapDataManipulator,i=window.flatworld.utils,r=window.flatworld_libraries.Hammer;window.flatworld.extensions.minimaps.pixelizedMinimap=e()}(),function(){function e(){function e(e){l=e,l.initMinimap=o,n=l.getMinimapLayer()}function o(e,o,l){var c=e.width,u=e.height,d=arguments.length<=3||void 0===arguments[3]?{}:arguments[3],f=d.x,h=void 0===f?0:f,w=d.y,v=void 0===w?0:w;PIXI.Texture.fromFrame(o);n.targetSize.x=c,n.targetSize.y=u,i(o),r(l),a(Math.round(h),Math.round(v)),t.publish("minimapInitialized",s)}function i(e){var t=PIXI.Texture.fromFrame(e),n=new PIXI.Sprite(t);l.getMinimapLayer().addChild(n)}function r(e){e.width=n.targetSize.x/l.width,e.height=n.targetSize.y/l.height,n.addChild(e)}function a(e){var t=e.x,n=e.y;l.getMinimapLayer().position(new PIXI.Point(t,n))}var l,s;return{init:e,pluginName:"scaledMinimap",_testObject:{}}}var t=window.flatworld.mapEvents;window.flatworld.extensions.minimaps.scaledMinimap=e();var n}(),window.flatworld.extensions.fogOfWars={},function(){function e(){function e(e){M=e,M.activateFogOfWar=n;var t=M.getRenderer(),o={x:0,y:0,width:(t.width+0+t.width/2)*M.getZoom(),height:(t.height+0+t.height/2)*M.getZoom()},i=Object.assign(m,{resolution:t.resolution});u(o,i),j=M.createSpecialLayer("FoWMaskLayer"),j.x=o.x,j.y=o.y}function n(e){var t=arguments.length<=1||void 0===arguments[1]?{alpha:.8}:arguments[1];C=t.alpha,L=e,r.resize.resizePIXIRenderer(O,M.drawOnNextTick.bind(M)),a(),p()}function a(){var e=M.getStaticLayer();v(S),M.getMovableLayer().updateTransform();var n=l(L);if(n.length>0){var o;(o=j).addChild.apply(o,_toConsumableArray(n))}O.render(j),j.removeChildren(),k=t.Texture.fromCanvas(O.view),x.texture=k,k.update(),e.mask=x}function l(e){var t=arguments.length<=1||void 0===arguments[1]?b:arguments[1];return c(t).map(function(t){return e(s(t))})}function s(e){var n=e.toGlobal(new t.Point(0,0));return n.x=Math.round(n.x),n.y=Math.round(n.y),n.anchor=e.anchor,n.pivot=e.pivot,n.scale=M.getZoom(),n}function c(e){return M.getObjectsUnderArea(M.getViewportArea(!1,g),{filters:e})}function u(e,t,n){S=y(e),w(O),O=h(e,n)}function d(){return j}function f(){return O}function h(e,n){return new t.WebGLRenderer(e.width,e.height,n)}function w(e){e&&e.destroy&&e.view&&e.destroy()}function v(e){k&&k.destroy&&k.destroy(),j.children&&j.removeChildren(),j.addChild(e)}function y(e){var n=new t.Graphics;return n.clear(),n.beginFill(0,C),n.drawRect(e.x,e.y,e.width,e.height),n.endFill(),n}function p(){o.subscribe("mapResized",function(){r.resize.resizePIXIRenderer(O,M.drawOnNextTick.bind(M))}),o.subscribe("mapResized",a),o.subscribe("mapMoved",a)}var g=.4,m={transparent:!0,autoResize:!0},b=new i([{type:"filter",object:"object",property:"type",value:"unit"}]),x=new t.Sprite,S=void 0,C=void 0,M=void 0,O=void 0,k=void 0,j=void 0,L=void 0;return{init:e,pluginName:"simpleFogOfWar",getFoWRenderer:f,getMaskContainer:d,activateFogOfWar:n,refreshFoW:a,getFoWObjectArray:l,calculateCorrectCoordinates:s}}var t=window.flatworld_libraries.PIXI,n=window.flatworld,o=n.mapEvents,i=n.MapDataManipulator,r=n.utils;window.flatworld.extensions.fogOfWars.simpleFogOfWar=e()}(),window.flatworld.UIs=window.flatworld.UIs||{},window.flatworld.UIs["default"]={},window.flatworld.UIs["default"].utils={},window.flatworld.UIs["default"].layout={},function(){window.flatworld.UIs["default"].utils.drawShapes=function(){function e(e,t,n,o,i,r,a,l,s){function c(e,t,n,o,i,r,a,l){var s;switch(t=+t,n=+n,o=+o,i=+i,r=+r,a=+a,e.beginStroke("#F00").moveTo(t,n).lineTo(o,i).lineTo(r,a),l){case 0:s=Math.sqrt((r-t)*(r-t)+(a-n)*(a-n)),e.arcTo(o,i,t,n,.55*s),e.fill();break;case 1:e.beginStroke("#F00").moveTo(t,n).lineTo(o,i).lineTo(r,a).lineTo(t,n).fill();break;case 2:break;case 3:var c=(t+o+r)/3,u=(n+i+a)/3;e.beginFill().quadraticCurveTo(c,u,t,n);break;case 4:var d,f,h,w,v=5;if(r===t)s=a-n,d=(o+t)/2,h=(o+t)/2,f=i+s/v,w=i-s/v;else{s=Math.sqrt((r-t)*(r-t)+(a-n)*(a-n));var y=(t+r)/2,p=(n+a)/2,g=(y+o)/2,m=(p+i)/2,b=(a-n)/(r-t),x=s/(2*Math.sqrt(b*b+1))/v,S=b*x;d=g-x,f=m-S,h=g+x,w=m+S}e.bezierCurveTo(d,f,h,w,t,n),e.fill()}}var u,d,f,h,w,v,y=e.graphics,p="#000";"string"==typeof t&&(t=parseInt(t,10)),"string"==typeof n&&(n=parseInt(n,10)),"string"==typeof o&&(o=parseInt(o,10)),"string"==typeof i&&(i=parseInt(i,10)),r="undefined"!=typeof r?r:3,a="undefined"!=typeof a?a:1,l="undefined"!=typeof l?l:Math.PI/8,s="undefined"!=typeof s?s:10;var g,m,b,x,S="function"!=typeof r?c:r,C=Math.sqrt((o-t)*(o-t)+(i-n)*(i-n)),M=(C-s/3)/C;1&a?(g=Math.round(t+(o-t)*M),m=Math.round(n+(i-n)*M)):(g=o,m=i),2&a?(b=t+(o-t)*(1-M),x=n+(i-n)*(1-M)):(b=t,x=n),y.beginStroke(p).moveTo(b,x).lineTo(g,m);var O=Math.atan2(i-n,o-t),k=Math.abs(s/Math.cos(l));return 1&a&&(u=O+Math.PI+l,d=o+Math.cos(u)*k,f=i+Math.sin(u)*k,h=O+Math.PI-l,w=o+Math.cos(h)*k,v=i+Math.sin(h)*k,S(y,d,f,o,i,w,v,r)),2&a&&(u=O+l,d=t+Math.cos(u)*k,f=n+Math.sin(u)*k,h=O-l,w=t+Math.cos(h)*k,v=n+Math.sin(h)*k,S(y,d,f,t,n,w,v,r)),!0}function t(t,n,o,i,r,a,l,s,c,u,d){var f,h,w,v,y;s="undefined"!=typeof s?s:3,c="undefined"!=typeof c?c:1,u="undefined"!=typeof u?u:Math.PI/8,d="undefined"!=typeof d?d:10,t.beginPath(),t.arc(n,o,i,r,a,l),t.stroke(),t.strokeStyle="rgba(0,0,0,0)",1&c&&(f=Math.cos(r)*i+n,h=Math.sin(r)*i+o,w=Math.atan2(n-f,h-o),l?(v=f+10*Math.cos(w),y=h+10*Math.sin(w)):(v=f-10*Math.cos(w),y=h-10*Math.sin(w)),e(t,f,h,v,y,s,2,u,d)),2&c&&(f=Math.cos(a)*i+n,h=Math.sin(a)*i+o,w=Math.atan2(n-f,h-o),l?(v=f-10*Math.cos(w),y=h-10*Math.sin(w)):(v=f+10*Math.cos(w),y=h+10*Math.sin(w)),e(t,f,h,v,y,s,2,u,d))}function n(e,t,n){var o=arguments.length<=3||void 0===arguments[3]?{color:"#000000",style:5}:arguments[3],i=o.color,r=o.style;return e.lineStyle(r,i),e.moveTo(t.x,t.y),e.lineTo(n.x,n.y),e.endFill(),e}return{normal:e,arced:t,line:n}}()}(),function(){var e=window.flatworld_libraries.Handlebars;window.flatworld.UIs=window.flatworld.UIs||{},window.flatworld.UIs["default"]=window.flatworld.UIs["default"]||{},window.flatworld.UIs["default"].templates={multiSelection:e.compile("\n      <span style='font-size:200%;display:block;margin-bottom:20px;'>\n        {{title}}\n      </span>\n      <ul>\n        {{#each objects}}\n        <li>\n          {{this.data.typeData.name}}\n        </li>\n        {{/each}}\n      </ul>"),singleSelection:e.compile("\n      <span style='font-size:200%;display:block;margin-bottom:20px;'>\n        {{title}}\n      </span>\n      <ul>\n        <li>\n          {{object.name}}\n        </li>\n      </ul>")}}();var _createClass=function(){function e(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(t,n,o){return n&&e(t.prototype,n),o&&e(t,o),t}}();!function(){function e(e){if(!s[e]){var t=document.querySelector(n[e]);s[e]=t}return s[e]}var t,n,o=window.flatworld_libraries.PIXI,i=window.flatworld.UIs["default"].templates,r=window.flatworld.extensions.hexagons.utils.createVisibleHexagon,a=window.flatworld.UIs["default"].utils.drawShapes,l=window.flatworld.log,s={},c=function(){function s(e,o){var i=arguments.length<=2||void 0===arguments[2]?{}:arguments[2],r=i.styles,a=void 0===r?"#F0F0F0":r,l=i.elements;_classCallCheck(this,s),n=l,t=this.addStyleElement();var c="\n        "+n.select+" {\n          z-index: 9999;\n          opacity: 0.9;\n          position: fixed;\n          left: 0px;\n          bottom: 0px;\n          background-color: brown;\n          border: 1px solid rgb(255, 186, 148);;\n          border-bottom: 0px;\n          padding:15px;\n          margin-left:10px;\n        }";this.addCSSRulesToScriptTag(t,c),this.FTW=o,this.modal=e||document.getElementById("dialog_select"),this.styles=a}return _createClass(s,[{key:"setFlatworld",value:function(e){this.FTW=e}},{key:"getTemplates",value:function(){return i}},{key:"showSelections",value:function(t,o,r){var a,s=this,c=this.FTW.drawOnNextTick.bind(this.FTW),u=this.FTW.getMovableLayer();a=t&&t.length>1?function(){s.modal.innerHTML=i.multiSelection({title:"Objects",objects:t}),s.showModal(s.modal,n),e("select").style.display="block"}:t&&1===t.length?function(){s.highlightSelectedObject(t[0])}:function(){u.deleteUIObjects(),c(),l.debug("Error occured selecting the objects on this coordinates! Nothing found")},e("select").style.display="none",a()}},{key:"highlightSelectedObject",value:function(t,o){var r,a,l=arguments.length<=2||void 0===arguments[2]?{shadow:{color:"0x0000",distance:5,alpha:.55,angle:45,blur:5}}:arguments[2],s=l.shadow;return a=o.allData(t),this.modal.innerHTML=i.singleSelection({title:"Selected",object:{name:a.name}}),this.showModal(this.modal,n),r=this._highlightSelectedObject(t,this.FTW.getRenderer()),r.dropShadow({color:s.color,distance:s.distance,alpha:s.alpha,angle:s.angle,blur:s.blur}),this.FTW.drawOnNextTick(),e("select").style.display="block",r}},{key:"showUnitMovement",value:function(e,t){var n,i,r,l="movementArrow";n=this.FTW.getMovableLayer().toLocal(t),i=this.FTW.getMovableLayer().toLocal(e.toGlobal(new o.Point(0,0))),r=a.line(new o.Graphics,i,n),this.FTW.removeUIObject(this.FTW.layerTypes.movableType.id,l),this.FTW.addUIObject(this.FTW.layerTypes.movableType.id,r,l),this.FTW.drawOnNextTick()}},{key:"_highlightSelectedObject",value:function(e,t){var n,i=this.FTW.getMovableLayer();n=e.clone(t);var r=e.toGlobal(new o.Point(0,0));return r=i.toLocal(r),r.x-=e.width*e.anchor.x,r.y-=e.height*e.anchor.y,this.createHighlight(n,{coords:r}),n}},{key:"createHighlight",value:function(e){var t,n=arguments.length<=1||void 0===arguments[1]?{coords:new o.Point(0,0)}:arguments[1],i=47,a="unit highlight",l=this.FTW.getMovableLayer(),s=new this.FTW.createSpecialLayer("UILayer",{toLayer:l}),c={x:Number(e.x),y:Number(e.y)};t=r(i,{color:"#F0F0F0"}),t.x=c.x+32,t.y=c.y+27,t.alpha=.5,s.addChild(t),s.addChild(e),s.position=n.coords,this.FTW.removeUIObject(this.FTW.layerTypes.movableType.id),this.FTW.addUIObject(this.FTW.layerTypes.movableType.id,s,a)}},{key:"addCSSRulesToScriptTag",value:function(e,t){e.insertRule(t,0)}},{key:"addStyleElement",value:function(){var e=document.createElement("style");return e.appendChild(document.createTextNode("")),document.head.appendChild(e),e.sheet}},{key:"showModal",value:function(e,t){e.classList.add(t.select)}}]),s}();window.flatworld.UIs["default"].init=c}();var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol?"symbol":typeof e},_createClass=function(){function e(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(t,n,o){return n&&e(t.prototype,n),o&&e(t,o),t}}();!function(){function e(e,t){t?O.children.forEach(function(t){if(t.isCached()){var n=t.getSubcontainers();n.forEach(function(t){return t.setCache(e)})}}):O.children.forEach(function(t){return t.isCached()&&t.setCache(e)})}var t=window.flatworld_libraries,n=t.Q,o=t.PIXI,i=window.flatworld,r=i.mapLayers,a=i.ObjectManager,l=i.mapEvents,s=i.generalUtils,c=i.log,u=i.utils,d=0,f=1,h=2,w="0.0.0",v=Symbol("_retrieveObjects"),y=Symbol("_getLayersWithAttributes"),p=Symbol("_getSubcontainersUnderArea"),g=Symbol("_defaultTick"),m=Symbol("_addObjectToUIlayer"),b={},x=!1,S=[],C=void 0,M=void 0,O=void 0,k=void 0,j=void 0,L=function(){function t(){var e=arguments.length<=0||void 0===arguments[0]?null:arguments[0],n=arguments.length<=1||void 0===arguments[1]?{}:arguments[1],i=n.bounds,l=void 0===i?{width:0,height:0}:i,c=n.mapSize,v=void 0===c?{x:0,y:0}:c,y=n.rendererOptions,p=void 0===y?{autoResize:!0,antialias:!1}:y,g=n.minimapCanvas,m=n.subcontainers,x=void 0===m?{width:0,height:0,maxDetectionOffset:0}:m,S=n.cache,L=void 0===S?!1:S,T=n.trackFPSCB,_=void 0===T?!1:T,P=n.defaultScaleMode,I=void 0===P?o.SCALE_MODES.DEFAULT:P;if(_classCallCheck(this,t),!e)throw new Error(this.constructor.name+" needs canvas element!");"string"==typeof e&&(e=document.querySelector(e)),e.innerHTML="",p.view=e,b.main=new o.WebGLRenderer(l.width,l.height,p),b.main.getResponsibleLayer=this.getStaticLayer,g&&(b.minimap=g?new o.WebGLRenderer(0,0,{view:g,autoResize:!0}):void 0,b.minimap.plugins.interaction.destroy(),b.minimap.getResponsibleLayer=this.getMinimapLayer),b.main.plugins.interaction.destroy(),j=x.width&&x.height&&x.maxDetectionOffset?r.MapLayerParent:r.MapLayer,M=new r.MapLayer({name:"staticLayer",coord:{x:0,y:0}}),O=new r.MapLayer({name:"movableLayer",coord:{x:0,y:0}}),k=new r.MapLayer({name:"minimapLayer",coord:{x:0,y:0}}),M.addChild(O),u.general.fullsizeCanvasCSS(b.main.view),e.style.overflow="hidden",u.mouse.disableContextMenu(b.main.view),this.defaultScaleMode=o.SCALE_MODES.DEFAULT=I,C=Object.keys(b).map(function(e){return b[e]}),this.canvas=b.main.view,this.minimapCanvas=b.minimap?b.minimap.view:void 0,this.mapSize=v,this.plugins=new Set,x.maxDetectionOffset=x.maxDetectionOffset||100,this.subcontainersConfig=x,this.trackFPSCB=_,this.objectManager=new a,this.cache=L,this.isSupportedTouch=s.environmentDetection.isTouchDevice(),this.currentlySelectedObjects=[],this.layerTypes={staticType:{id:d,layer:M},movableType:{id:f,layer:O},minimapType:{id:h,layer:k}},this.VERSION=w}return _createClass(t,[{key:"init",value:function(){var e=arguments.length<=0||void 0===arguments[0]?[]:arguments[0],t=arguments.length<=1||void 0===arguments[1]?{x:0,y:0}:arguments[1],n=arguments.length<=2||void 0===arguments[2]?null:arguments[2],o=arguments.length<=3||void 0===arguments[3]?{fullsize:!0}:arguments[3],i=[];return o.fullsize&&this.toggleFullsize(),e.length&&(i=this.activatePlugins(e)),t&&Object.assign(O,t),this[g](),n&&this.customTickOn(n),S=i,this.cache&&this.cacheMap(),this.drawOnNextTick(),i||Promise.resolve()}},{key:"whenReady",value:function(){return n.all(S)}},{key:"drawOnNextTick",value:function(){x=!0}},{key:"collectGarbage",value:function(){C.forEach(function(e){return e.textureGC.run()})}},{key:"addUIObject",value:function(e,t,n){var o=this;Array.isArray(t)?t.forEach(function(t){o[m](e,t)}):this[m](e,t,n)}},{key:"removeUIObject",value:function(e,t){switch(e){case d:this.getStaticLayer().deleteUIObjects(t);break;case f:this.getMovableLayer().deleteUIObjects(t)}}},{key:"createSpecialLayer",value:function(){var e=arguments.length<=0||void 0===arguments[0]?"default special layer":arguments[0],t=arguments.length<=1||void 0===arguments[1]?{coord:{x:0,y:0},toLayer:!1}:arguments[1],n=t.coord||{x:0,y:0},o=new r.MapLayer(e,n);return o.specialLayer=!0,t.toLayer&&t.toLayer.addChild(o),o}},{key:"addLayer",value:function(e){var t=void 0;return this.getSubcontainerConfigs()&&e.subcontainers!==!1&&(e.subcontainers=this.getSubcontainerConfigs()),t=new j(e),this.getMovableLayer().addChild(t),t}},{key:"usesSubcontainers",value:function(){return!(!this.getSubcontainerConfigs().width||!this.getSubcontainerConfigs().height)}},{key:"getSubcontainerConfigs",value:function(){return this.subcontainersConfig}},{key:"getViewportArea",value:function(){var e=arguments.length<=0||void 0===arguments[0]?!1:arguments[0],t=arguments.length<=1||void 0===arguments[1]?0:arguments[1],n=e?this.getMovableLayer():this.getStaticLayer(),i=new o.Point(0,0),r=new o.Point(window.innerWidth,window.innerHeight);e&&(r=n.toLocal(r),i=n.toLocal(i));var a={x:i.x,y:i.y},l={x2:r.x,y2:r.y},s={x:(Math.abs(l.x2)-a.x)*t,y:(Math.abs(l.y2)-a.y)*t};return{x:Math.round(a.x-s.x),y:Math.round(a.y-s.y),width:Math.round(Math.abs(Math.abs(l.x2)-a.x)+s.x),height:Math.round(Math.abs(Math.abs(l.y2)-a.y)+s.y)}}},{key:"removeLayer",value:function(e){return O.removeChild(e),e}},{key:"getMapsize",value:function(){return this.mapSize}},{key:"moveMap",value:function(e){var t=e.x,n=void 0===t?0:t,i=e.y,r=void 0===i?0:i,a=arguments.length<=1||void 0===arguments[1]?{}:arguments[1],s=a.absolute,c=void 0===s?!1:s,u={x:Math.round(n/this.getStaticLayer().getZoom()),y:Math.round(r/this.getStaticLayer().getZoom())};c?O.position=new o.Point(n,r):O.move(u),l.publish("mapMoved",u),this.drawOnNextTick()}},{key:"isCacheActivated",value:function(){return this.cache}},{key:"cacheMap",value:function(){e(!0,this.usesSubcontainers())}},{key:"unCacheMap",value:function(){e(!1,this.usesSubcontainers())}},{key:"activatePlugins",value:function(){var e=this,t=arguments.length<=0||void 0===arguments[0]?[]:arguments[0],n=[];return t.forEach(function(t){"object"===("undefined"==typeof t?"undefined":_typeof(t))?e.activatePlugin(t):c.error("problem with initializing a plugin: "+t.name)}),n}},{key:"activatePlugin",value:function(e){try{if(!e||!e.pluginName||!e.init)throw new Error("plugin, plugin.pluginName or plugin.init import is missing!");this.plugins.add(e[e.pluginName]),this.plugins.has(e[e.pluginName])&&e.init(this)}catch(t){c.error('An error initializing plugin. JSON.stringify: "'+JSON.stringify(e)+'" ',t)}}},{key:"setPrototype",value:function(e,t){var n=Object.getPrototypeOf(this);n[e]=t}},{key:"getObjectsUnderArea",value:function(){var e=arguments.length<=0||void 0===arguments[0]?{x:0,y:0,width:0,height:0}:arguments[0],t=arguments.length<=1||void 0===arguments[1]?{}:arguments[1],n=t.filters,i=void 0===n?null:n,r={globalCoords:e,localCoords:this.getMovableLayer().toLocal(new o.Point(e.x,e.y))},a=[];if(r.localCoords.width=e.width/this.getZoom(),r.localCoords.height=e.height/this.getZoom(),this.usesSubcontainers()){var l=this[p](r,{filters:i});a=this[v](r,l)}else{var s=this.getMovableLayer().children.filter(function(e){return!(i&&!i.filter(e).length||e.specialLayer)});a=this[v](r,s)}return i&&(a=i.filter(a)),a}},{key:"getPrimaryLayers",value:function(){var e=arguments.length<=0||void 0===arguments[0]?{}:arguments[0],t=e.filters;return this.getMovableLayer().getPrimaryLayers({filters:t})}},{key:"getAllObjects",value:function(){var e=arguments.length<=0||void 0===arguments[0]?{}:arguments[0],t=e.filters,n=void 0,o=void 0;return n=this.getPrimaryLayers({filters:t}).map(function(e){var n=void 0;if(e.hasSubcontainers()){var i=s.arrays.flatten2Levels(e.getSubcontainers());n=i.map(function(e){return o=e.children.map(function(e){return t?t.filter(e):e}),s.arrays.flatten2Levels(o)})}else n=e.children.map(function(e){return t?t.filter(e):e});return s.arrays.flatten2Levels(n)}),n=s.arrays.flatten2Levels(n)}},{key:"getMapCoordinates",value:function(){return{x:this.getMovableLayer().x,y:this.getMovableLayer().y}}},{key:"getZoomLayer",value:function(){return this.getStaticLayer()}},{key:"setZoom",value:function(e){return this.getZoomLayer().setZoom(e),l.publish("mapZoomed",{previousScale:this.getZoom(),newScale:e}),e}},{key:"getZoom",value:function(){return this.getZoomLayer().getZoom()}},{key:"getRenderer",value:function(e){return"minimap"===e?b.minimap:b.main}},{key:"getStaticLayer",value:function(){return M}},{key:"getMovableLayer",value:function(){return O}},{key:"getMinimapLayer",value:function(){return k}},{key:"removeMinimapLayer",value:function(){k=void 0}},{key:"zoomIn",value:function(){return"notImplementedYet. Activate with plugin"}},{key:"zoomOut",value:function(){return"notImplementedYet. Activate with plugin"}},{key:"toggleFullsize",value:function(){return"notImplementedYet. Activate with plugin"}},{key:"toggleFullScreen",value:function(){return"notImplementedYet. Activate with plugin"}},{key:"initMinimap",value:function(){return"notImplementedYet. Activate with plugin"}},{key:"activateFogOfWar",value:function(){return"notImplementedYet. Activate with plugin"}},{key:"getSymbols",value:function(){return{_addObjectToUIlayer:m}}},{key:v,value:function(e){var t=arguments.length<=1||void 0===arguments[1]?[]:arguments[1],n=arguments.length<=2||void 0===arguments[2]?{}:arguments[2],o=n.type,i=void 0===o?"":o;return this.objectManager.retrieve(e,t,{type:i,size:{width:e.globalCoords.width,height:e.globalCoords.height}})}},{key:y,value:function(e,t){return this.getMovableLayer().children[0].children.filter(function(n){return n[e]===t})}},{key:p,value:function(e){var t=arguments.length<=1||void 0===arguments[1]?{}:arguments[1],n=t.filters,o=this.getPrimaryLayers({filters:n}),i=[],r=void 0;return o.forEach(function(t){r=t.getSubcontainersByCoordinates(e.localCoords),i=i.concat(r)}),i}},{key:g,value:function(){var e=this,t=1e3,n=0,i=(new Date).getTime(),r=void 0,a=void 0;o.ticker.shared.add(function(){x&&(e.trackFPSCB&&(r=(new Date).getTime()),C.forEach(function(e){return e.render(e.getResponsibleLayer())}),e.trackFPSCB&&(a+=Math.round(Math.abs(r-(new Date).getTime()))),x=!1),e.trackFPSCB&&(n++,i+t<(new Date).getTime()&&(e.trackFPSCB({
FPS:n,FPStime:i,renderTime:a,drawCount:b.main.drawCount}),n=0,a=0,i=(new Date).getTime()))})}},{key:m,value:function(e,t,n){switch(e){case d:this.getStaticLayer().addUIObject(t,n);break;case f:this.getMovableLayer().addUIObject(t,n)}}}]),t}();window.flatworld.Flatworld=L}();var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol?"symbol":typeof e};!function(){function e(e,n){var l=arguments.length<=2||void 0===arguments[2]?{}:arguments[2],s=l.trackFPSCB,c=void 0===s?!1:s,u=l.isHiddenByDefault,d=void 0===u?!0:u,f=l.cache,h=void 0===f?!1:f,w=l.minimapCanvas,v=l.scaleMode,y=void 0===v?t.SCALE_MODES.DEFAULT:v;r.debug("============== Hexagonal Map factory started =============");var p=i.environmentDetection.getPixelRatio(),g="string"==typeof n.map?JSON.parse(n.map):n.map,m="string"==typeof n.type?JSON.parse(n.type):n.type,b="string"==typeof n.game?JSON.parse(n.game):n.game,x=i.resize.getWindowSize(),S={ObjectTerrain:a.objects.ObjectHexaTerrain,ObjectUnit:a.objects.ObjectHexaUnit},C={mapSize:b.mapSize,bounds:{x:0,y:0,width:x.x,height:x.y},rendererOptions:{resolution:p,autoResize:!0,transparent:!0,antialias:!1},subcontainers:{width:500,height:500,maxDetectionOffset:100,isHiddenByDefault:d},trackFPSCB:c,cache:h,defaultScaleMode:y,minimapCanvas:w},M=new o(e,C);return t.SCALE_MODES.DEFAULT=1,g.layers.forEach(function(e){if("object"!==("undefined"==typeof e?"undefined":_typeof(e)))throw r.error("Problem in hexaFactory, with layerData:"+JSON.stringify(e)),new Error("Problem in hexaFactory, with layerData:",e);var n,o=M.getRenderer(),i={name:e.name,coord:e.coord,drawOutsideViewport:{x:o.width,y:o.height},selectable:"unitLayer"===e.name};try{n=M.addLayer(i),e.objectGroups.forEach(function(e){var o=e.typeImageData;return o?void e.objects.forEach(function(i){var a,l,s,c;try{if(a=m[o][i.objType],!a)throw r.error("Bad mapData for type:",o,i.objType,i.name),new Error("Bad mapData for type:",o,i.objType,i.name);s=t.Texture.fromFrame(a.image),l={data:{typeData:a,activeData:i.data},radius:b.hexagonRadius,minimapColor:a.minimapColor,minimapSize:a.minimapSize},c=new S[e.type](s,i.coord,l),n.addChild(c)}catch(u){r.error(u)}}):void r.error("Error with spritesheetType-data")})}catch(a){r.error("Problem:"+JSON.stringify(e.type)+" ---- "+JSON.stringify(a.stack))}}),M.moveMap(b.startPoint),M}var t=window.flatworld_libraries.PIXI,n=window.flatworld,o=n.Flatworld,i=n.utils,r=n.log,a=window.flatworld.extensions.hexagons;window.flatworld.factories.hexaFactory=e}();