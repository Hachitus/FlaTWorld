<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>src\components\map\extensions\mapMovement\mapMovement.js - FlaTWorld</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="icon" href="../assets/favicon.ico">
    <script src="http://yui.yahooapis.com/combo?3.9.1/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
                <h1><img src="../assets/css/logo.png" title="FlaTWorld" width="117" height="52"></h1>
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: 0.1.1</em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
                    <h2 class="off-left">APIs</h2>
                    <div id="api-tabview" class="tabview">
                        <ul class="tabs">
                            <li><a href="#api-classes">Classes</a></li>
                            <li><a href="#api-modules">Modules</a></li>
                        </ul>
                
                        <div id="api-tabview-filter">
                            <input type="search" id="api-filter" placeholder="Type to filter APIs">
                        </div>
                
                        <div id="api-tabview-panel">
                            <ul id="api-classes" class="apis classes">
                                <li><a href="../classes/flatworld.eventListeners.html">flatworld.eventListeners</a></li>
                                <li><a href="../classes/flatworld.extensions.baseEventlisteners.html">flatworld.extensions.baseEventlisteners</a></li>
                                <li><a href="../classes/flatworld.extensions.hexagons.ObjectHexaTerrain.html">flatworld.extensions.hexagons.ObjectHexaTerrain</a></li>
                                <li><a href="../classes/flatworld.extensions.hexagons.ObjectHexaUnit.html">flatworld.extensions.hexagons.ObjectHexaUnit</a></li>
                                <li><a href="../classes/flatworld.extensions.hexagons.selectHexagonObject.html">flatworld.extensions.hexagons.selectHexagonObject</a></li>
                                <li><a href="../classes/flatworld.extensions.hexagons.setupHexagonClick.html">flatworld.extensions.hexagons.setupHexagonClick</a></li>
                                <li><a href="../classes/flatworld.extensions.hexagons.utils.html">flatworld.extensions.hexagons.utils</a></li>
                                <li><a href="../classes/flatworld.extensions.mapDrag.html">flatworld.extensions.mapDrag</a></li>
                                <li><a href="../classes/flatworld.extensions.mapMovement.html">flatworld.extensions.mapMovement</a></li>
                                <li><a href="../classes/flatworld.extensions.mapZoom.html">flatworld.extensions.mapZoom</a></li>
                                <li><a href="../classes/flatworld.Flatworld.html">flatworld.Flatworld</a></li>
                                <li><a href="../classes/flatworld.generalUtils.arrays.html">flatworld.generalUtils.arrays</a></li>
                                <li><a href="../classes/flatworld.generalUtils.environmentDetections.html">flatworld.generalUtils.environmentDetections</a></li>
                                <li><a href="../classes/flatworld.generalUtils.polyfills.html">flatworld.generalUtils.polyfills</a></li>
                                <li><a href="../classes/flatworld.log.html">flatworld.log</a></li>
                                <li><a href="../classes/flatworld.mapApi.html">flatworld.mapApi</a></li>
                                <li><a href="../classes/flatworld.MapDataManipulator.html">flatworld.MapDataManipulator</a></li>
                                <li><a href="../classes/flatworld.mapEvents.html">flatworld.mapEvents</a></li>
                                <li><a href="../classes/flatworld.maplayers.MapLayer.html">flatworld.maplayers.MapLayer</a></li>
                                <li><a href="../classes/flatworld.maplayers.MapLayerParent.html">flatworld.maplayers.MapLayerParent</a></li>
                                <li><a href="../classes/flatworld.maplayers.MapSubcontainer.html">flatworld.maplayers.MapSubcontainer</a></li>
                                <li><a href="../classes/flatworld.mapStates.html">flatworld.mapStates</a></li>
                                <li><a href="../classes/flatworld.ObjectManager.html">flatworld.ObjectManager</a></li>
                                <li><a href="../classes/flatworld.objects.ObjectSprite.html">flatworld.objects.ObjectSprite</a></li>
                                <li><a href="../classes/flatworld.objects.ObjectSpriteTerrain.html">flatworld.objects.ObjectSpriteTerrain</a></li>
                                <li><a href="../classes/flatworld.objects.ObjectSpriteUnit.html">flatworld.objects.ObjectSpriteUnit</a></li>
                                <li><a href="../classes/flatworld.Preload.html">flatworld.Preload</a></li>
                                <li><a href="../classes/flatworld.UI.html">flatworld.UI</a></li>
                                <li><a href="../classes/flatworld.UIs.default.html">flatworld.UIs.default</a></li>
                                <li><a href="../classes/flatworld.utils.dataManipulation.html">flatworld.utils.dataManipulation</a></li>
                                <li><a href="../classes/flatworld.utils.effects.html">flatworld.utils.effects</a></li>
                                <li><a href="../classes/flatworld.utils.environment.html">flatworld.utils.environment</a></li>
                                <li><a href="../classes/flatworld.utils.general.html">flatworld.utils.general</a></li>
                                <li><a href="../classes/flatworld.utils.mouse.html">flatworld.utils.mouse</a></li>
                                <li><a href="../classes/flatworld.utils.Quadtree.html">flatworld.utils.Quadtree</a></li>
                                <li><a href="../classes/flatworld.utils.resize.html">flatworld.utils.resize</a></li>
                            </ul>
                
                
                            <ul id="api-modules" class="apis modules">
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
                    Show:
                    <label for="api-show-inherited">
                        <input type="checkbox" id="api-show-inherited" checked>
                        Inherited
                    </label>
            
                    <label for="api-show-protected">
                        <input type="checkbox" id="api-show-protected">
                        Protected
                    </label>
            
                    <label for="api-show-private">
                        <input type="checkbox" id="api-show-private">
                        Private
                    </label>
                    <label for="api-show-deprecated">
                        <input type="checkbox" id="api-show-deprecated">
                        Deprecated
                    </label>
            
                </div>
            
            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
<h1 class="file-heading">File: src\components\map\extensions\mapMovement\mapMovement.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">
(function () {
  &#x27;use strict&#x27;;

  /*-----------------------
  --------- IMPORT --------
  -----------------------*/
  var mapEvents = window.flatworld.mapEvents;
  var arrays = window.flatworld.generalUtils.arrays;
  var Q = window.flatworld_libraries.Q;

  /*-----------------------
  ------- VARIABLES -------
  -----------------------*/
  //var viewportWorker = new Worker(&quot;/components/map/extensions/mapMovement/mapMovementWorker.js&quot;);

  /*-----------------------
  ---------- API ----------
  -----------------------*/
  /* For debugging. This will show up if the plugin fails to load in Map.js */
  window.flatworld.extensions.mapMovement = setupMapMovement();

  /*-----------------------
  -------- PUBLIC ---------
  -----------------------*/
  /** This module manages visibility of the objects, based on are they visible to the player (on the canvas / webgl) or outside of it. This makes the map a lot faster and reliable resource-wise and lags otherwise. Requires subcontainers atm.
   *
   * @namespace flatworld.extensions
   * @class mapMovement
   **/
  function setupMapMovement () {
    const VIEWPORT_OFFSET = 0.2;
    const CHECK_INTERVAL = 20;
    var queue = {};
    var changedCoordinates = {
      width: 0,
      height: 0
    };
    var debug = false;
    var map, currentScale;

    return {
      init,
      pluginName: &quot;mapMovement&quot;,
      addAll,
      check,
      startEventListeners,
      _testObject: {
        isObjectOutsideViewport,
        viewportWorkerOnMessage,
        getViewportWithOffset,
        testRectangleIntersect,
        _setMap
      }
    };
    /**
     * Ínitialize as a plugin
     *
     * @method init
     * @param  {Map} map     Instance of Map
     */
    function init(givenMap) {
      map = givenMap;
      currentScale = map.getZoom();

      addAll();
      startEventListeners();
      map.drawOnNextTick();

      if (debug) {
        /**
         * For debugging. Shows the amount of currectly active and inactive subcontainers. Console.logs the data.
         * Also extends window object.
         *
         * @method window.FlaTWorld_mapMovement_subCheck
         * @static
         */
        window.FlaTWorld_mapMovement_subCheck = function() {
          map.getPrimaryLayers().forEach( layer =&gt; {
            var subcontainers = arrays.flatten2Levels(layer.getSubcontainers());
            var visibleContainers, invisibleContainers;

            visibleContainers = subcontainers.filter(subcontainer =&gt; {
              return subcontainer.visible;
            });
            invisibleContainers = subcontainers.filter(subcontainer =&gt; {
              return !subcontainer.visible;
            });

            let containerCoords = visibleContainers.reduce((all, cont2) =&gt; { all + cont2.x + &quot;&quot;; });
            window.flatworld.log.debug(
              &quot;visible subcontainers: &quot; + visibleContainers.length + &quot;, &quot; + containerCoords + &quot;\n\ninvisible: &quot; +
              invisibleContainers.length);
          });
        };
        /**
         * For debugging. Sets all primaryLayers subcontainers on the map as visible = true.
         *
         * @method window.FlaTWorld_mapMovement_deactivate
         * @static
         */
        window.FlaTWorld_mapMovement_deactivate = function() {
          map.getPrimaryLayers().forEach( layer =&gt; {
            var subcontainers = arrays.flatten2Levels(layer.getSubcontainers());
            var visibleContainers;

            visibleContainers = subcontainers.forEach(subcontainer =&gt; {
              subcontainer.visible = false;
            });
          });
        };
      }
    }
    /**
     * Ínitialize as a plugin
     *
     * @method addAll
     * @param  {Map} map     Instance of Map
     */
    function addAll() {
      var viewportArea;

      viewportArea = map.getViewportArea(true);

      map.getPrimaryLayers().forEach( layer =&gt; {
        var subcontainers = arrays.flatten2Levels(layer.getSubcontainers());

        subcontainers.forEach(subcontainer =&gt; {
          subcontainer.visible = isObjectOutsideViewport(subcontainer, viewportArea) ? false : true;
        });
      });
    }
    /**
     * This one checks the that the objects that should currently be visible in the viewport area are visible and outside
     * of the viewport objects are set .visible = false. This affect performance a lot. Basically when the map moves, we
     * set a check in the future based on the given intervalCheck milliseconds. And immediately after it we check if there
     * is another map movement. If there is we set another timeout. This works better with timeouts.
     *
     * This uses webWorkers. They seemed to speed up the check, when timing with performance.now.
     *
     * @method check
     * @param  {Map} map        The current Map instance
     * @return {Boolean}        True
     */
    function check() {
      if (queue.processing) {
        return false;
      }
      queue.processing = true;

      let viewportFn = setupHandleViewportArea();
      window.setTimeout(viewportFn, CHECK_INTERVAL);

      function setupHandleViewportArea() {
        var viewportArea;

        viewportArea = map.getViewportArea(true);

        viewportWorkerOnMessage(viewportArea, map.getPrimaryLayers());
      }

      return;
    }
    /**
     * @method startEventListeners
     * @param  {Map} map     Instance of Map
     */
    function startEventListeners() {
      mapEvents.subscribe(&quot;mapMoved&quot;, moveCb);
      mapEvents.subscribe(&quot;mapResized&quot;, resizeCb);
      /* We change the scale factor ONLY if the map is zoomed. We reserve resources */
      mapEvents.subscribe(&quot;mapZoomed&quot;, zoomCb);

      function moveCb(type) {
        var movedCoordinates = type.customData[0];

        changedCoordinates.width += movedCoordinates.x;
        changedCoordinates.height += movedCoordinates.y;
        check();
      }
      function resizeCb() {
        check();
      }
      function zoomCb(ev) {
        currentScale = ev.customData[0].newScale;
        check();
      }
    }
    /*-----------------------
    -------- PRIVATE --------
    -----------------------*/
    /**
     * See if the given object or subcontainer is outside the given viewportarea. We check intersecting rectangles
     *
     * @private
     * @static
     * @method isObjectOutsideViewport
     * @param  {Object} object                  Object / layer we are testing
     * @param  {Object} viewportArea            ViewportArea location and size
     * @param  {Integer} viewportArea.x         X coordinate
     * @param  {Integer} viewportArea.y         Y coordinate
     * @param  {Integer} viewportArea.width     Viewports width (in pixels)
     * @param  {Integer} viewportArea.height    Viewports height (in pixels)
     * @param  {Boolean} hasParent              default = true
     * @return {Boolean}
     */
    function isObjectOutsideViewport(object, viewportArea) {
      var isOutside, globalArea;

      globalArea = object.getSubcontainerArea({ toGlobal: false });

      isOutside = !testRectangleIntersect(globalArea, viewportArea);

      return isOutside;
    }
    /**
     * Originally webworker onmessage function, but webworker got refactored away.
     *
     * @todo rename and generally refactor
     * @method viewportWorkerOnMessage
     * @param  {Object} scaledViewport    Viewportarea that has been scaled.
     * @param  {Array} primaryLayers      The primarylayers that we handle
     */
    function viewportWorkerOnMessage(scaledViewport, primaryLayers) {
      var containersUnderChangedArea = [];
      var promises, largerViewportAreaWithOffset;

      largerViewportAreaWithOffset = getViewportWithOffset(scaledViewport);

      /* RESET */
      changedCoordinates.width = 0;
      changedCoordinates.height = 0;

      primaryLayers = arrays.chunkArray(primaryLayers, 2);
      promises = primaryLayers.map((theseLayers) =&gt; {
        var promise = window.Q.defer();

        window.setTimeout(function () {
          var foundSubcontainers;

          foundSubcontainers = theseLayers.map((layer) =&gt; {
            return layer.getSubcontainersByCoordinates(largerViewportAreaWithOffset);
          });
          containersUnderChangedArea = containersUnderChangedArea.concat(foundSubcontainers);

          promise.resolve(true);
        });

        return promise.promise;
      });

      promises = window.Q.all(promises).then(() =&gt; {
        var subcontainers, promises;

        containersUnderChangedArea = arrays.flatten2Levels(containersUnderChangedArea);

        subcontainers = arrays.chunkArray(containersUnderChangedArea, 40);

        promises = subcontainers.map((thesesContainers) =&gt; {
          var promise = window.Q.defer();

          window.setTimeout(function () {
            thesesContainers.forEach((thisContainer) =&gt; {
              thisContainer.visible = isObjectOutsideViewport(thisContainer, scaledViewport) ? false : true;
            });

            promise.resolve(true);
          });

          return promise.promise;
        });

        return promises;
      });
      window.Q.all(promises).then(() =&gt; {
        queue.processing = false;

        map.drawOnNextTick();
      }).then(null, (err) =&gt; {
        window.flatworld.log.debug(err);
      });
    }
    /**
     * forms the total viewport parameters based on the given ones.
     *
     * @private
     * @static
     * @method getViewportWithOffset
     * @param  {AreaSize} viewportArea          Given viewport area
     * @return {totalViewportArea}              The total viewportArea
     */
    function getViewportWithOffset(viewportArea, options = { scale: 1 }) {
      var offsetSize = calculateOffset(viewportArea, options);

      return {
        x: Math.round( viewportArea.x - offsetSize ),
        y: Math.round( viewportArea.y - offsetSize ),
        width: Math.round( viewportArea.width + offsetSize * 2 ),
        height: Math.round( viewportArea.height + offsetSize * 2 )
      };
    }
    /**
     * @private
     * @static
     * @method testRectangleIntersect
     */
    function testRectangleIntersect(a, b) {
      return (a.x &lt;= b.x + b.width &amp;&amp;
              b.x &lt;= a.x + a.width &amp;&amp;
              a.y &lt;= b.y + b.height &amp;&amp;
              b.y &lt;= a.y + a.height);
    }
    /**
     * @private
     * @static
     * @method calculateOffset
     */
    function calculateOffset(viewportArea, options = { scale: 1 }) {
      return Math.abs( viewportArea.width / options.scale * VIEWPORT_OFFSET  );
    }
    /**
     * @private
     * @static
     * @method _setMap
     */
    function _setMap(givenMap) {
      map = givenMap;
    }
  }
})();
    </pre>
</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
